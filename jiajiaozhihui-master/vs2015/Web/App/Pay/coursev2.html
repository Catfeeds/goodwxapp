<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link href="./Content/Css/weui.min.css" rel="stylesheet" />
    <link href="./Content/Css/bootstrap.min.css" rel="stylesheet" />
    <title>购买课程</title>
    <style>
        body, html {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="container" class="container" style="padding-top:5px; height:100%;">
        <div class="row" style="height:100%;">
            <div class="weui_tab">
                <div class="weui_tab_bd">
                    <div class=" img-responsive text-center">
                        <img id="imgSrc" style="width:100%;" src="" />
                    </div>
                    <section style="padding:0 15px;">
                        <h3 id="title"></h3>
                        <div>
                            <div style="padding:10px;">
                                <div style="padding-top:10px;" id="courseContent"></div>
                            </div>
                        </div>
                    </section>
                </div>
                <div class="weui_tabbar">
                    <a href="javascript:;" class="weui_tabbar_item text-center" style="padding-top:0px;height:45px;line-height:45px;">
                        金额：<span class="text-info " id="price"></span>元
                    </a>
                    <a href="javascript:;" class="weui_tabbar_item" style="padding-top:0px;">
                        <span id="btnPay" class="btn btn-danger btn-lg" style="width:100%; border-radius:0;">微信支付</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="./Content/ThirdJs/jquery-1.10.2.min.js"></script>

    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="Content/Js/wxhelper.js"></script>
    <script>
        $.wx.configRegist().then(function (res) {
            
            var payParam = {
                courseId: res.info.objectId,
                openId: res.info.openId,
                courseType: res.info.appId,
                price: '',
                tradeno: '',
                title:''
            };
            console.log(res);
            $.wx.showLoadding("正在加载数据...");
            $.wx.httpPost("/app/project/course/controller/PayOrderController.ashx?method=state", { oid: payParam.openId, cid: payParam.courseId, ctype: payParam.courseType }).then(function (res) {
                courseInfo(res.courseInfo);
                payState(res.completedOrderInfo);
                payParam.price = res.courseInfo.price;
                payParam.title = res.courseInfo.courseName;
                wxShare();
                $.wx.hideLoadding();
            });
            

            function courseInfo(info) {
                $("#imgSrc").attr("src", info.maxImgUrl)
                $("#price").text(info.price);
                $("#title").text(info.courseName);
                $("#courseContent").html(info.details);
            };
            function payState(info) {
                if (info) {
                    $("#btnPay").text("进入父母特训营");
                    $("#btnPay").click(function () {
                        window.location.href = "http://courses.jiajiaozhihui.cn/link/parents.html";
                    });
                }
            }
            $("#btnPay").on('click', function () {
                $.wx.showLoadding("正在发起支付...");
                $.wx.httpPost("/app/project/course/controller/PayOrderController.ashx?method=add", payParam,"TEXT").then(function (res) {
                    if (res != "") {
                        unifiedOrder(res)
                    }
                    $.wx.hideLoadding();
                })

                function unifiedOrder(tradeno) {
                    var info = new Object();
                    info.body = payParam.title;
                    info.outTradeNo = tradeno;
                    info.openid = payParam.openId;
                    info.attach = payParam.courseType;
                    info.notifyPage = "course.ashx";
                    
                    $.wx.httpPost("/app/project/course/controller/WxPayController.ashx?method=pay", info).then(function (res) {
                        wx.chooseWXPay({
                            appId: res.appId,
                            timestamp: res.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                            nonceStr: res.nonceStr, // 支付签名随机串，不长于 32 位
                            package: res.package, // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                            signType: "MD5", // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                            paySign: res.paySign, // 支付签名
                            success: function (res) {
                                window.location.href = 'http://weixin.jiajiaozhihui.cn/app/appstart/CourseV2/Baseinfo.ashx?redirect_url=http://courses.jiajiaozhihui.cn/app/default.html?r=a=app001|h=card';
                            }
                        });
                    });
                }
            });
            function wxShare() {
                wx.ready(function () {
                    var _shareData = {
                        title: '智慧父母特训营订购', // 分享标题
                        desc: '每一次学习都应有结果',
                        groupTitle: '智慧父母特训营订购',
                        link: 'http://161s5g6007.51mypc.cn/app/appstart/share/baseinfo.ashx?redirect_url=http://161s5g6007.51mypc.cn/app/pay/coursev2.html?r=a=' + payParam.courseType + '|id=' + payParam.courseId, // 分享链接
                    };
                    wx.onMenuShareTimeline(_shareData);
                    wx.onMenuShareAppMessage(_shareData);
                });
                wx.error(function (res) {
                    alert(res);
                });
            }
        })
    </script>
</body>
</html>