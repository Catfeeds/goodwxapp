<?php
namespace app\index\controller;
use app\index\model\Advertisement as AdvertisementModel;
use app\index\model\CarModel ;
use app\index\model\User as UserModel;
use app\index\model\Order ;
use app\index\model\OrderH5 ;
class Advertisement extends Base{

	public function getAdvertisement()
	{
		$advertisement = new AdvertisementModel();
		$advertisementinfo = $advertisement->select();
		$response = array();
		// $openid = input('param.openid');
		// $user = new UserModel;
		// $userinfo = $user->where('openid',$openid)->find();
		// $response['telephone'] = $userinfo['telephone'];
		if(empty($this->userid)){
			do_log('getAdvertisement','','获取openid出错',0);
			$response['error'] = 1;
			$response['message'] = '出错了,请稍后再试';
			exit(json_encode($response));
		}
		$user_id = $this->userid;
		$telephone = $this->telephone;
		$order = new Order();
		$car = new CarModel();
		$orderinfo = $order->where('user_id',$user_id)->where('status', '>',0)->where('status', '<', 5)->whereTime('createtime','-6 month')->find();

		if(!empty($orderinfo)){
			foreach ($advertisementinfo as $advertisementinfokey => $advertisementinfoval) {
				if($orderinfo['car_model_id'] == $advertisementinfoval['car_model_id']){
					if($orderinfo['status'] == 1){
						$advertisementinfo[$advertisementinfokey]['statusmessage'] = "已预约 点击查看";
						$advertisementinfo[$advertisementinfokey]['status'] = 1;
					}
					if($orderinfo['status'] == 2 || $orderinfo['status'] == 3 || $orderinfo['status'] == 4 || $orderinfo['status'] == 5){
						$advertisementinfo[$advertisementinfokey]['statusmessage'] = "试驾完成";
						$advertisementinfo[$advertisementinfokey]['status'] = 2;
					}
					$advertisementinfo[$advertisementinfokey]['orderid'] = $orderinfo['id'];
					$advertisementinfo[$advertisementinfokey]['orderh5id'] = "";
				}else{

					$advertisementinfo[$advertisementinfokey]['status'] = -1;
					$advertisementinfo[$advertisementinfokey]['statusmessage'] = "半年内不能重复试驾";
				}

			}
		}
		$orderh5info = "";
		if(!empty($telephone)){
			$orderh5 = new OrderH5();
			$orderh5info = $orderh5->where(['mobile'=>$telephone])->whereTime('create_time','-6 month')->find();
			if(!empty($orderh5info)){
				foreach ($advertisementinfo as $advertisementinfokey => $advertisementinfoval) {
					$carinfo = array();
					$carinfo = $car->get($advertisementinfoval['car_model_id']);//车型详情
					if($orderh5info['model_code'] == $carinfo['model_code']){
						if($orderh5info['status'] == 0){
							$advertisementinfo[$advertisementinfokey]['statusmessage'] = "已预约 点击查看";
							$advertisementinfo[$advertisementinfokey]['status'] = 1;
						}
						if($orderh5info['status'] == 1){
							$advertisementinfo[$advertisementinfokey]['statusmessage'] = "试驾完成";
							$advertisementinfo[$advertisementinfokey]['status'] = 2;
						}
						$advertisementinfo[$advertisementinfokey]['orderid'] = '';
						$advertisementinfo[$advertisementinfokey]['orderh5id'] = $orderh5info['id'];
					}else{
						$advertisementinfo[$advertisementinfokey]['status'] = -1;
						$advertisementinfo[$advertisementinfokey]['statusmessage'] = "半年内不能重复试驾";
					}
				}
			}
		}
		if(empty($orderinfo) && empty($orderh5info)){
			foreach ($advertisementinfo as $advertisementinfokey => $advertisementinfoval) {
				$advertisementinfo[$advertisementinfokey]['status'] = 0;
				$advertisementinfo[$advertisementinfokey]['statusmessage'] = "立即参与";
			}
		}
		$response['advertisementinfo'] = $advertisementinfo;
		exit(json_encode($response));
	}
}