var app = getApp()
Page({
  data: {
    imagesUrl:app.data.picUrl,
    city: "位置",
    i: 0,
    j: 0,
    // 省市信息
    arrayPro: [],
    provinceInfo:[],
    arrayCity: [],
    cityInfo: [],
    show: true,
    photoURL:null,
    // 登录
    showLogin:false,
    // 手机号
    mobile:"",
    // 验证码
    verifycode: "1",
    verifycode2: "2",
    // 首页广告位
    advertisementinfo: {},
    // openid
    openid:'',
  },
  // 点击头像
  updatePhoto: function () {
    this.setData({
      showLogin: true
    })
  },
  close2: function () {
    this.setData({
      showLogin: false
    })
  },
  switchCity: function () {
    this.setData({
      show: (!this.data.show)
    })
  },
  bindProChange: function (e) {
    this.setData({
      i: e.detail.value
    })
    getCity(this, e.detail.value, this.data.provinceInfo)
    
  },
  bindCityChange: function (e) {
    this.setData({
      j: e.detail.value,
      city: this.data.arrayCity[e.detail.value],
      show: (!this.data.show)
    })
    wx.setStorage({
      key: 'city',
      data: this.data.arrayCity[e.detail.value],
    })
  },
  tiaoDetail: function (event) {
    var that=this
    var p =event.currentTarget.dataset.carid
    wx.navigateTo({ url: '../detail/detail?carid=' + p+'&city='+that.data.city })  
  },
  // 加载完就调用///////////////////////////////////
  onLoad:function(){
    var that=this
    // 自动定位
    wx.getStorage({
      key: 'city',
      success: function(res) {
        that.setData({
          city: res.data
        })
      },fail:function(){
        wx.getLocation({
          type: 'gcj02', //返回可以用于wx.openLocation的经纬度
          success: function (res) {
            var longitude = res.latitude
            var latitude = res.longitude
            wx.request({
              url: app.data.requestUrl + 'leilingapplet/public/index.php/index/User/getlocation/',
              data: {
                "longitude": longitude,
                "latitude": latitude
              },
              success: function (data) {
                var data = data.data.result.ad_info
                wx.setStorage({
                  key: 'city',
                  data: data.city,
                })
                that.setData({
                  city: data.city
                })
              },fail:function(){
                getUserLocation(that)
              }
            })
          },fail:function(){
            getUserLocation(that)
          }
        })
      }
    }) 
    // huo获取市
     wx.request({
       url: app.data.requestUrl+'/leilingapplet/public/index.php/index/User/getProvince',
       success:function(data){
         var data=data.data
         var province=[];
         for(var i=0;i<data.length;i++){
           province.push(data[i].province_name)
         }
         that.setData({
           arrayPro:province,
           provinceInfo:data
         })
         getCity(that, 0, data)
       }
     })
    // 获取openid
    wx.getStorage({
      key: 'openid',
      success:function(res){
        that.setData({
          openid: res.data
        })
        getAdList(res.data, that)
      },
      fail:function(){
        getAdList('', that)
        wx.login({
          success: function (res1) {
            if (res1.code) {
              //发起网络请求
              wx.request({
                url: app.data.requestUrl + 'leilingapplet/public/index.php/index/User/getUserOpenid/',
                data: {
                  code: res1.code
                },
                method: "POST",
                success: function (res) {
                  var openid=res.data.openid;
                    wx.request({
                      url: app.data.requestUrl+'leilingapplet/public/index.php/index/User/firstLogin',
                      data:{"openid":openid},
                      success:function(res2){
                        var error = res2.data.error
                         if(error==0){
                           wx.setStorage({
                             key: 'openid',
                             data: openid
                           })
                           that.setData({
                             openid:openid
                           })
                         }else{
                           wx.showToast({
                             title: '出错了,不好意思',
                           })
                         }

                      },
                    })
                  
                }
              })
            }
          }, fail: function () {
            wx.showToast({
              title: '获取用户登录状态失败',
            })
          }
        })
      }
    })
   
    //显示头像
    app.getUserInfo(function () {
      //更新数据
      that.setData({
        photoURL: app.globalData.userInfo
      })
    })
     
    // 
  },
  // 测试手机号
  testMobile:function(e){
    this.setData({
      mobile: e.detail.value
    })
  },
  // 测试验证码
  testVerifycode: function (e) {
    this.setData({
      verifycode: e.detail.value
    })
  },
  // 获取验证码
  getCode:function(){
    var _this=this;
    if (!(/^1[34578]\d{9}$/.test(this.data.mobile))) {
      wx.showToast({
        title: '手机号格式不正确',
        image: '',
        duration: 2000
      })
    }else {
      wx.request({
        url: app.data.requestUrl + 'leilingapplet/public/index.php/index/User/CreateVerificationCode/',
        method: "GET",
        success: function (d) {
          var data = d.data.verifycode
          console.log(data)
          _this.setData({
            verifycode2:data
          })
        }
      })
    }
  },
  // 账号登录
  user_login:function(){
    var _this=this
    if (this.data.verifycode != this.data.verifycode2){
      wx.showToast({
        title: '验证码不正确',
        image: '',
        duration: 2000
      })
    }else{
      wx.request({
        url: app.data.requestUrl+'leilingapplet/public/index.php/index/User/userLogin',
        method: "POST",
        data:{
          'telephone': _this.data.mobile,
          'city': _this.data.city,
          'verificationcode': _this.data.verifycode,
          'openid': _this.data.openid
        },
        success: function (d) {
          console.log(d)
          var data=d.data
         if(data.error==0){
            wx.showToast({
              title: '登录成功',
              image: '',
              duration: 2000
            })
            _this.setData({
              showLogin: false,
            })
          }else{
            wx.showToast({
              title: '登录失败,请重试',
              image: '',
              duration: 2000
            })
          }
        }
      })
    }
  }

})

// 广告列表第
function getAdList(data,that) {
  wx.request({
    url: app.data.requestUrl + 'leilingapplet/public/index.php/Index/Advertisement/getAdvertisement/',
    method: "POST",
    data: { "openid": data },
    success: function (d) {
      var da = d.data.advertisementinfo
      that.setData({
        advertisementinfo: da
      })
    }
  })
}
// 获取市
function getCity(that,i,data){
  wx.request({
    url: app.data.requestUrl + 'leilingapplet/public/index.php/index/User/getCity',
    method: "POST",
    data: { "provincecode":data[i].province_code},
    success: function (res) {
      var data=res.data
      var arr=[]
      for(var j=0;j<data.length;j++){
        arr.push(data[j].city_name)
      }
      that.setData({
        arrayCity: arr
      })
    }
  })
}

// 获取不授权时用户省市
function getUserLocation(that){
   wx.request({
     url: app.data.requestUrl+'/leilingapplet/public/index.php/index/User/getLocationInfo',
     method:"GET",
     success:function(res){
        that.setData({
          city:res.data.data.region
        })
        wx.setStorage({
          key: 'city',
          data: res.data.data.region
        })
     }
   })
}




