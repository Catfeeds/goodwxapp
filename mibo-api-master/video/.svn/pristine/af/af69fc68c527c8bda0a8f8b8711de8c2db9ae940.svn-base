<?php
class Domain_Expense extends Domain_Common {
    public function __construct() {
        parent::__construct();
    }

    //充值记录
    public function rechargeLog() {
        $data = array();
        if($this->req['mold'] == 1) {
            $data = $this->getRechargeLog();
        }

        if($this->req['mold'] == 2) {
            $data = $this->getExpenseLog();
        }
        return $data;

    }

    public function getRechargeLog() {
        $page_no = isset($this->req['page_no']) ? $this->req['page_no'] : 1;
        $page_size = isset($this->req['page_size']) ? $this->req['page_size'] : 20;
        $offset = ($page_no - 1) * $page_size;
        $limit = $page_size;
        $logs = DI()->notorm->recharge_log->where('user_id = ?', $this->req['user_id'])
            ->where('is_update_diamond = 1')->order('id DESC')->limit($offset, $limit)->fetchAll();
        $model_recharge_item = new Model_RechargeItem();
        $model_gift_package = new Model_GiftPackage();
        $return_data = array();
        if(!empty($logs)) {
            foreach($logs as $log_id => $log) {
                if($log['operation_id'] == 1) {
                    $item = $model_recharge_item->getItemById($log['operation_value']);
                    $return_data[$log_id]['type'] = 1;
                    $return_data[$log_id]['log'] = '充值' . $item['diamond_num'] . '米钻';
                    $return_data[$log_id]['create_time'] = $log['create_time'];
                }
                if($log['operation_id'] == 2) {
                    $package = $model_gift_package->getPackageBySortId($log['operation_value']);
                    $return_data[$log_id]['type'] = 2;
                    $return_data[$log_id]['log'] = $package['name'];
                    $return_data[$log_id]['create_time'] = $log['create_time'];
                }
            }
        }

        return $return_data;
    }

    public function getExpenseLog() {
        $page_no = isset($this->req['page_no']) ? $this->req['page_no'] : 1;
        $page_size = isset($this->req['page_size']) ? $this->req['page_size'] : 20;
        $offset = ($page_no - 1) * $page_size;
        $limit = $page_size;
        $logs = DI()->notorm->user_deal_log->where('user_id = ?', $this->req['user_id'])
               ->order('id DESC')->limit($offset, $limit)->fetchAll();
        $return_data = array();
        if(!empty($logs)) {
            foreach($logs as $key => $value) {
                if($value['mid'] == MOUDEL_LIVE_TICKET) {
                    $return_data[$key]['log'] = '购买门票' . $value['deal_num'] . '米钻';
                }
                if($value['mid'] == MOUDEL_LIVE_BARRAGE) {
                    $return_data[$key]['log'] = '发送弹幕' . $value['deal_num'] . '米钻';
                }
                if($value['mid'] == MOUDEL_LIVE_GIFT) {
                    $return_data[$key]['log'] = '直播间送礼物' . $value['deal_num'] . ($value['deal_type'] == 1?'米钻':"米币");
                }
                if($value['mid'] == MOUDEL_MESSAGE_GIFT) {
                    $return_data[$key]['log'] = '私信送礼物' . $value['deal_num'] . '米钻';
                }
                if($value['mid'] == MOUDEL_USER_DIAMOND_EXCHANGE_COIN) {
                    $return_data[$key]['log'] = '钻石兑换米币' . $value['deal_num'] . '米钻';
                }
                $return_data[$key]['create_time'] = $value['create_time'];
            }
        }

        return $return_data;
    }




}