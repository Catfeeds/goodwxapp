<?php

/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2016/8/16
 * Time: 18:35
 */
class Domain_Home {

    private $req;
    private $liveModel;

    public function __construct() {
        $this->req = DI()->request->getAll();
        $this->liveModel = new Model_LiveList();
    }

    private function getMoudelSet() {

        $moudels = DI()->redis->get_time("mb_moudel_set");

        if (empty($moudels)) {
            $tools = new Model_Tools();
            $moudel_list = $tools->getMoudelList();
            if (!empty($moudel_list)) {
                DI()->redis->set_time("mb_moudel_set", json_encode($moudel_list));
            }
        }
        $moudels = json_decode($moudels, true);

        return $moudels;
    }

    public function getLiveList() {

        $page_no = isset($this->req['page_no']) ? $this->req['page_no'] : 1;
        $page_size = isset($this->req['page_size']) ? $this->req['page_size'] : 20;

        $live_list = $this->liveModel->getLiveList($page_no, $page_size);
        if (empty($live_list)) {
            return false;
        }

        return $this->getLiveInfo($live_list);

    }

    public function getLiveInfo($live_list) {
        $anchor_ids = "";
        $live_ids = "";
        foreach ($live_list as $itm) {
            $anchor_ids .= $itm['anchor_id'] . ",";
            $live_ids .= $itm['id'] . ",";
        }

        $anchor_ids = rtrim($anchor_ids, ',');
        $live_ids = rtrim($live_ids, ',');

        $user_domain = new Domain_User();
        $anchor_list = $user_domain->getUsersInfoByIds($anchor_ids);
        if (empty($anchor_list)) {
            throw new PhalApi_Exception_BadRequest('内部错误-1', 111);
        }

        $user_deal_log_model = new Model_UserDealLog();

        $spend_list = $user_deal_log_model->getUserDealList($this->req['user_id'], MOUDEL_LIVE_TICKET, $live_ids);
        $pay_live_list = array();
        foreach ($spend_list as $itm) {
            $pay_live_list[] = $itm['value'];
        }

        $redis_im_rooms_data = DI()->redis->get_forever('im_rooms_data');
        if(!empty($redis_im_rooms_data)) {
            $rooms_data = json_decode($redis_im_rooms_data, true);
            if(is_array($rooms_data)) {
                //重置数组结构，用环信id作为键，数组值不变
                $new_rooms_data = array_reduce($rooms_data, function (&$new_rooms_data, $v) {
                    $new_rooms_data[$v['id']] = $v;
                    return $new_rooms_data;
                });
            }
        }
        //把数据中的聊天室id作为键
//        $new_rooms_data = array();
//        foreach ($rooms_data as $room) {
//            $new_rooms_data[][$room['id']] = $room;
//        }

        $final_live_list = array();
        foreach ($live_list as $itm) {
            $itm['anchor_name'] = $anchor_list[$itm['anchor_id']]['nick_name'];
            $itm['anchor_sex'] = $anchor_list[$itm['anchor_id']]['sex'];
            $itm['anchor_avatar'] = $anchor_list[$itm['anchor_id']]['avatar'];
            $itm['anchor_address'] = ($anchor_list[$itm['anchor_id']]['address']
                && $anchor_list[$itm['anchor_id']]['address'] != ' ')
                ? $anchor_list[$itm['anchor_id']]['address']
                : '火星';
            if($itm['status'] == 2) {
                if($itm['type'] == 0) {
                    $itm['start_time'] = '直播中';
                } else {
                    $itm['start_time'] = '无主播场';
                }
            } else {
                $itm['start_time'] = g_dayToWeak($itm['start_time']);
            }
            $itm['create_time'] = '发布时间：' . g_tranTime(strtotime($itm['create_time']));
            $itm['location'] = ($itm['location']
                && $itm['location'] != ' ')
                ? $itm['location']
                : '火星';
            $itm['is_pay'] = in_array($itm['id'], $pay_live_list) ? true : false;
            //直播间正在玩的人数
            $itm['playing_num'] = isset($new_rooms_data[$itm['chatroom_id']])
                ? $new_rooms_data[$itm['chatroom_id']]['affiliations_count']
                : 0;
            //购票人数等于实际购票人数加上在线机器人;
            if($itm['ticket_price'] > 0) {
                $chatroom_robot_user_list_key = "chatroom_" . $itm['id'] . "_robot_user_list_key";
                $robot_users = DI()->redis->get_forever($chatroom_robot_user_list_key);
                $robot_users_num = substr_count($robot_users, ',');
                $itm['ticket_sale'] = $itm['ticket_sale'] + $robot_users_num;
            }
            $final_live_list[] = $itm;
        }
        return $final_live_list;
    }

    public function getBannerList() {
        $tools = new Model_Tools();
        $banner_list = $tools->getBannerList();
        if (empty($banner_list)) {
            return false;
        }

        return $banner_list;
    }



    public function getUserLiveList($user_id) {
        $live_list = $this->liveModel->getUserLiveList($user_id);
        if (empty($live_list)) {
            return false;
        }
        return $live_list;
    }

}