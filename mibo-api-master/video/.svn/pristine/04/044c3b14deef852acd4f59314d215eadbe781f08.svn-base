<?php

/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2016/8/16
 * Time: 18:35
 */
class Domain_App {

    private $req;
    private $channelModel;

    public function __construct() {
        $this->req = DI()->request->getAll();
        $this->channelModel = new Model_Channel();
    }

    public function getNewVersion() {
        $model_version = new Model_Version();
        return $model_version->getNewVersion();
    }

    public function getChannelInfo() {
        $channels = $this->channelModel->getChannelInfoByChannel($this->req['channel']);
        if (empty($channels)) {
            return false;
        }

        return $channels;
    }

    public function getShareInfo() {
        $live_domain = new Domain_Live();
        $live_info = $live_domain->getLiveInfoByLiveId($this->req['live_id']);
        if (empty($live_info)) {
            throw new PhalApi_Exception('直播不存在', 455);
        }

        $user_domain = new Domain_User();
        $user_info = $user_domain->getUsersInfoById($this->req['user_id']);
        $anchor_info = $user_domain->getUsersInfoById($live_info['anchor_id']);
        if (empty($user_info)) {
            throw new PhalApi_Exception_BadRequest('用户名不存在', 56);
        }

        $logo_url = "https://mmbiz.qlogo.cn/mmbiz/5A0v82JgqJaP4Y1kbXZiaz8ibbEPNIPQnxYtuAmdgeO1de4EVNkcFWyibwEob2EibsA8kX9gf8sea4WKfRc4ibeTmMA/0?wx_fmt=png";
        $share_url = "http://miboweb.yahalei.com/wap/index.php?live_id=" . $live_info['id'] .
                     "&anchor_id=" . $live_info['anchor_id'] . "&user_id=" . $user_info['id'] .
                    "&channel=" . $this->req['channel'] . '&type=' . $this->req['share_type'];
        if ($user_info['id'] == $live_info['anchor_id']) {
            if ($live_info['status'] == LIVE_STATUS_LIVING) {
                $title = "我正在直播【" . $live_info['live_name'] . "】 欢迎收看";
            } else {
                $title = "我的直播邀请";
            }
        } else {
            $title = "「" . $anchor_info['nick_name'] . '」 的直播邀请';
        }

        $desc = "独家爆料，「" . $anchor_info['nick_name'] . '」' . '正在直播【' . $live_info['live_name'] . '】';

        $rs = array(
            'user_id'     => $this->req['user_id'],
            'live_id' => $this->req['live_id'],
            'imgUrl'  => $live_info['cover_url'],
            'logoUrl' => $logo_url,
            'link'    => $share_url,
            'title'   => $title,
            'desc'    => $desc,
            'type'    => $this->req['share_type'],
        );
        return $rs;
    }

    public function setShareResult() {
        $today = date('Y-m-d', time());
        $im = new Domain_IM();

        $user_domain = new Domain_User();
        $user_info = $user_domain->getUsersInfoById($this->req['user_id']);
        if (empty($user_info)) {
            throw new PhalApi_Exception_BadRequest('用户名不存在', 56);
        }

        $user_domain->setShareExperience($user_info['id'], $this->req['live_id'], $this->req['share_type']);
        //分享一次送5w米币，一天最多三次
        $share_times = DI()->notorm->share_log->where('share_time >= ?', $today)->count();
        if($share_times <= 2) {
            $add_coin_num = 50000;
            $user_domain->updateUserDiamondNumReduce($user_info['id'], 0, false, $add_coin_num);
            $im->sendUserMsg(1, $user_info['id'], '直播分享成功，系统赠送50000米币');
        }


        $data = array(
            'coin_num'   => $user_info['coin_num'] + (isset($add_coin_num) ? $add_coin_num : 0),
            'user_id'    => $user_info['id'],
            'live_id'    => $this->req['live_id'],
            'title'      => $this->req['title'],
            'desc'       => $this->req['desc'],
            'img_url'    => $this->req['img_url'],
            'link'       => $this->req['link'],
            'share_type' => $this->req['share_type'],
        );

        DI()->notorm->share_log->insert($data);

        //获取直播间环信聊天室id，发送分享消息
        if($this->req['is_in_room'] == 1) {

            $chatroom_key = "chatroom_" . $this->req['live_id'];
            $chatroom_id = DI()->redis->get_forever($chatroom_key);
            if (empty($chatroom_id)) {
                $live_model = new Model_LiveList();
                $live_info = $live_model->getLiveInfoByLiveId($this->req['live_id']);
                $chatroom_id = $live_info['chatroom_id'];
                DI()->redis->set_forever($chatroom_key, $chatroom_id);
            }

            if($share_times <= 5) {
                $msg = '「' . $user_info['nick_name'] . "」分享了直播,系统赠送50000米币。";
            } else {
                $msg = '「' . $user_info['nick_name'] . "」分享了直播。";
            }

            $msg_rs = $im->sendLiveMsg($user_info['id'], $chatroom_id, $msg, IM_SYS_NOTICE);
            if (!$msg_rs) {
                DI()->logger->error('分享直播环信消息错误');
            }
        }

        return $data;
    }

    public function report() {
        $data = array(
            'user_id' => $this->req['user_id'],
            'to_user_id' => $this->req['to_user_id'],
            'type' => $this->req['type'],
            'content' => isset($this->req['content']) ? $this->req['content'] : '',
        );
        DI()->notorm->report->insert($data);
        $id = DI()->notorm->report->insert_id();

        if($id) {
            return true;
        } else {
            return false;
        }

    }

    public function sendFeedback() {
        //一天只能10条
        $send_num = DI()->redis->get_time('user_id_'.$this->req['user_id'].'_feedback_num');
        $send_num = isset($send_num) ? $send_num : 0;
        if($send_num <= 10) {
            $send_num += 1;
            DI()->redis->set_time('user_id_'.$this->req['user_id'].'_feedback_num', $send_num, 86400);
            $data['user_id'] = $this->req['user_id'];
            $data['type'] = $this->req['type'];
            $data['content'] = $this->req['content'];
            DI()->notorm->feedback->insert($data);
            $id = DI()->notorm->feedback->insert_id();
            if(!$id) {
                return false;
            }
        }

        return true;

    }

    //加载资源图标
    public function getLoadingIcon() {
        $model_loading_icon = new Model_LoadingIcon();
        $rs = $model_loading_icon->getLoadingIcon();
        return $rs;
    }

    //联系我们
    public function contactUs() {
        $rs = '<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title></title>
</head>
<body>
	<p style="margin: 20px auto;">请联系米播客服,微信号：媚芝</p>
</body>
</html>';

        return $rs;
    }

    public function getSplashScreen() {
        $model_screen = new Model_SplashScreen();
        return $model_screen->getSplashScreen();
    }

}