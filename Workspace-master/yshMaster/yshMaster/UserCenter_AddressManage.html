<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="ThemeBucket">
		<link rel="shortcut icon" href="#" type="image/png">

		<title>Form Layouts</title>
		<!--pickers css-->
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datepicker/css/datepicker-custom.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-timepicker/css/timepicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-colorpicker/css/colorpicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/bootstrapValidator.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/select2.min.css"/>
		
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/ysh_comm.js"></script>
		
		<script type="text/javascript">
			checkPermission();
		</script>
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->
	</head>

	<body class="children-body">
		<!--
            	作者：443267568@qq.com
            	时间：2016-05-03
            	描述：修改开始处
            -->
		<!--body wrapper start-->
		<section class="wrapper">
			<!-- page start-->

			<div class="row">
				<div class="col-lg-12">
					<section class="panel">
						<header class="panel-heading">
							地址管理
						</header>
						<div class="panel-body">
							<form class="form-horizontal" role="form">
								<div class="row clearfix">
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">用户编码:</label>
											<div class="col-lg-9">
												<input class=" form-control" id="user_code" name="name" minlength="2" type="text" />
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">收货人:</label>
											<div class="col-lg-9">
												<input class=" form-control" id="consignee" name="name" minlength="2" type="text" />
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">联系电话:</label>
											<div class="col-lg-9">
												<input class=" form-control" id="Contactphone" name="name" minlength="2" type="tel" />
											</div>
										</div>
									</div>
								</div>

							</form>
						</div>
					</section>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<section class="panel">
						<div class="panel-body text-right">
							<button class="btn btn-success" type="button" id="btn_search">查询</button>
							<button class="btn btn-danger" type="button" id="btn_batchdelete">批量删除</button>
						</div>
					</section>

					<section class="panel">
						<div class="panel-body">
							<table id="bs" class="table table-striped table-condensed table-hover talbe-border" data-side-pagination="server">
								<thead>
									<tr>
										<th data-field="status" data-align="center" data-checkbox="true"></th>

										<th data-field="Id" data-align="center">地址编号</th>
										<th data-field="UserId" data-align="center">用户编码</th>
										<th data-field="FirstName" data-align="center">收货人</th>
										<th data-field="PhoneNumber" data-align="center">联系电话</th>
										<th data-field="detailAddress" data-align="center">详细地址</th>
										<th data-field="IsDefault" data-align="center" data-formatter="defaultAddFormatter">是否默认</th>
										<th data-field="Id" data-align="center" data-formatter="operationFormatter">操作</th>
									</tr>
								</thead>
							</table>

						</div>
					</section>

					<!--body wrapper end-->
				</div>
				<!-- main content end-->

				<!-- Modal -->
				<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade" data-backdrop="static">
					<div class="modal-dialog" style="width: 750px;">
						<div class="modal-content">
							<div class="modal-header">
								<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
								<h4 class="modal-title">编辑地址</h4>
							</div>
							<div class="modal-body">
								<div class=" form">
									<form class="cmxform form-horizontal adminex-form" id="sub_form">
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-2">地址编号:</label>
											<div class="col-lg-10">
												<label for="cname" class="control-label" id="md_dzbh"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cemail" class="control-label col-lg-2">用户编码:</label>
											<div class="col-lg-10">
												<label for="cname" class="control-label" id="md_yhbm"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="curl" class="control-label col-lg-2">收货人:</label>
											<div class="col-lg-9">
												<input class="form-control " id="md_shr" name="md_shr" />
											</div>
											<div class="col-lg-1">
												<span style="color: red;">*</span>
											</div>
										</div>
										<div class="form-group ">
											<label for="ccomment" class="control-label col-lg-2">联系电话:</label>
											<div class="col-lg-9">
												<input class="form-control " id="md_lxdh" name="md_lxdh" />
											</div>
											<div class="col-lg-1">
												<span style="color: red;">*</span>
											</div>
										</div>
										<div class="form-group ">
											<label for="ccomment" class="control-label col-lg-2">详细地址:</label>
											<div class="col-lg-3">
												<select class="form-control input-small m-bot15" style="padding-right: 0;" id="StateProvinceId">

												</select>
											</div>
											<div class="col-lg-3">
												<select class="form-control input-small m-bot15" style="padding-right: 0;" id="Cityid">

												</select>
											</div>
											<div class="col-lg-3">
												<select class="form-control input-small m-bot15" style="padding-right: 0;" id="DistrictCounty">

												</select>
											</div>
											<label for="ccomment" class="control-label col-lg-2"></label>
											<div class="col-lg-9">
												<textarea style="resize: none;" rows="3" class="form-control" id="txt_Address1" name="txt_Address1"></textarea>
											</div>
											<div class="col-lg-1">
												<span style="color: red;">*</span>
											</div>
										</div>
										<div class="form-group ">
											<label class="control-label col-lg-2">是否默认:</label>
											<div class="col-lg-10">
												<label class="checkbox-inline">
										            <input type="checkbox" id="ck_isDefault" >
										        </label>
											</div>
										</div>
									</form>
								</div>
							</div>
							<div class="modal-footer">

								<button type="button" class="btn btn-success" id="btn_save">保存</button>
								<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
							</div>
						</div>
					</div>
				</div>
				<!-- modal -->
			</div>
		</section>

		<!-- Placed js at the end of the document so the pages load faster -->
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
		<script src="js/jquery-migrate-1.2.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/modernizr.min.js"></script>
		<script src="js/jquery.nicescroll.js"></script>

		<!--pickers plugins-->
		<script type="text/javascript" src="js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/moment.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/daterangepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>

		<!--bootstrap Table-->
		<script src='js/bootstrap-table.js'></script>
		<script src='js/bootstrap-table-zh-CN.js'></script>
		<script src='js/bootstrap-editable.js'></script>
		<script src='js/bootstrap-table-editable.js'></script>

		<!--pickers initialization-->
		<script src="js/pickers-init.js"></script>

		<!--common scripts for all pages-->
		<script src="js/scripts.js"></script>
		<script src="js/ysh_comm.js"></script>
		<script src="js/layer.js"></script>
		<script src="js/bootstrapValidator.js"></script>
		<!--下拉插件-->
		<script src="js/select2.min.js"></script>

		<script type="text/javascript">
			var checkList = new Array();
			var $table = $("#bs");
			var condition = {};

			function operationFormatter(value, row, index) {
				var result = [
					'<button onclick="EditAddr(' + value + ',' + row.UserId + ')" class="btn btn-info">编辑</button>', '<button onclick="DeleteAddr(' + value + ')" class="btn btn-danger">删除</button>'
				];
				return result.join(' ');
			}

			function defaultAddFormatter(value, row, index) {
				if(value == '0')
					return '否';
				else
					return '是';
			}
			$("#btn_search").click(function() {
				getdata(0);
			});
			$(document).ready(function() {
				leftCancelShade('myModal');
				checkList = new Array();
				$table.bootstrapTable({
					pagination: true, //分页
					//data: data,
					onCheck: function(row) {
						checkList.push(row.Id);
						$.unique(checkList);
					},
					onUncheck: function(row) {
						//$.unique(checkList);
						var pIndex = $.inArray(row.Id, checkList);
						checkList.splice(pIndex, 1);
						$.unique(checkList);
					},
					onCheckAll: function(rows) {
						$.each(rows, function(index) {
							checkList.push(rows[index].Id);
						});
						$.unique(checkList);
					},
					onUncheckAll: function(rows) {
						checkList = new Array();
					},
					escape: true,
					pageList: [10]
				});
				getdata(0);
				//获取省市区县列表
				getPCD("", "#StateProvinceId");
			});
			$(document).delegate("#StateProvinceId", "change", function() {
				getPCD($("#StateProvinceId").find("option:selected").val(), "#Cityid");
				getPCD($("#Cityid").find("option:selected").val(), "#DistrictCounty");
			}).delegate("#Cityid", "change", function() {
				getPCD($("#Cityid").find("option:selected").val(), "#DistrictCounty");
			});
			$("#btn_batchdelete").click(function() {
				if(checkList.length <= 0) {
					ysh_alert("请选中删除项", "warning");
					return;
				}
				console.log(checkList);
				ysh_confirm("确定要删除选中项吗？", "确定", "取消", function(ret) {
					if(ret) {
						DeleteAllAddr(checkList.join(","));
						checkList = new Array();
					}
				});
			});
			//表单验证
			$('#sub_form').bootstrapValidator({
				message: '错误',
				feedbackIcons: {
					valid: 'glyphicon glyphicon-ok',
					invalid: 'glyphicon glyphicon-remove',
					validating: 'glyphicon glyphicon-refresh'
				},
				fields: {
					md_shr: {
						validators: {
							notEmpty: {
								message: '收货人不能为空'
							}
						}
					},
					md_lxdh: {
						validators: {
							notEmpty: {
								message: '联系电话不能为空'
							},
							regexp: {
								regexp: /^((\+?86)|(\(\+86\)))?(13[0123456789][0-9]{8}|15[0123456789][0-9]{8}|18[0123456789][0-9]{8}|147[0-9]{8}|170[0-9]{8}|1349[0-9]{7})$|^[0-9]{3}-[0-9]{8}$|^[0-9]{4}-[0-9]{7}$/,
								message: "电话号码格式错误,格式如 18000000000、028-12345678、0812-1234567"
							}
						}
					},
					txt_Address1: {
						validators: {
							notEmpty: {
								message: '地址不能为空'
							}
						}
					}
				}
			});
			//保存
			$("#btn_save").click(function() {
				$('#sub_form').data('bootstrapValidator').validate();
				if($("#sub_form").data('bootstrapValidator').isValid()) {
					var da = {
						addressId: $("#md_dzbh").text(),
						userID: $("#md_yhbm").text(),
						FirstName: $("#md_shr").val(),
						PhoneNumber: $("#md_lxdh").val(),
						StateProvinceId: $("#StateProvinceId").find("option:selected").val(),
						Cityid: $("#Cityid").find("option:selected").val(),
						DistrictCounty: $("#DistrictCounty").find("option:selected").val(),
						Address1: $("#txt_Address1").val(),
						Address2: $("#StateProvinceId").find("option:selected").text() + $("#Cityid").find("option:selected").text() + $("#DistrictCounty").find("option:selected").text(),
						IsDefault: $("#ck_isDefault").attr("checked") == "checked" ? 1 : 0
					}
					getDataList(yshurl + "UC_UpdateAddress", da, function(d) {
						$('#myModal').modal('hide');
						var options = $table.bootstrapTable('getOptions');
						var offset = (options.pageNumber - 1) * options.pageSize;
						getdata(offset);
						ysh_msg("保存成功");
					});
				}
			});
			var getdata = function(offset) {
					var data = new Array();
					var totalcount = 0;
					condition = {
						userId: $("#user_code").val(),
						FirstName: $("#consignee").val(),
						PhoneNumber: $("#Contactphone").val()
					}
					condition.p_limit = $table.bootstrapTable('getOptions').pageSize;
					condition.p_offset = offset;
					var options = $table.bootstrapTable('getOptions');
					if(offset == 0) {
						options.pageNumber = 1;
						$table.bootstrapTable('refreshOptions', options);
					}
					getDataList(yshurl + "GetAddressList", condition, function(d) {
						data = d.many[0];
						totalcount = d.many[1][0].totalcount;
					});
					var pdata = {
						total: totalcount,
						rows: data
					};
					$table.bootstrapTable('load', pdata);
					setIframeHeight();
					//paramsInfo = {};
				}
			
			//点击分页查询
			$table.on('page-change.bs.table', function(e, number, size) {
				var os = (number - 1) * size;
				window.location.hash = number;
				getdata(os);
			});
			window.onhashchange = function() {
				var hash = window.location.hash;
				var id;
				if(hash != "") {
					id = parseInt(hash.substr(1));
				} else {
					id = 1
				}
				getdata((id-1)*10);
				console.info(hash)
				$("ul.pagination").children().eq(id).addClass("active").siblings().removeClass("active");
			}
			
			//编辑
			function EditAddr(id, userId) {
				getDataList(yshurl + "UC_GetAddressById", {
					AddressId: id
				}, function(d) {
					$("#md_dzbh").text(id);
					$("#md_yhbm").text(userId);
					$("#md_shr").val(d.aaData[0].FirstName);
					$("#md_lxdh").val(d.aaData[0].PhoneNumber);
					$("#txt_Address1").val(d.aaData[0].Address1);
					if(d.aaData[0].IsDefault == 1) {
						$("#ck_isDefault").attr("checked", true);
					} else {
						$("#ck_isDefault").attr("checked", false);
					}
					//赋值省市区
					$("#StateProvinceId").val(d.aaData[0].StateProvinceId);
					getPCD($("#StateProvinceId").find("option:selected").val(), "#Cityid");
					$("#Cityid").val(d.aaData[0].Cityid);
					getPCD($("#Cityid").find("option:selected").val(), "#DistrictCounty");
					$("#DistrictCounty").val(d.aaData[0].DistrictCounty);
					$('#myModal').modal('show');
				});
				//console.log(row);
				//$('#myModal').modal('show');
				//window.location.href = "UserCenter_EditAddress.html?id=" + id;
			}
			//保存
			function SaveAddr() {}
			//删除
			function DeleteAddr(id) {
				ysh_confirm("确定要删除吗？", "确定", "取消", function(ret) {
					if(ret) {
						getDataList(yshurl + "UC_DelAddress", {
							IdList: id
						}, function(d) {
							getdata(0);
							ysh_msg("删除成功");
						});
					}
				});
			}
			//批量删除
			function DeleteAllAddr(idlist) {
				getDataList(yshurl + "UC_DelAddress", {
					IdList: idlist
				}, function(d) {
					getdata(0);
					ysh_msg("删除成功");
				});
			}
			//获取省市区方法
			function getPCD(a, b) {
				getDataList(yshurl + "GetAreaInfo", {
					pParentAreaNum: a,
					pPageIndex: 0,
					pPageSize: 100
				}, function(d) {
					if(d.state == 0 && d.aaData[0].length > 0) {
						var htmlstr = "";
						for(var i = 0; i < d.aaData[0].length; i++) {
							htmlstr += '<option value="' + d.aaData[0][i].AreaID + '">' + d.aaData[0][i].AreaName + '</option>';
						}
						$(b).html(htmlstr);
					} else {
						console.log("获取地区列表接口出错");
					}
				});
			}
			$('#myModal').on('hide.bs.modal', function() {
				$('#sub_form').data('bootstrapValidator').resetForm();
			});
		</script>
		<script type="text/javascript">
			$(function(){
//				$('select').select2();
			})
		</script>
		<!--
			作者：443267568@qq.com
			时间：2016-05-03
			描述：修改结束
		-->
	</body>

</html>