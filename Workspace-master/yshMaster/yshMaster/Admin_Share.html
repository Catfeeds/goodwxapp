<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="ThemeBucket">
		<link rel="shortcut icon" href="#" type="image/png">
		<title>分一分</title>
		<!--multi-select-->
		<link rel="stylesheet" type="text/css" href="js/jquery-multi-select/css/multi-select.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datepicker/css/datepicker-custom.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-timepicker/css/timepicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-colorpicker/css/colorpicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/bootstrapValidator.css" rel="stylesheet">
		<link href="js/control/css/zyUpload.css" rel="stylesheet" type="text/css">
		<link href="css/autocomplete.css" rel="stylesheet" type="text/css">
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/ysh_comm.js"></script>
		<script type="text/javascript">
			checkPermission();
		</script>
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->
	</head>

	<body class="children-body">
		<section>
			<!-- main content start-->
			<div class="">

				<!--body wrapper start-->
				<section class="wrapper">
					<!-- page start-->

					<div class="row">
						<div class="col-lg-12">
							<section class="panel">
								<header class="panel-heading">
									爱分享
								</header>
								<div class="panel-body">
									<form class="form-horizontal" role="form">
										<div class="row clearfix">
											<div class="col-lg-4">
												<div class="form-group">
													<label class="col-sm-3 control-label col-lg-3">文章名</label>
													<div class="col-lg-9">
														<input class=" form-control" id="articleName" name="name" minlength="2" type="text">
													</div>
												</div>
											</div>
											<div class="col-lg-4">
												<div class="form-group">
													<label class="col-sm-3 control-label col-lg-3">关联商品</label>
													<div class="col-lg-9">
														<input class=" form-control" id="productname" name="name" minlength="2" type="text">
													</div>
												</div>
											</div>
											<div class="col-lg-4">
												<div class="form-group">
													<label class="col-sm-3 control-label col-lg-3"></label>
													<div class="col-lg-9">
														<button class="btn btn-info" type="button" id="btn_search">搜索</button>
													</div>
												</div>
											</div>
										</div>
									</form>
								</div>
							</section>
						</div>
					</div>
					<div class="row">
						<div class="col-lg-12">
							<section class="panel">
								<div class="panel-body">
									<div class="clearfix pull-right">
										<div class="btn-group">
											<button id="share_add" class="btn btn-success">
												添加 
											</button>
										</div>
									</div>
									<table id="bs" class="table table-striped table-condensed table-hover talbe-border" data-side-pagination="server">
										<thead>
											<tr>
												<th data-field="status" data-align="center" data-checkbox="true"></th>
												<th data-field="Id" data-align="center">编号</th>
												<th data-field="ArticleName" data-align="center">文章名</th>
												<th data-field="ProductName" data-align="center">活动关联商品</th>
												<th data-field="ShareTimes" data-align="center">分享次数</th>
												<th data-field="OrderTimes" data-align="center">下单次数</th>
												<th data-field="OrderTotals" data-align="center">下单总金额</th>
												<th data-field="BackTotals" data-align="center">分享收益金额</th>
												<th data-field="Sharedate" data-align="center">分享日期</th>
												<th data-field="Id" data-align="center" data-formatter="operationFormatter">操作</th>
											</tr>
										</thead>
									</table>

								</div>
							</section>

							<!--body wrapper end-->

						</div>
						<!-- main content end-->
						<!-- Modal -->
						<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade">
							<div class="modal-dialog modal-lg">
								<div class="modal-content">
									<div class="modal-header">
										<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
										<h4 class="modal-title">编辑分享</h4>
									</div>
									<div class="modal-body">
										<div class=" form">
											<form class="cmxform form-horizontal adminex-form" id="sub_form">
												<div class="form-group">
													<label for="cname" class="control-label col-lg-3">文章标题：</label>
													<div class="col-lg-8">
														<input class="form-control" id="shareTitle" name="shareTitle" minlength="2" type="text" />
													</div>
													<div class="col-lg-1">
														<span style="color: red;">*</span>
													</div>
												</div>

												<div class="form-group">
													<label for="cemail" class="control-label col-lg-3">文章链接：</label>
													<div class="col-lg-8">
														<input class="form-control " id="shareLink" name="shareLink" type="url" data-bv-uri-message="The input is not a valid website address" />
													</div>
													<div class="col-lg-1">
														<span style="color: red;">*</span>
													</div>
												</div>

												<div class="form-group">
													<label for="cname" class="control-label col-lg-3">分享返利金额：</label>
													<div class="col-lg-8">
														<input class="form-control" id="backPrice" name="backPrice" minlength="2" type="number" placeholder="1.00元" />
													</div>
													<div class="col-lg-1">
														<span style="color: red;">*</span>
													</div>
												</div>
												<div class="form-group">
													<label for="curl" class="control-label col-lg-3">是否链接商品：</label>
													<div class="col-lg-8">
														<div>
															<input type="checkbox" id="IsLink" checked="" style="margin-top: 1rem;">
														</div>
													</div>
												</div>

												<div class="form-group" id="showLink">
													<label for="ccomment" class="control-label col-lg-3">链接商品：</label>
													<div class="col-lg-8">
														<!--<input class="form-control" id="linkPro" type="text" />-->
														<div id="linkPro1"></div>
													</div>
												</div>

												<div class="form-group ">
													<label for="ccomment" class="control-label col-lg-3">购买返现金额：</label>
													<div class="col-lg-8">
														<input class=" form-control" id="buyBack" name="buyBack" minlength="2" type="number" />
													</div>
												</div>

												<div class="form-group ">
													<label for="ccomment" class="control-label col-lg-3">活动时间：</label>
													<div class="col-lg-8">
														<div class="col-lg-5" style="padding-left: 0;">
															<!--<div data-date-viewmode="years" data-date-format="yyyy-mm-dd" data-date="2016-01-01" class="input-append date dpYears">
																<input type="text" readonly="true" size="16" id="startTime" name="startTime" class="form-control" />
																<span class="input-group-btn add-on">
																<button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
																</span>
															</div>-->
																<input type="text" size="16" id="startTime" name="startTime" class="form-control" onclick="SelectDate(this,'yyyy-MM-dd')"/>
															
														</div>
														<p class="col-lg-1" style="padding-top: 7px;margin-left: 20px;">至</p>
														<div class="col-lg-5" style="padding-left: 0;">
															<!--<div data-date-viewmode="years" data-date-format="yyyy-mm-dd" data-date="2016-12-12" class="input-append date dpYears">
																<input type="text" readonly="true" id="endTime" name="endTime" size="16" class="form-control" />
																<span class="input-group-btn add-on"> 
																<button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
																</span>
															</div>-->
																<input type="text" id="endTime" name="endTime" size="16" class="form-control" onclick="SelectDate(this,'yyyy-MM-dd')"/>
															
														</div>
													</div>
													<div class="col-lg-1">
														<span style="color: red;">*</span>
													</div>
												</div>
												<div class="form-group">
													<label for="cemail" class="control-label col-lg-3">分享图片：</label>
													<div class="col-lg-8">
														<div><img id="sharePic" style="height: 100px;width: 100px;" /></div>
														<div id="zyUpload"></div>
													</div>
												</div>
												<div class="form-group">
													<label for="cemail" class="control-label col-lg-3">相关描述：</label>
													<div class="col-lg-8">
														<textarea  style="resize: none;" class="form-control" rows="5" id="detailes"></textarea>
													</div>
												</div>
											</form>
											<!-- 表格结束-->
										</div>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
										<button type="button" class="btn btn-success" id="btn_save">保存</button>
									</div>
								</div>
							</div>
						</div>
				</section>

				<!-- Placed js at the end of the document so the pages load faster -->
				<!-- Placed js at the end of the document so the pages load faster -->
				<script src="js/jquery-1.10.2.min.js"></script>
				<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
				<script src="js/jquery-migrate-1.2.1.min.js"></script>
				<script src="js/bootstrap.min.js"></script>
				<script src="js/modernizr.min.js"></script>
				<script src="js/jquery.nicescroll.js"></script>

				<!--pickers plugins-->
				<script type="text/javascript" src="js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
				<script type="text/javascript" src="js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
				<script type="text/javascript" src="js/bootstrap-daterangepicker/moment.min.js"></script>
				<script type="text/javascript" src="js/bootstrap-daterangepicker/daterangepicker.js"></script>
				<script type="text/javascript" src="js/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
				<script type="text/javascript" src="js/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>

				<!--bootstrap Table-->
				<script src='js/bootstrap-table.js'></script>
				<script src='js/bootstrap-table-zh-CN.js'></script>
				<script src='js/bootstrap-editable.js'></script>
				<script src='js/bootstrap-table-editable.js'></script>
				<!-- 引用核心层插件 -->
				<script type="text/javascript" src="js/core/zyFile.js"></script>
				<!-- 引用控制层插件 -->
				<script type="text/javascript" src="js/control/js/zyUpload.js"></script>

				<!--common scripts for all pages-->
				<script src="js/scripts.js"></script>
				<script src="js/ysh_comm.js"></script>
				<script src="js/layer.js"></script>

				<!--pickers initialization-->
				<script src="js/pickers-init.js"></script>
				<script src="js/bootstrapValidator.js"></script>
				<script src="js/autocomplete.js"></script>
				<script src="js/adddate.js"></script>
				

				<script>
					var checkList = new Array();
					var fileurl = "";
					var $table = $("#bs");
					// 选择文件的回调方法
					onSelect = function(files, allFiles) {
							if (ZYFILE.uploadFile.length > 1) {
								ZYFILE.uploadFile.splice(0, 1);
							}
							if (files.length > 0)
								$(".upload_preview").html('');
						}
						// 上传文件成功的回调方法
					onSuccess = function(file, response) {
							fileurl = JSON.parse(response).aaData[0].fileurl;
							$("#sharePic").attr("src", 'http://f.yshfresh.com' + fileurl);
						}
						//上传文件失败的回调方法
					onFailure = function(file) {
							ysh_alert("上传图片失败了:" + file)
						}
						//上传文件完成的回调方法
					onComplete = function(responseInfo) {
						ysh_msg("图片上传完成");
					}
					$table.bootstrapTable({
						pagination: true, //分页
						onCheck: function(row) {
							checkList.push(row.Id);
							$.unique(checkList);
						},
						onUncheck: function(row) {
							var pIndex = $.inArray(row.Id, checkList);
							checkList.splice(pIndex, 1);
							$.unique(checkList);
						},
						onCheckAll: function(rows) {
							$.each(rows, function(index) {
								checkList.push(rows[index].Id);
							});
							$.unique(checkList);
						},
						onUncheckAll: function(rows) {
							$.unique(checkList);
							var filterarray = $.grep(checkList, function(value) {
								var isDel = false;
								for (var i = 0; i < rows.length; i++) {
									if (rows[i].Id == value) {
										isDel = true;
										break;
									}
								}
								return !isDel;
							});
							checkList = filterarray;
						},
						escape: true,
						pageList: [10]
					});
					$(document).ready(function() {
						leftCancelShade('myModal');
						getdata(0);
						//新增
						$("#share_add").click(function() {
							$("#shareTitle").val("");
							$("#shareLink").val("");
							$("#linkPro").val("");
							$("#backPrice").val("");
							$("#IsLink").attr("checked", false);
							var mydate = new Date();
							$("#startTime").val(mydate.getFullYear() + "-" + (mydate.getMonth() + 1) + "-" + mydate.getDate());
							$("#endTime").val("");
							$("#detailes").val("");
							$("#buyBack").val("");
							$("#btn_save").show();
							$(".modal-title").text("新增分享规则");
							$("#showLink").hide();
							$("#sharePic").removeAttr("src");
							fileurl = "";
							$('#sub_form .col-lg-8>input').attr('readonly', false);
							$('#sub_form textarea').attr('readonly', false);
							$('#IsLink').removeAttr("disabled");
							$('input').attr("disabled",false);
							
							$('#myModal').modal('show');
							setIframeHeight();
							
						});
						//保存
						$("#btn_save").click(function() {
							$('#sub_form').data('bootstrapValidator').validate();
							if ($("#sub_form").data('bootstrapValidator').isValid()) {
								var upData = {
									S_Id: $(".modal-title").attr("name"),
									ArticleName: $("#shareTitle").val(),
									ArticleUrl: $("#shareLink").val(),
									IsDelete: 0,
									ProductId: $('#linkPro').attr('ekey'),
									BackPrice: $("#backPrice").val(),
									BeginTime: $("#startTime").val(),
									EndTime: $("#endTime").val(),
									Notes: $("#detailes").val(),
									BuybackPrice: $("#buyBack").val(),
									PicType: 8,
									Picurl: fileurl
								}
								
								var startdate = getDate(upData.BeginTime);
								var enddate = getDate(upData.EndTime);
								
								if (startdate <= enddate) {
									if ($(".modal-title").text() == "新增分享规则") {
										if (fileurl == "") {
											ysh_msg("请选择图片并上传！");
											return;
										} else {
											getDataList(yshurl + "AddShareRecord", upData, function(d) {
												if (d.state == 0) {
													$('#myModal').modal('hide');
													getdata(0);
												}
											});
										}
									} else {
										if ($("#IsLink").attr("checked") != "checked") {
											upData.IsDelete = 1;
										} else {
											if (upData.ProductId == "") {
												ysh_msg("不存在该链接商品,请重新输入！");
												return;
											}
										}
										getDataList(yshurl + "UpdateShareRecord", upData, function(d) {
											if (d.state == 0) {
												$('#myModal').modal('hide');
												getdata(0);
											}
										});
									}
								} else {
									ysh_msg('活动结束日期应该大于开始日期！');
								}
							}
						});
						$("#IsLink").click(function() {
							if ($(this).attr("checked") == "checked") {
								$("#showLink").slideDown();
							} else {
								$("#showLink").slideUp();
							}
						});
						//初始化图片上传插件
						$("#zyUpload").zyUpload({
							width: "563px", // 宽度
							height: "270px", // 宽度
							itemWidth: "100px", // 文件项的宽度
							itemHeight: "60px", // 文件项的高度
							url: "http://f.yshfresh.com/upload", // 上传文件的路径
							multiple: false, // 是否可以多个文件上传
							dragDrop: true, // 是否可以拖动上传文件
							del: true, // 是否可以删除文件
							finishDel: false // 是否在上传文件完成后删除预览
						});
						$("#fileImage").attr('accept', "image/*");
						//择商品
						$('#linkPro1').autocomplete({
							api: 'GetShareProduct',
							width: '100%',
							height: 34,
							showButton: false,
							name: 'linkPro',
							required: true,
							onSubmit: function(text) {}
						});
					});
					$("#btn_search").click(function() {
						getdata(0);
					});

					function getDate(strDate) {
						var st = strDate;
						var a = st.split(" ");
						var b = a[0].split("-");
						var date = new Date(b[0], b[1], b[2], "0", "0", "0");
						return date;
					}

					function operationFormatter(value, row, index) {
						var result = [
							'<button class="btn btn-info" onclick="LookShare(' + row.Id + ')">查看</button>', '<button class="btn btn-warning" onclick="EditShare(' + row.Id + ')">编辑</button>'
						];
						return result.join(' ');
					}
					//编辑
					function EditShare(id) {
						getDataList(yshurl + "GetShareRecordById", {
							ID: id
						}, function(d) {
							if (d.state == 0) {
								$("#shareTitle").val(d.aaData[0].ArticleName);
								$("#shareLink").val(d.aaData[0].ArticleUrl);
								//								$("#linkPro").val(d.aaData[0].ProductId);
								$('#linkPro').val(d.aaData[0].ProductName);
								$('#linkPro').attr('ekey', d.aaData[0].ProductId);
								$("#backPrice").val(d.aaData[0].BackPrice);
								if (d.aaData[0].ProductName != null) {
									$("#IsLink").attr("checked", true);
									$("#showLink").show();
								} else {
									$("#IsLink").attr("checked", false);
									$("#showLink").hide();
								}
								$('#IsLink').removeAttr("disabled");
								$("#startTime").val(d.aaData[0].BeginDateTime);
								$("#endTime").val(d.aaData[0].EndDateTime);
								$("#detailes").val(d.aaData[0].Notes);
								$("#buyBack").val(d.aaData[0].BuybackPrice);
								$(".modal-title").attr("name", d.aaData[0].Id);
								$("#btn_save").show();
								$(".modal-title").text("编辑分享规则");
								$("#sharePic").attr("src", 'http://f.yshfresh.com' + d.aaData[0].Picurl);
								$('#sub_form .col-lg-8>input').attr('readonly', false);
								$('#sub_form textarea').attr('readonly', false);
								$('#linkPro1 input').attr('readonly', false);
								$('input').attr("disabled", false);
								
								$('#sub_form').data('bootstrapValidator').validate();
								fileurl = d.aaData[0].Picurl;
								if ($("#sub_form").data('bootstrapValidator').isValid()) {
									$('#myModal').modal('show');
								}
							}
						});
					}
					//查看
					function LookShare(id) {
						getDataList(yshurl + "GetShareRecordById", {
							ID: id
						}, function(d) {
							if (d.state == 0) {
								$("#shareTitle").val(d.aaData[0].ArticleName);
								$("#shareLink").val(d.aaData[0].ArticleUrl);
								$('#linkPro').val(d.aaData[0].ProductName);
								$('#linkPro').attr('ekey', d.aaData[0].ProductId);
								$("#backPrice").val(d.aaData[0].BackPrice);
								if (d.aaData[0].ProductName != null) {
									$("#IsLink").attr("checked", true);
									$("#showLink").show();
								} else {
									$("#IsLink").attr("checked", false);
									$("#showLink").hide();
								}
								$("#startTime").val(d.aaData[0].BeginDateTime);
								$("#endTime").val(d.aaData[0].EndDateTime);
								$("#detailes").val(d.aaData[0].Notes);
								$("#buyBack").val(d.aaData[0].BuybackPrice);
								$("#btn_save").hide();
								$(".modal-title").text("查看分享规则");
								$("#sharePic").attr("src", 'http://f.yshfresh.com' + d.aaData[0].Picurl);
								$('#sub_form .col-lg-8>input').attr('readonly', true);
								$('#sub_form textarea').attr('readonly', true);
								$('#linkPro1 input').attr('readonly', true);
								$('#IsLink').attr("disabled", "disabled");
								$('input').attr("disabled", "disabled");
								
								$('#myModal').modal('show');
							}
						});
					}
					
					//表格加载数据
					function loadData(f1, data) {
						f1.bootstrapTable('load', data);
						var hashTemp = window.location.hash || "1"
			
						hashTemp = hashTemp.replace("#", "")
						$(".pagination").find('a').each(function() {
							if($(this).text() == hashTemp)
								$(this).click()
						})
					}
					var getdata = function(offset) {
						checkList = new Array();
						var data = new Array();
						condition = {
							ArticleName: $("#articleName").val(),
							ProductName: $("#productname").val(),
						}
						condition.p_limit = $table.bootstrapTable('getOptions').pageSize;
						condition.p_offset = offset;
						getDataList(yshurl + "GetShareRecord", condition, function(d) {
							data = d.many[0];
							totalcount = d.many[1][0].totalcount;
							var pdata = {
								total: totalcount,
								rows: data
							};
							loadData($table, pdata);
							setIframeHeight();
						});
					}
//					$table.on('page-change.bs.table', function(e, number, size) {
//						var os = (number - 1) * size;
//						getdata(os);
//					});
					//分页点击
					$table.on('page-change.bs.table', function(e, number, size) {
						var os = (number - 1) * size;
						window.location.hash = number;
						getdata(os);
					});
					// onhashchange可以监控hash变化
				    window.onhashchange = function() {
				        var hash = window.location.hash;
				        var id;
				        if(hash != ""){
				        	id = parseInt(hash.substr(1));
				        } else{
				        	id = 1
				        }
				        var os = (id - 1) * 10;
						getdata(os);
				       	$("ul.pagination").children().eq(id).addClass("active").siblings().removeClass("active");
				    };
				    
					$('#myModal').on('hide.bs.modal', function() {
						$('#sub_form').data('bootstrapValidator').resetForm();
					});
					//表单验证
					$('#sub_form').bootstrapValidator({
						message: '错误',
						feedbackIcons: {
							valid: 'glyphicon glyphicon-ok',
							invalid: 'glyphicon glyphicon-remove',
							validating: 'glyphicon glyphicon-refresh'
						},
						fields: {
							shareTitle: {
								validators: {
									notEmpty: {
										message: '值不能为空'
									}
								}
							},
							shareLink: {
								validators: {
									notEmpty: {
										message: '值不能为空'
									},
									uri: {
										message: 'The website address is not valid'
									}
								}
							},
							backPrice: {
								validators: {
									notEmpty: {
										message: '值不能为空'
									}
								}
							}
//							startTime: {
//								validators: {
//									notEmpty: {
//										message: '值不能为空'
//									}
//								}
//							},
//							endTime: {
//								validators: {
//									notEmpty: {
//										message: '值不能为空'
//									}
//								}
//							}
						}
					});
				</script>
				<!--
	作者：zhj
	时间：2016-05-05
	描述：修改结束
-->
	</body>

</html>