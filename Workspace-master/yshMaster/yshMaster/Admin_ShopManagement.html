<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="ThemeBucket">
		<link rel="shortcut icon" href="#" type="image/png">

		<title>Form Layouts</title>
		<!--pickers css-->
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datepicker/css/datepicker-custom.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-timepicker/css/timepicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-colorpicker/css/colorpicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/bootstrapValidator.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/select2.min.css"/>
		
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/ysh_comm.js"></script>
		<!--adddate-->
		<script src="js/adddate.js"></script>
		<script type="text/javascript">
			checkPermission();
		</script>
	</head>

	<body class="children-body">
		<!--body wrapper start-->
		<section class="">
			<!-- page start-->
			<div class="row">
				<div class="col-lg-12">
					<section class="panel">
						<header class="panel-heading">
							店铺管理
						</header>
						<div class="panel-body">
							<form class="form-horizontal" role="form">
								<div class="row clearfix">
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">所属渠道</label>
											<div class="col-lg-9">
												<select class="form-control m-bot15" id="sel_Channel">
													<option value="">1</option>
												</select>
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">店铺状态</label>
											<div class="col-lg-9">
												<select class="form-control m-bot15" id="sel_Status">
													<option value="">1</option>
												</select>
											</div>
										</div>
									</div>
								</div>
								<div class="row clearfix">
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">责任人</label>
											<div class="col-lg-9">
												<input type="text" class="form-control" id="in_Username">
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">店铺名称</label>
											<div class="col-lg-9">
												<input type="text" class="form-control" id="in_Storename">
											</div>
										</div>
									</div>
								</div>
								<div class="row clearfix">
									<div class="col-lg-4">
										<div class="form-group">
											<label class="control-label col-lg-3 col-sm-3 ">开店时间</label>
											<div class="col-lg-9">
												<!--<div data-date-viewmode="years" data-date-format="yyyy-mm-dd" data-date="2016-01-01" class="input-append date dpYears">
													<input type="text" readonly="" value="" size="16" class="form-control" id="in_SetupTime">
													<span class="input-group-btn add-on">
                                                            <button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
                                                    </span>
												</div>-->
													<input type="text" value="" size="16" class="form-control" id="in_SetupTime" onclick="SelectDate(this,'yyyy-MM-dd')"/>
												
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="control-label col-lg-3 col-sm-3 ">店铺注册时间:</label>
											<div class="col-lg-9">
												<!--<div data-date-viewmode="years" data-date-format="yyyy-mm-dd" data-date="2016-12-12" class="input-append date dpYears">
													<input type="text" readonly="" value="" size="16" class="form-control" id="in_JoinTime">
													<span class="input-group-btn add-on">
                                                           <button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
                                                    </span>
												</div>-->
													<input type="text" value="" size="16" class="form-control" id="in_JoinTime" onclick="SelectDate(this,'yyyy-MM-dd')"/>
												
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="text-right">
											<button class="btn btn-info" type="button" id="btn_search">搜索</button>
											<button class="btn btn-danger" type="button" id="btn_Reset">重置</button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</section>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<section class="panel">
						<div class="panel-heading">
							<div class="text-right" style="display: none;">
								<button class="btn btn-success" type="button" id="btn_BatchShutdown">批量关闭</button>
								<button class="btn btn-danger" type="button" id="btn_BatchPass">批量通过申请</button>
								<!--<button class="btn btn-warning" type="button" id="btn_BatchExport">批量导出</button>
								<button class="btn btn-success" type="button" id="btn_AllExport">全部导出</button>-->
							</div>
						</div>
						<div class="panel-body">
							<table id="bs" class="table table-striped table-condensed table-hover talbe-border" data-side-pagination="server">
								<thead>
									<tr>
										<th data-field="status" data-align="center" data-checkbox="true"></th>
										<th data-field="Id" data-align="center">店铺编号</th>
										<th data-field="StoreName" data-align="center">店铺名称</th>
										<th data-field="StoreTop" data-align="center">店铺标题</th>
										<th data-field="ChannelName" data-align="center">所属渠道</th>
										<th data-field="Merchant_Id" data-align="center" data-formatter="recordFormatter">备案状态</th>
										<th data-field="SetupTimeSTR" data-align="center">开店时间</th>
										<th data-field="JoinTimeSTR" data-align="center">店铺注册时间</th>
										<th data-field="datastatus" data-align="center">店铺状态</th>
										<th data-field="InviteCode" data-align="center">店铺邀请码</th>
										<th data-field="Id" data-align="center" data-formatter="operationFormatter">操作</th>
									</tr>
								</thead>
							</table>

						</div>
					</section>

					<!--body wrapper end-->

				</div>
				<!-- main content end-->

				<!-- Modal -->
				<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade" data-backdrop="static">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
								<h4 class="modal-title">店铺详情</h4>
							</div>
							<div class="modal-body">
								<div class=" form">
									<form class="cmxform form-horizontal adminex-form">
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">店铺编号:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_dpbh"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">店铺名称:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_dpmc"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">店铺标题:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_dpbt"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">店铺描述:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_dpms"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">备案状态:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_bazt"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">所属渠道:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_ssqd"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">责任人:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_zrr"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">联系电话:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_lxdh"></label>
											</div>
										</div>

										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">开店时间:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_kdsj"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">注册时间:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_dpzcsj"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">店铺状态:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="md_dpzt"></label>
											</div>
										</div>
									</form>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-success" id="btn_examine">审核</button>
								<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
							</div>
						</div>
					</div>
				</div>
				<!-- modal -->

				<!-- Modal -->
				<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="EditModal" class="modal fade" data-backdrop="static">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
								<h4 class="modal-title">编辑店铺</h4>
							</div>
							<div class="modal-body">
								<div class=" form">
									<form class="cmxform form-horizontal adminex-form" id="sub_form">
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">店铺编号:</label>
											<div class="col-lg-9">
												<label for="cname" class="control-label" id="edit_dpbh"></label>
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">店铺名称:</label>
											<div class="col-lg-9">
												<input class="form-control " id="edit_dpmc" name="edit_dpmc" />
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">店铺标题:</label>
											<div class="col-lg-9">
												<input class="form-control " id="edit_dpbt" name="edit_dpbt" />
											</div>
										</div>
										<div class="form-group ">
											<label for="cname" class="control-label col-lg-3">店铺描述:</label>
											<div class="col-lg-9">
												<textarea style="resize: none;" rows="3" class="form-control" id="edit_dpms" name="edit_dpms"></textarea>
											</div>
										</div>
									</form>
								</div>
							</div>
							<div class="modal-footer">

								<button type="button" class="btn btn-success" id="btn_save">保存</button>
								<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
							</div>
						</div>
					</div>
				</div>
				<!-- modal -->

		</section>

		<!-- Placed js at the end of the document so the pages load faster -->
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
		<script src="js/jquery-migrate-1.2.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/modernizr.min.js"></script>
		<script src="js/jquery.nicescroll.js"></script>

		<!--pickers plugins-->
		<script type="text/javascript" src="js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/moment.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/daterangepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>

		<!--bootstrap Table-->
		<script src='js/bootstrap-table.js'></script>
		<script src='js/bootstrap-table-zh-CN.js'></script>
		<script src='js/bootstrap-editable.js'></script>
		<script src='js/bootstrap-table-editable.js'></script>

		<!--pickers initialization-->
		<script src="js/pickers-init.js"></script>

		<!--common scripts for all pages-->
		<script src="js/scripts.js"></script>
		<script src="js/ysh_comm.js"></script>
		<script src="js/layer.js"></script>
		<script src="js/bootstrapValidator.js"></script>
		<script src="js/select2.min.js"></script>
		<script>
			var checkList = new Array();
			var $table = $("#bs");

			function operationFormatter(value, row, index) {
				var result = "";
				if(row.Merchant_Id > 0) {
					if(row.datastatus == '开店') {
						result = [
							'<button onclick="CloseStore(' + value + ',1' + ')" class="btn btn-danger">关店</button>',
							'<button type="button" onclick="StoreDetails(' + value + ')" class="btn btn-info">详情</button>',
							'<button type="button" onclick="editdetail(' + value + ')" class="btn btn-warning">编辑</button>',
							'<button type="button" onclick="editdetail(' + value + ')" class="btn btn-warning">规则设置</button>'
						];
					} else {
						result = [
							'<button onclick="CloseStore(' + value + ',0' + ')" class="btn btn-success">开店</button>',
							'<button type="button" onclick="StoreDetails(' + value + ')" class="btn btn-info">详情</button>',
							'<button type="button" onclick="editdetail(' + value + ')" class="btn btn-warning">编辑</button>'
						];
					}
				} else {
					result = [
						'<button type="button" onclick="StoreDetails(' + value + ')" class="btn btn-info">详情</button>',
						'<button type="button" onclick="editdetail(' + value + ')" class="btn btn-warning">编辑</button>'
					]
				}
				return result.join(' ')
			}

			function recordFormatter(value, row, index) {
				var result = "";
				if(row.Merchant_Id > 0) {
					result = '已备案'
				} else {
					result = '未备案'
				}
				return result;
			}
			//初始化
			$(function() {
				$('select').select2();
				
				checkList = new Array();
				$table.bootstrapTable({
					pagination: true, //分页
					onCheck: function(row) {
						checkList.push(row.Id)
						$.unique(checkList)
					},
					onUncheck: function(row) {
						$.unique(checkList)
						var pIndex = $.inArray(row.Id, checkList);
						checkList.splice(pIndex, 1)
					},
					onCheckAll: function(rows) {
						$.each(rows, function(index) {
							checkList.push(rows[index].Id)
						});
						$.unique(checkList)
					},
					onUncheckAll: function(rows) {
						checkList = new Array();
					},
					escape: true,
					pageList: [10]
				});
				binddropdownlist();
				getdata(0);

				//左侧菜单遮罩操作
				leftCancelShade('myModal');
				leftCancelShade('EditModal');

				$("input:checkbox").each(function() {
					$(this).hide()
				})
			});

			//绑定下拉列表
			function binddropdownlist() {
				getDataList(yshurl + "AM_Getchannelandstorestatusdrpdownlist", {}, function(d) {
					if(d.state == 0 && d.many[0].length > 0) { //渠道
						var htmlstr = '<option value="0">全部</option>';
						for(var i = 0; i < d.many[0].length; i++) {
							htmlstr += '<option value="' + d.many[0][i].Id + '">' + d.many[0][i].ChannelName + '</option>';
						}
						$("#sel_Channel").html(htmlstr);
					}
					if(d.state == 0 && d.many[1].length > 0) { //店铺状态
						var htmlstr = '';
						for(var i = 0; i < d.many[1].length; i++) {
							htmlstr += '<option value="' + d.many[1][i].dictionaryID + '">' + d.many[1][i].datastatus + '</option>';
						}
						$("#sel_Status").html(htmlstr);
					}
				});
			}
			var getdata = function(offset) {
				var data = new Array();
				var totalcount = 0;
				condition = {
					ChannelId: $("#sel_Channel").find("option:selected").val(),
					//RecordStatus: $("#sel_Record").find("option:selected").val(),
					StoreStatus: $("#sel_Status").find("option:selected").val(),
					Username: $("#in_Username").val(),
					StoreName: $("#in_Storename").val(),
					SetupTime: $("#in_SetupTime").val(),
					JoinTime: $("#in_JoinTime").val()
				}
				condition.p_limit = $table.bootstrapTable('getOptions').pageSize;
				condition.p_offset = offset;
				var options = $table.bootstrapTable('getOptions');
				if(offset == 0) {
					options.pageNumber = 1;
					$table.bootstrapTable('refreshOptions', options);
				}
				getDataList(yshurl + "AM_GetStoreList", condition, function(d) {
					data = d.many[0];
					totalcount = d.many[1][0].totalcount;
					//					console.log(d.many);
				});
				var pdata = {
					total: totalcount,
					rows: data
				};
				$table.bootstrapTable('load', pdata);
				setIframeHeight();
			};

			//分页点击
			$table.on('page-change.bs.table', function(e, number, size) {
				var os = (number - 1) * size;
				window.location.hash = number;
				getdata(os);
			});
			// onhashchange可以监控hash变化
			window.onhashchange = function() {
				var hash = window.location.hash;
				var id;
				if(hash != "") {
					id = parseInt(hash.substr(1));
				} else {
					id = 1
				}
				var os = (id - 1) * 10;
				getdata(os);
				$("ul.pagination").children().eq(id).addClass("active").siblings().removeClass("active");
			};

			//查询
			$("#btn_search").click(function() {
				getdata(0);
			});
			//关店
			function CloseStore(id, value) {
				var msg = '';
				if(value == '1') {
					msg = "确定要关闭吗？"
				} else {
					msg = "确定要开启吗？"
				}
				ysh_confirm(msg, "确定", "取消", function(ret) {
					if(ret) {
						UpdateStoreStatus(value, id);
					}
				});
			}
			//详情
			function StoreDetails(id) {
				getDataList(yshurl + "AM_GetStoreById", {
					storeId: id
				}, function(d) {
					$("#md_dpbh").text(d.aaData[0].Id);
					$("#md_dpmc").text(d.aaData[0].StoreName);
					$("#md_dpbt").text(d.aaData[0].StoreTop);
					$("#md_dpms").text(d.aaData[0].Description);
					$("#md_ssqd").text(d.aaData[0].ChannelName);
					$("#md_zrr").text(d.aaData[0].Legal_Represent);
					$("#md_lxdh").text(d.aaData[0].Tel);
					$("#md_kdsj").text(d.aaData[0].SetupTimeSTR);
					$("#md_dpzcsj").text(d.aaData[0].JoinTimeSTR);
					$("#md_dpzt").text(d.aaData[0].datastatus);
					$("#md_incd").text(d.aaData[0].InviteCode);
					if(d.aaData[0].Merchant_Id > 0) {
						$("#md_bazt").text('已备案');
						if(d.aaData[0].StoreStatus == 0) {
							$("#btn_examine").hide();
						} else {
							$("#btn_examine").show();
						}
					} else {
						$("#md_bazt").text('未备案');
						$("#btn_examine").hide();
					}
				});
				$('#myModal').modal('show');
			}

			//点击编辑
			function editdetail(id) {
				getDataList(yshurl + "AM_GetStoreById", {
					storeId: id
				}, function(d) {
					$("#edit_dpbh").text(d.aaData[0].Id);
					$("#edit_dpmc").val(d.aaData[0].StoreName);
					$("#edit_dpbt").val(d.aaData[0].StoreTop);
					$("#edit_dpms").val(d.aaData[0].Description);
				});
				$('#EditModal').modal('show');
			}
			//保存编辑
			$("#btn_save").click(function() {
				$('#sub_form').data('bootstrapValidator').validate();
				if($("#sub_form").data('bootstrapValidator').isValid()) {
					var data = {
						StoreName: $("#edit_dpmc").val(),
						StoreTop: $("#edit_dpbt").val(),
						Description: $("#edit_dpms").val(),
						storeId: $("#edit_dpbh").text()
					};
					getDataList(yshurl + "AM_UpdateStoreById", data, function(d) {
						ysh_msg('编辑成功');
						$('#EditModal').modal('hide');
						var options = $table.bootstrapTable('getOptions');
						var offset = (options.pageNumber - 1) * options.pageSize;
						getdata(offset);
					});
				}
			});
			//清空
			function Clear() {
				$("#md_dpbh").text('');
				$("#md_dpmc").text('');
				$("#md_dpbt").text('');
				$("#md_dpms").text('');
				$("#md_ssqd").text('');
				$("#md_zrr").text('');
				$("#md_lxdh").text('');
				$("#md_kdsj").text('');
				$("#md_dpzcsj").text('');
				$("#md_dpzt").text('');
				$("#edit_dpbh").text('');
				$("#edit_dpmc").val('');
				$("#edit_dpbt").val('');
				$("#edit_dpms").val('');
			}
			$('#myModal').on('hidden.bs.modal', function() {
				Clear();
			});
			$('#EditModal').on('hidden.bs.modal', function() {
				Clear();
			});
			$('#EditModal').on('hide.bs.modal', function() {
				$('#sub_form').data('bootstrapValidator').resetForm();
			});
			//批量关闭
			$("#btn_BatchShutdown").click(function() {
				if(checkList.length <= 0) {
					ysh_alert("请选中关闭项", "warning");
					return;
				}
				$.unique(checkList);
				ysh_confirm("确定要关闭选中项吗？", "确定", "取消", function(ret) {
					if(ret) {
						UpdateStoreStatus(1, checkList.join(","));
					}
				});

			});
			//批量审核
			$("#btn_BatchPass").click(function() {
				if(checkList.length <= 0) {
					ysh_alert("请选中审核项", "warning");
					return;
				}
				$.unique(checkList);
				ysh_confirm("确定要审核选中项吗？", "确定", "取消", function(ret) {
					if(ret) {
						UpdateStoreStatus(0, checkList.join(","));
					}
				});

			});
			//审核
			$("#btn_examine").click(function() {
				ysh_confirm("确定审核通过吗？", "确定", "取消", function(ret) {
					if(ret) {
						UpdateStoreStatus(0, $("#md_dpbh").text());
						$('#myModal').modal('hide');
					}
				});
			});
			//更新状态
			function UpdateStoreStatus(StoreStatus, Idlist) {
				var da = {
					StoreStatus: StoreStatus,
					Idlist: Idlist
				}
				getDataList(yshurl + "UpdateStoreStatus", da, function(d) {
					var options = $table.bootstrapTable('getOptions');
					var offset = (options.pageNumber - 1) * options.pageSize;
					getdata(offset);
					checkList = new Array();
				});
			}
			//重置
			$("#btn_Reset").click(function() {
//				$("#sel_Channel").val('0');
//				$("#sel_Status").val('-1');
				$("#sel_Channel").select2('val','0');
				$("#sel_Status").select2('val','-1');
				$("#in_Username").val('');
				$("#in_Storename").val('');
				$("#in_SetupTime").val('');
				$("#in_JoinTime").val('');
			});
			//表单验证
			$('#sub_form').bootstrapValidator({
				message: '错误',
				feedbackIcons: {
					valid: 'glyphicon glyphicon-ok',
					invalid: 'glyphicon glyphicon-remove',
					validating: 'glyphicon glyphicon-refresh'
				},
				fields: {
					edit_dpmc: {
						validators: {
							notEmpty: {
								message: '店铺名称不能为空'
							}
						}
					}
				}
			});
		</script>
	</body>

</html>