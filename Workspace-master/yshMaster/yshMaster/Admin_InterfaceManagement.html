<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="ThemeBucket">
		<link rel="shortcut icon" href="#" type="image/png">
		<title>Form Layouts</title>
		<!--pickers css-->
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datepicker/css/datepicker-custom.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-timepicker/css/timepicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-colorpicker/css/colorpicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/bootstrapValidator.css" rel="stylesheet">
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/ysh_comm.js"></script>
		<script type="text/javascript">
			checkPermission();
		</script>
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->
	</head>

	<body class="children-body">
		<!--body wrapper start-->
		<section class="">
			<!-- page start-->
			<div class="row">
				<div class="col-lg-12">
					<section class="panel">
						<header class="panel-heading">
							第三方接口管理
						</header>
						<div class="panel-body">
							<form class="form-horizontal" role="form">
								<div class="row clearfix">
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">接口名称:</label>
											<div class="col-lg-9">
												<input type="text" class="form-control" id="input_apiName">
											</div>
										</div>
									</div>
									<div class="col-lg-8">
										<div class="text-right">
											<button class="btn btn-info" type="button" id="btn_search">搜索</button>
										</div>
									</div>
								</div>
							</form>
						</div>
					</section>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<section class="panel">
						<div class="panel-heading">
							<div class="text-right">
								<button class="btn btn-success" type="button" id="btn_add">添加</button>
								<button class="btn btn-danger" type="button" id="btn_batchdelete">批量删除</button>
							</div>
						</div>
						<div class="panel-body">
							<table id="bs" class="table table-striped table-condensed table-hover talbe-border" data-side-pagination="server">
								<thead>
									<tr>
										<th data-field="status" data-align="center" data-checkbox="true"></th>
										<th data-field="Id" data-align="center">ID</th>
										<th data-field="ApiName" data-align="center">名称</th>
										<th data-field="Api" data-align="center">参数</th>
										<th data-field="ApiStatus" data-align="center">状态</th>
										<th data-field="v2" data-align="center">V2</th>
										<th data-field="key" data-align="center">键</th>
										<th data-field="value" data-align="center" data-width="20%">键值</th>
										<th data-field="type" data-align="center">类型</th>
										<th data-field="discript" data-align="center">注释</th>
										<th data-field="appendix" data-align="center">描述</th>
										<th data-field="Id" data-align="center" data-formatter="operationFormatter">操作</th>
									</tr>
								</thead>
							</table>
						</div>
						<!-- Modal -->
						<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade" data-backdrop="static">
							<div class="modal-dialog">
								<div class="modal-content">
									<div class="modal-header">
										<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
										<h4 class="modal-title">编辑接口</h4>
									</div>
									<div class="modal-body">
										<form class="form-horizontal" id="sub_form">
											<div class="form-group" id="form_ID">
												<label for="cemail" class="control-label col-lg-3">接口ID:</label>
												<div class="col-lg-8">
													<label for="cname" class="control-label" id="lbl_interfaceID" name="lbl_interfaceID"></label>
												</div>
											</div>
											<div class="form-group ">
												<label for="cemail" class="control-label col-lg-3">接口名称:</label>
												<div class="col-lg-8">
													<input class="form-control " id="interface_name" name="interface_name" />
												</div>
												<div class="col-lg-1">
													<span style="color: red;">*</span>
												</div>
											</div>
											<div class="form-group ">
												<label for="curl" class="control-label col-lg-3">接口参数:</label>
												<div class="col-lg-8">
													<input class="form-control " id="interface_Parameter" name="interface_Parameter" />
												</div>
											</div>
											<div class="form-group ">
												<label for="curl" class="control-label col-lg-3">接口状态:</label>
												<div class="col-lg-8">
													<input class="form-control " id="interface_status" name="interface_status" />
												</div>
											</div>
											<div class="form-group ">
												<label for="curl" class="control-label col-lg-3">V2:</label>
												<div class="col-lg-8">
													<input class="form-control " id="interface_v2" name="interface_v2" />
												</div>
											</div>
											<div class="form-group ">
												<label for="curl" class="control-label col-lg-3">键:</label>
												<div class="col-lg-8">
													<input class="form-control " id="interface_key" name="interface_key" />
												</div>
												<div class="col-lg-1">
													<span style="color: red;">*</span>
												</div>
											</div>
											<div class="form-group ">
												<label for="curl" class="control-label col-lg-3">键值:</label>
												<div class="col-lg-8">
													<input class="form-control " id="interface_keyvalue" name="interface_keyvalue" />
												</div>
												<div class="col-lg-1">
													<span style="color: red;">*</span>
												</div>
											</div>
											<div class="form-group ">
												<label for="curl" class="control-label col-lg-3">接口类型:</label>
												<div class="col-lg-8">
													<input class="form-control " id="interface_type" name="interface_type" />
												</div>
												<div class="col-lg-1">
													<span style="color: red;">*</span>
												</div>
											</div>
											<div class="form-group ">
												<label for="curl" class="control-label col-lg-3">接口注释:</label>
												<div class="col-lg-8">
													<input class="form-control " id="interface_discript" name="interface_discript" />
												</div>
											</div>
											<div class="form-group ">
												<label for="curl" class="control-label col-lg-3">接口描述:</label>
												<div class="col-lg-8">
													<input class="form-control " id="interface_Des" name="interface_Des" />
												</div>
											</div>
										</form>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-success" id="btn_save">保存</button>
										<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
									</div>
								</div>
							</div>
						</div>
						<!-- modal -->
					</section>
					<!--body wrapper end-->
				</div>
				<!-- main content end-->
			</div>
		</section>
		<!-- Placed js at the end of the document so the pages load faster -->
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
		<script src="js/jquery-migrate-1.2.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/modernizr.min.js"></script>
		<script src="js/jquery.nicescroll.js"></script>
		<!--pickers plugins-->
		<script type="text/javascript" src="js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/moment.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/daterangepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>
		<!--bootstrap Table-->
		<script src='js/bootstrap-table.js'></script>
		<script src='js/bootstrap-table-zh-CN.js'></script>
		<script src='js/bootstrap-editable.js'></script>
		<script src='js/bootstrap-table-editable.js'></script>
		<!--pickers initialization-->
		<script src="js/pickers-init.js"></script>
		<!--common scripts for all pages-->
		<script src="js/scripts.js"></script>
		<script src="js/ysh_comm.js"></script>
		<script src="js/layer.js"></script>
		<script src="js/bootstrapValidator.js"></script>
		<script>
			var checkList = new Array();
			var $table = $("#bs");
			var totalcount = 0;
			$(document).ready(function() {
				leftCancelShade('myModal');
				checkList = new Array();
				$table.bootstrapTable({
					pagination: true, //分页
					//data: data,
					onCheck: function(row) {
						checkList.push(row.Id);
						$.unique(checkList);
						console.log(checkList);
					},
					onUncheck: function(row) {
						$.unique(checkList);
						var pIndex = $.inArray(row.Id, checkList);
						checkList.splice(pIndex, 1);
						console.log(checkList);
					},
					onCheckAll: function(rows) {
						$.each(rows, function(index) {
							checkList.push(rows[index].Id);
						});
						$.unique(checkList);
						console.log(checkList);
					},
					onUncheckAll: function(rows) {
						checkList = new Array();
						console.log(checkList);
					},
					escape: true,
					pageList: [10]
				});
				var options = $table.bootstrapTable('getOptions');
				getdata(options.pageSize, 0);
			});
			//表单验证
			$('#sub_form').bootstrapValidator({
				message: '错误',
				feedbackIcons: {
					valid: 'glyphicon glyphicon-ok',
					invalid: 'glyphicon glyphicon-remove',
					validating: 'glyphicon glyphicon-refresh'
				},
				fields: {
					interface_name: {
						validators: {
							notEmpty: {
								message: '接口名称不能为空'
							}
						}
					},
					interface_status: {
						validators: {
							integer: {
								message: '接口状态必须为数字'
							}
						}
					},
					interface_type: {
						validators: {
							integer: {
								message: '键必须为数字'
							},
							notEmpty: {
								message: '键不能为空'
							}
						}
					},
					interface_key: {
						validators: {
							notEmpty: {
								message: '键值不能为空'
							}
						}
					},
					interface_keyvalue: {
						validators: {
							notEmpty: {
								message: '接口类型不能为空'
							}
						}
					}
				}
			});
			//表格样式
			function rowStyle(row, index) {
				var classes = ['active', 'success', 'info', 'warning', 'danger'];
				if(index % 2 === 0) {
					return {
						classes: 'warning'
					};
				} else
					return {
						classes: 'info'
					};
			}
			//搜索
			$("#btn_search").click(function() {
				var options = $table.bootstrapTable('getOptions');
				getdata(options.pageSize, 0);
				//getdata();
			});
			//添加
			$("#btn_add").click(function() {
				$(".modal-title").text('添加接口');
				$("#form_ID").hide();
				$('#myModal').modal('show');
			});
			//保存
			$("#btn_save").click(function() {
				$('#sub_form').data('bootstrapValidator').validate();
				if($("#sub_form").data('bootstrapValidator').isValid()) {
					var id = $("#lbl_interfaceID").text();
					var da = {
						ApiName: $("#interface_name").val(),
						Api: $("#interface_Parameter").val(),
						ApiStatus: $("#interface_status").val(),
						v2: $("#interface_v2").val(),
						KEY: $("#interface_key").val(),
						VALUE: $("#interface_keyvalue").val(),
						TYPE: $("#interface_type").val(),
						discript: $("#interface_discript").val(),
						appendix: $("#interface_Des").val()
					}
					if(id == '') { //新增
						getDataList(yshurl + "UC_InsertApi", da, function(d) {
							$('#myModal').modal('hide');
							var options = $table.bootstrapTable('getOptions');
							getdata(options.pageSize, 0);
							//getdata();
						});
					} else { //修改
						da.apiId = id;
						getDataList(yshurl + "UC_UpdateApi", da, function(d) {
							$('#myModal').modal('hide');
							var options = $table.bootstrapTable('getOptions');
							var offset = (options.pageNumber - 1) * options.pageSize;
							getdata(options.pageSize, offset);
							//getdata();
						});
					}
					ysh_msg("保存成功");
				}
			});

			function selectListFormatter(value, row, index) {
				if(value != null && value != undefined) {
					var sl = ["<select id='Id", row.Id, "' class='selectForMobile' >"];
					$.each(value, function(i, v) {
						sl.push("<option value='" + v.value + "' >" + v.text + "</option>");
					});
					sl.push("</select>")
					return sl.join('');
				} else return "";
			}

			function operationFormatter(value, row, index) {
				var result = [
					'<button onclick="gotoEdit(' + value + ')" class="btn btn-info">编辑</button>', '<button type="button" onclick="DeleteApi(' + value + ')" class="btn btn-danger">删除</button>'
				];
				return result.join(' ');
			}
			//编辑
			function gotoEdit(Id) {
				getDataList(yshurl + "UC_GetApiByID", {
					apiId: Id
				}, function(d) {
					$(".modal-title").text('编辑接口');
					$("#form_ID").show();
					$("#lbl_interfaceID").text(d.aaData[0].Id);
					$("#interface_name").val(d.aaData[0].ApiName);
					$("#interface_Parameter").val(d.aaData[0].Api);
					$("#interface_Des").val(d.aaData[0].appendix);
					$("#interface_status").val(d.aaData[0].ApiStatus);
					$("#interface_v2").val(d.aaData[0].v2);
					$("#interface_key").val(d.aaData[0].key);
					$("#interface_keyvalue").val(d.aaData[0].value);
					$("#interface_type").val(d.aaData[0].type);
					$("#interface_discript").val(d.aaData[0].discript);
					$('#myModal').modal('show');
				});
			}
			//删除
			function DeleteApi(id) {
				ysh_confirm("确定要删除吗？", "确定", "取消", function(ret) {
					if(ret) {
						getDataList(yshurl + "UC_DelApi", {
							IdList: id
						}, function(d) {
							var options = $table.bootstrapTable('getOptions');
							getdata(options.pageSize, 0);
							ysh_msg("删除成功");
							//getdata();
						});
					}
				});
			}
			$("#btn_batchdelete").click(function() {
				if(checkList.length <= 0) {
					ysh_alert("请选中删除项", "warning");
					return;
				}
				ysh_confirm("确定要删除选中项吗？", "确定", "取消", function(ret) {
					if(ret) {
						DeleteAllApi(checkList.join(","));
						checkList = new Array();
					}
				});
			});
			//批量删除
			function DeleteAllApi(idlist) {
				getDataList(yshurl + "UC_DelApi", {
					IdList: idlist
				}, function(d) {
					var options = $table.bootstrapTable('getOptions');
					getdata(options.pageSize, 0);
					ysh_msg("删除成功");
					//getdata();
				});
			}
			//清空
			function clear() {
				$("#lbl_interfaceID").text('');
				$("#interface_name").val('');
				$("#interface_Parameter").val('');
				$("#interface_Des").val('');
				$("#interface_status").val('');
				$("#interface_v2").val('');
				$("#interface_key").val('');
				$("#interface_keyvalue").val('');
				$("#interface_type").val('');
				$("#interface_discript").val('');
			}
			$('#myModal').on('hidden.bs.modal', function() {
				clear();
			});
			$('#myModal').on('hide.bs.modal', function() {
				$('#sub_form').data('bootstrapValidator').resetForm();
			});
			
			//表格加载数据
			function loadData(f1, data) {
				f1.bootstrapTable('load', data);
				var hashTemp = window.location.hash || "1"

				hashTemp = hashTemp.replace("#", "")
				$(".pagination").find('a').each(function() {
					if($(this).text() == hashTemp)
						$(this).click()
				})
			};
			
			//获取数据
			var getdata = function(limit, offset) {
				var data = new Array();
				condition = {
					ApiName: $("#input_apiName").val()
				}
				condition.limit = limit;
				condition.offset = offset;
				var options = $table.bootstrapTable('getOptions');
				if(offset == 0) {
					options.pageNumber = 1;
					$table.bootstrapTable('refreshOptions', options);
				}
				getDataList(yshurl + "UC_GetOtherApi", condition, function(d) {
					data = d.many[0];
					totalcount = d.many[1][0].totalcount;
				});
				var pdata = {
					total: totalcount,
					rows: data
				};
				loadData($table, pdata);
				setIframeHeight();
			}
			
			//分页控制
			$table.on('page-change.bs.table', function(e, number, size) {
				var os = (number - 1) * size;
				var lm = size;
				window.location.hash = number;
				getdata(lm, os);
			});
			
			// onhashchange可以监控hash变化
		    window.onhashchange = function() {
		        var hash = window.location.hash;
		        var id;
		        if(hash != ""){
		        	id = parseInt(hash.substr(1));
		        } else{
		        	id = 1
		        }
		        getdata(10, (id-1)*10);
		        console.info(hash)
		       	$("ul.pagination").children().eq(id).addClass("active").siblings().removeClass("active");
		    };
		</script>
	</body>

</html>