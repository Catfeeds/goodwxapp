<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="ThemeBucket">
		<link rel="shortcut icon" href="#" type="image/png">
		<title>订单管理</title>
		<link rel="stylesheet" href="css/bootstrap-responsive.min.css" />
		<link rel="stylesheet" href="css/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datepicker/css/datepicker-custom.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-timepicker/css/timepicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-colorpicker/css/colorpicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/bootstrapValidator.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/select2.min.css"/>
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/ysh_comm.js"></script>
		<!--adddate-->
		<script src="js/adddate.js"></script>

		
		<script type="text/javascript">
			checkPermission();
		</script>
	</head>

	<body style="background: #EFF0F4;">
		<section>
			<div>
				<section class="panel">
					<div class="panel-body">
						<div class="page-heading">
							<h3>订单列表</h3>
						</div>
					</div>
				</section>

				<section class="wrapper">
					<section class="panel">
						<div class="panel-body">
							
							<div class="row">
								<div class="col-lg-3">
									<div class="m-bot15" style="width: 100%;">
										<input type="text" class="form-control" placeholder="商品名称" id="proName">
									</div>
								</div>
								<div class="col-lg-1" style="text-align: right;padding-top: 7px;">成交时间</div>
								<div class="col-lg-3">
									<!--<div data-date-viewmode="years" data-date-format="yyyy-mm-dd" data-date="" class="input-append date dpYears">
										<input type="text" readonly="" size="16" class="form-control" name="StartTime" id="dealTimeStart">
										<span class="input-group-btn add-on">
											<button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
									  	</span>
									</div>-->
									<input type="text" size="16" class="form-control" name="StartTime" id="dealTimeStart" onclick="SelectDate(this,'yyyy-MM-dd')"/>
								</div>
								<div class="col-lg-1" style="text-align: center;">
									<label style="padding-top: 7px;">到</label>
								</div>
								<div class="col-lg-3">
									<!--<div data-date-viewmode="years" data-date-format="yyyy-mm-dd" data-date="" class="input-append date dpYears">
										<input type="text" readonly="" size="16" class="form-control" name="StartTime" id="dealTimeEnd">
										<span class="input-group-btn add-on">
											<button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
									  	</span>
									</div>-->
									<input type="text" size="16" class="form-control" name="StartTime" id="dealTimeEnd" onclick="SelectDate(this,'yyyy-MM-dd')"/>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-3">
									<div class=" m-bot15" style="width: 100%;">
										<input type="text" class="form-control" placeholder="买家姓名" id="buyerName">
									</div>
								</div>
								<div class="col-lg-1" style="text-align: right;padding-top: 7px;">订单状态</div>
								<div class="col-lg-3">
									<select class="form-control m-bot15" id="orderStatu">
										<option value="0">全部</option>
										<option value="10">未处理</option>
										<option value="20">处理</option>
										<option value="30">完成</option>
										<option value="40">已取消</option>
									</select>
								</div>
							</div>
							
							<div class="row">
								<div class="col-lg-3">
									<div class=" m-bot15" style="width: 100%;">
										<input type="text" class="form-control" placeholder="订单编号" id="orderNumber">
									</div>
								</div>
								<div class="col-lg-1" style="text-align: right;padding-top: 7px;">付款状态</div>
								<div class="col-lg-3">
									<select class="form-control m-bot15" id="commetLv">
										<option value="0">全部</option>
										<option value="10">等待付款</option>
										<option value="20">授权</option>
										<option value="30">已付款</option>
										<option value="35">部分退款</option>
										<option value="40">已退款</option>
										<option value="50">无效的</option>
										<option value="60">货到付款</option>
									</select>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-3">
									<div class="m-bot15" style="width: 100%;">
										<input type="text" class="form-control" placeholder="收货人" id="consignee">
									</div>
								</div>
								<div class="col-lg-1" style="text-align: right;padding-top: 7px;">物流状态</div>
								<div class="col-lg-3">
									<select class="form-control m-bot15" id="logistics_Statu">
										<option value="0">全部</option>
										<option value="10">未发货</option>
										<option value="20">已发货</option>
										<option value="30">确认收货</option>
										<option value="35">延迟收货</option>
									</select>
								</div>
							</div>
							<div class="row">
								<div class="col-lg-8"></div>
								<div class="col-lg-1">
									<button class="btn btn-success" type="button" onclick="javascript:getExcle()">导出Excle</button>
								</div>
								<div class="col-lg-1">
									<button class="btn btn-info" type="button" id="btnSearch">搜索</button>
								</div>
								<div class="col-lg-2">
									<button class="btn btn-danger" type="button" id="btn_Reset">重置</button>
									<button class="btn btn-danger" type="button" id="btnDel">删除</button>
									
								</div>
							</div>
						</div>
					</section>

					<section class="panel">
						<div class="panel-body">
							<table class="table table-bordered table-striped table-condensed ysh_table" id="orderTable">
								<thead>
									<tr>
										<th>买家姓名</th>
										<th>支付单号</th>
										<th>订单号</th>
										<th>成交时间</th>
										<th>收货人</th>
										<th>订单金额</th>
										<th>商品种类</th>
										<th>总下单数</th>
										<th>付款状态</th>
										<th>详情</th>
										<th>订单状态</th>
										<th>物流状态</th>
										<th>选定</th>
									</tr>
								</thead>
								<tbody id="orderTableBody">

								</tbody>
							</table>
							<div style="display: none;">
								<table class="table table-bordered table-striped table-condensed ysh_table" id="orderTable1">
									<thead>
										<tr>
											<th>买家姓名</th>
											<th>支付单号</th>
											<th>订单号</th>
											<th>成交时间</th>
											<th>收货人</th>
											<th>订单金额</th>
											<th>商品种类</th>
											<th>总下单数</th>
											<th>付款状态</th>
											<th>详情</th>
											<th>订单状态</th>
											<th>物流状态</th>
											<th>选定</th>
										</tr>
									</thead>
									<tbody id="orderTableBody2">

									</tbody>
								</table>
							</div>
							<div style="height: 30px;">总共<span id="pageTotal"></span>页，<span id="itemTotal"></span>条记录，每页显示20条</div>
							<div style="text-align: right;">
								<ul class="pagination pagination-lg" id="paginator">

								</ul>
							</div>
						</div>
					</section>
				</section>
			</div>
		</section>

		<div class="pull-left"></div>
		<script type="text/html" id="tplTable">
			{{# for(var i in d){}}
			<tr>
				<td>{{d[i].Username||"空"}}</td>
				<td style="mso-number-format:'\@';">{{d[i].PayNumber||"无支付单号"}}</td>
				<td style="mso-number-format:'\@';">{{d[i].OrderNumber||"无订单号"}}</td>
				<td>{{new Date(d[i].CreatedOnUtc).Format("yyyy-MM-dd hh:mm:ss")}}</td>
				<td>{{d[i].Person}}</td>
				<td>{{d[i].OrderTotal+d[i].TransFee}}元</td>
				<td>{{d[i].ItemCount}}</td>
				<td>{{d[i].ItemWeight}}</td>
				<td>{{d[i].PaymentStatusName}}</td>
				<td>
					{{# if(d[i].OrderStatusId!=40){}}
					<a href="orderDetial.html?orderid={{d[i].Id}}" class="btn btn-info">查看</a> {{# }}}
					<td>
						{{# if(d[i].OrderStatusId==10&&d[i].PaymentStatusId!=30){}}
						<a class="order-cancel btn btn-danger">关闭交易</a> {{# }else{}}
						<span>{{d[i].OrderStatusName}}</span> {{# }}}
					</td>
					<td>
						<span>{{d[i].ItemCountNum}}|{{d[i].ItemCount}}</span>
					</td>
					<td>
						{{# if(d[i].OrderStatusId==40){}}
						<input type="checkbox" class="order-item-check" /> {{# }}}
					</td>
					<input type="hidden" value="{{d[i].Id}}" class="order-id" />
			</tr>
			{{# }}}
		</script>

		<!-- Placed js at the end of the document so the pages load faster -->
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
		<script src="js/jquery-migrate-1.2.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/modernizr.min.js"></script>
		<script src="js/jquery.nicescroll.js"></script>
		<script src="js/laytpl.js"></script>
		<script src="js/ysh_comm.js"></script>

		<!--bootstrap Table-->
		<script src='js/bootstrap-table.js'></script>
		<script src='js/bootstrap-table-zh-CN.js'></script>
		<script src='js/bootstrap-editable.js'></script>
		<script src='js/bootstrap-table-editable.js'></script>

		<!--pickers plugins-->
		<script type="text/javascript" src="js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/moment.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/daterangepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>
		<script type="text/javascript" src="js/bootstrapValidator.js"></script>
		<script src="js/bootstrap-paginator.min.js"></script>
		<script src="js/layer.js"></script>

		<!--pickers initialization-->
		<script src="js/pickers-init.js"></script>

		<!--common scripts for all pages-->
		<script src="js/scripts.js"></script>
		<script src="script/orderList.js"></script>
		<script src="js/select2.min.js"></script>
		
		<script>
			function showPage(page, total) {
				var str = '<li><a href="#" class="page-number">' + page + '</a></li>';
				for(var i = 1; i <= 3; i++) {
					if(page - i > 1) {
						str = '<li><a href="#" class="page-number">' + (page - i) + '</a></li>' + str;
					}
					if(page + i < total) {
						str = str + ' ' + '<li><a href="#" class="page-number">' + (page + i) + '</a></li>';
					}
				}

				if(page - 4 > 1) {
					str = '<li><a href="javascript:;">...</a></li>' + str;
				}

				if(page > 1) {
					str = '<li><a href="#" id="toLastPage">&laquo;</a></li> ' + '<li><a href="#" class="page-number">1</a></li>' + str;
				}

				if(page + 4 < total) {
					str = str + '<li><a href="javascript:;">...</a></li>';
				}

				if(page < total) {
					str = str + '<li><a href="#" class="page-number">' + total + '</a></li>' + '<li><a href="#" id="toNextPage">&raquo;</a></li>';
				}

				return str;
			}

			$(document).ready(function() {
				$('select').select2();
				setIframeHeight();
				var hash = window.location.hash;
				
				var pageIndex = parseInt(hash.substr(1,1)) - 1;
				var consignee = $("#consignee").val() || "";
				var proName = $("#proName").val() || "";
				var buyerName = $("#buyerName").val() || "";
				var orderNumber = $("#orderNumber").val() || "";
				var dealTimeStart = $("#dealTimeStart").val() || "";
				var dealTimeEnd = $("#dealTimeEnd").val() || "";
				var orderStatuId = $("#orderStatu").val() || 0;
				var commentLv = $("#commetLv").val() || 0;
				var ShippingStatusId = $("#logistics_Statu").val() || 0;
//				var pageIndex = 0;
				var pageTotal;
				//init
				getDataList(yshurl + "GetOrderList", {
						ProductName: proName,
						UserName: buyerName,
						OrderNumber: orderNumber,
						CreatedOnUtcStart: dealTimeStart,
						CreatedOnUtcEnd: dealTimeEnd,
						OrderStatusId: orderStatuId,
						Rate: 0,
						PaymentStatusId: commentLv,
						PageIndex: 0,
						PageSize: 20,
						buyerName: consignee,
						ShippingStatusId: ShippingStatusId
					}, function(d) {
						if(d && d.state == 0) {
							if(d.aaData.length > 0 && d.aaData[0].length > 0) {
								$.each(d.aaData[0],function(i,v){
									if(v.Person == null){
										v.Person = "暂无"
									}
								})
								laytpl($("#tplTable").html()).render(d.aaData[0], function(html) {
									$("#orderTableBody").html(html);
								});
								pageTotal = Math.ceil(d.aaData[1][0].$RowCount / 20);
								$("#pageTotal").text(pageTotal);
								$("#itemTotal").text(d.aaData[1][0].$RowCount);
								$("#paginator").html(showPage(1, pageTotal));
								$(".page-number:first").parent().addClass("active");
							} else {
								$("#orderTableBody").html("");
								$("#paginator").html("");
								ysh_msg("暂无搜索结果");
							}
						} else {
							ysh_msg("暂无搜索结果");
							//ysh_msg("服务器出错:" + d.state + d.msg);
						}
						setIframeHeight();
					})
					//bindEvent
				$(document).on("click", "#btnSearch", function() {
					consignee = $("#consignee").val() || "",
					proName = $("#proName").val() || "";
					buyerName = $("#buyerName").val() || "";
					orderNumber = $("#orderNumber").val() || "";
					dealTimeStart = $("#dealTimeStart").val() || "";
					dealTimeEnd = $("#dealTimeEnd").val() || "";
					orderStatuId = $("#orderStatu").val() || 0;
					commentLv = $("#commetLv").val() || 0;
					ShippingStatusId = $("#logistics_Statu").val() || 0,
					
					pageIndex = 0;
					getDataList(yshurl + "GetOrderList", {
						ProductName: proName,
						UserName: buyerName,
						OrderNumber: orderNumber,
						CreatedOnUtcStart: dealTimeStart,
						CreatedOnUtcEnd: dealTimeEnd,
						OrderStatusId: orderStatuId,
						PaymentStatusId: commentLv,
						Rate: 0,
						PageIndex: pageIndex,
						PageSize: 20,
						buyerName: consignee,
						ShippingStatusId: ShippingStatusId
					}, function(d) {
						//						console.log(d);
						var pageTotal = Math.ceil(d.aaData[1][0].$RowCount / 20);
						if(d && d.state == 0) {
							if(d.aaData.length > 0 && d.aaData[0].length > 0) {
								$.each(d.aaData[0],function(i,v){
									if(v.Person == null){
										v.Person = "暂无"
									}
								})
								laytpl($("#tplTable").html()).render(d.aaData[0], function(html) {
									$("#orderTableBody").html(html);
								});
								$("#paginator").html(showPage(pageIndex + 1, pageTotal));
								$(".page-number:first").parent().addClass("active");
								$("#pageTotal").text(pageTotal);
								$("#itemTotal").text(d.aaData[1][0].$RowCount);
							} else {
								$("#orderTableBody").html("");
								$("#paginator").html("");
								ysh_msg("暂无搜索结果");
								$("#pageTotal").text(pageTotal);
								$("#itemTotal").text(d.aaData[1][0].$RowCount);
							}

						} else {
							ysh_msg("暂无搜索结果");
							//ysh_msg("服务器出错:" + d.state + d.msg);
						}
						setIframeHeight();
					})
				}).on("click", "#btnDel", function() {
					var el = $(".order-item-check:checked");
					if(el && el.length > 0) {
						var orderId = "";
						el.each(function() {
							orderId += $(this).parent().parent().find(".order-id").val() + ",";
						})
						ysh_confirm("确定要删除吗？", "确定", "取消", function(ret) {
							if(ret) {
								getDataList(yshurl + "DelOrder", {
									orderid: orderId.slice(0, orderId.length - 1)
								}, function(d) {
									//									console.log(d);
									if(d && d.state == 0) {
										el.each(function() {
											$(this).parent().parent().remove();
										});
										ysh_msg("删除成功")
									} else {
										ysh_msg("操作失败" + d.msg + d.state);
									}
									setIframeHeight();
								})
							}
						});
					} else {
						ysh_msg("请选择你要删除的订单")
					}
				}).on("click", ".order-cancel", function() {
					var orderId = $(this).parent().parent().find(".order-id").val(),
						el = $(this);
					ysh_confirm("确定要取消订单吗？", "确定", "取消", function(ret) {
						if(ret) {
							getDataList(yshurl + "CancelOrder", {
								OrderId: orderId
							}, function(d) {
								if(d && d.state == 0) {
									ysh_msg("取消成功");
									window.location.reload()
										//									var html = '<span>交易已取消</span>';
										//									el.parent().html(html);
								} else {
									ysh_msg("操作失败" + d.msg + d.state);
								}
								setIframeHeight();
							})
						}
					});
				}).on("click", ".page-number", function() {
					var el = this;
					window.location.hash = ($(el).text());
					pageIndex = parseInt(window.location.hash.substr(1,10000000)) -1;
					
					getDataList(yshurl + "GetOrderList", {
						ProductName: proName,
						UserName: buyerName,
						OrderNumber: orderNumber,
						CreatedOnUtcStart: dealTimeStart,
						CreatedOnUtcEnd: dealTimeEnd,
						OrderStatusId: orderStatuId,
						PaymentStatusId: commentLv,
						Rate: 0,
						PageIndex: pageIndex,
						PageSize: 20,
						buyerName: consignee,
						ShippingStatusId: ShippingStatusId
					}, function(d) {
						var pageTotal = Math.ceil(d.aaData[1][0].$RowCount / 20);
						$.each(d.aaData[0],function(i,v){
							if(v.Person == null){
								v.Person = "暂无"
							}
						})
						laytpl($("#tplTable").html()).render(d.aaData[0], function(html) {
							$("#orderTableBody").html(html);
						});
						$("#paginator").html(showPage(pageIndex + 1, pageTotal));
						$(".page-number").parent().removeClass("active");
						$(".page-number").each(function() {
							if($(this).text() == (pageIndex + 1)) {
								$(this).parent().addClass("active");
							}
						});
						$("#pageTotal").text(pageTotal);
						$("#itemTotal").text(d.aaData[1][0].$RowCount);
						setIframeHeight();
					})
				}).on("click", "#toLastPage", function() {
					if(pageIndex > 0) {
						pageIndex = pageIndex - 1;
						getDataList(yshurl + "GetOrderList", {
							ProductName: proName,
							UserName: buyerName,
							OrderNumber: orderNumber,
							CreatedOnUtcStart: dealTimeStart,
							CreatedOnUtcEnd: dealTimeEnd,
							OrderStatusId: orderStatuId,
							PaymentStatusId: commentLv,
							Rate: 0,
							PageIndex: pageIndex,
							PageSize: 20,
							buyerName: consignee,
							ShippingStatusId: ShippingStatusId
						}, function(d) {
							var pageTotal = Math.ceil(d.aaData[1][0].$RowCount / 20);
							$.each(d.aaData[0],function(i,v){
								if(v.Person == null){
									v.Person = "暂无"
								}
							})
							laytpl($("#tplTable").html()).render(d.aaData[0], function(html) {
								$("#orderTableBody").html(html);
							});
							$("#paginator").html(showPage(pageIndex + 1, pageTotal));
							$(".page-number").parent().removeClass("active");
							$(".page-number").each(function() {
								if($(this).text() == (pageIndex + 1)) {
									$(this).parent().addClass("active");
								}
							});
							$("#pageTotal").text(pageTotal);
							$("#itemTotal").text(d.aaData[1][0].$RowCount);
							setIframeHeight();
						})
					}
				}).on("click", "#toNextPage", function() {
					if(pageIndex < pageTotal - 1) {
						pageIndex = pageIndex + 1;
						getDataList(yshurl + "GetOrderList", {
							ProductName: proName,
							UserName: buyerName,
							OrderNumber: orderNumber,
							CreatedOnUtcStart: dealTimeStart,
							CreatedOnUtcEnd: dealTimeEnd,
							OrderStatusId: orderStatuId,
							PaymentStatusId: commentLv,
							Rate: 0,
							PageIndex: pageIndex,
							PageSize: 20,
							buyerName: consignee,
							ShippingStatusId: ShippingStatusId
							
						}, function(d) {
							var pageTotal = Math.ceil(d.aaData[1][0].$RowCount / 20);
							$.each(d.aaData[0],function(i,v){
								if(v.Person == null){
									v.Person = "暂无"
								}
							})
							laytpl($("#tplTable").html()).render(d.aaData[0], function(html) {
								$("#orderTableBody").html(html);
							});
							$("#paginator").html(showPage(pageIndex + 1, pageTotal));
							$(".page-number").parent().removeClass("active");
							$(".page-number").each(function() {
								if($(this).text() == (pageIndex + 1)) {
									$(this).parent().addClass("active");
								}
							});
							$("#pageTotal").text(pageTotal);
							$("#itemTotal").text(d.aaData[1][0].$RowCount);
							setIframeHeight();
						})
					}
				}).on("click","#btn_Reset",function(){
					//重置
					$("#consignee").val('');
					$("#proName").val('');
					$("#buyerName").val('');
					$("#orderNumber").val('');
					$("#dealTimeStart").val('');
					$("#dealTimeEnd").val('');
					$("#orderStatu").select2('val','0');
					$("#commetLv").select2('val','0');
					$("#logistics_Statu").select2('val','0');
				})
			});
			
			
//		 	window.onhashchange = function() {
//	 			var hash = window.location.hash;
//				
//				var pageIndex = parseInt(hash.substr(1,1)) - 1;
//				var consignee = $("#consignee").val() || "";
//				var proName = $("#proName").val() || "";
//				var buyerName = $("#buyerName").val() || "";
//				var orderNumber = $("#orderNumber").val() || "";
//				var dealTimeStart = $("#dealTimeStart").val() || "";
//				var dealTimeEnd = $("#dealTimeEnd").val() || "";
//				var orderStatuId = $("#orderStatu").val() || 0;
//				var commentLv = $("#commetLv").val() || 0;
//				var ShippingStatusId = $("#logistics_Statu").val() || 0;
////				var pageIndex = 0;
//				var pageTotal;
//				//init
//				getDataList(yshurl + "GetOrderList", {
//					ProductName: proName,
//					UserName: buyerName,
//					OrderNumber: orderNumber,
//					CreatedOnUtcStart: dealTimeStart,
//					CreatedOnUtcEnd: dealTimeEnd,
//					OrderStatusId: orderStatuId,
//					Rate: 0,
//					PaymentStatusId: commentLv,
//					PageIndex: 0,
//					PageSize: 20,
//					buyerName: consignee,
//					ShippingStatusId: ShippingStatusId
//				}, function(d) {
//					if(d && d.state == 0) {
//						if(d.aaData.length > 0 && d.aaData[0].length > 0) {
//							$.each(d.aaData[0],function(i,v){
//								if(v.Person == null){
//									v.Person = "暂无"
//								}
//							})
//							laytpl($("#tplTable").html()).render(d.aaData[0], function(html) {
//								$("#orderTableBody").html(html);
//							});
//							pageTotal = Math.ceil(d.aaData[1][0].$RowCount / 20);
//							$("#pageTotal").text(pageTotal);
//							$("#itemTotal").text(d.aaData[1][0].$RowCount);
//							$("#paginator").html(showPage(1, pageTotal));
//							$(".page-number:first").parent().addClass("active");
//						} else {
//							$("#orderTableBody").html("");
//							$("#paginator").html("");
//							ysh_msg("暂无搜索结果");
//						}
//					} else {
//						ysh_msg("暂无搜索结果");
//						//ysh_msg("服务器出错:" + d.state + d.msg);
//					}
//					setIframeHeight();
//				})
//		 	}
		</script>
	</body>

</html>