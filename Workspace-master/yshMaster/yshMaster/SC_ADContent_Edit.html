<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="ThemeBucket">
		<link rel="shortcut icon" href="#" type="image/png">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>广告内容管理</title>
		<!--pickers css-->
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datepicker/css/datepicker-custom.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-timepicker/css/timepicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-colorpicker/css/colorpicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/fm.selectator.jquery.css" rel="stylesheet">
		<link rel="stylesheet" href="css/uploadifive.css" ref="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/select2.min.css"/>
		
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
			  <script src="js/html5shiv.js"></script>
			  <script src="js/respond.min.js"></script>
			  <![endif]-->
		<!-- Placed js at the end of the document so the pages load faster -->
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
		<script src="js/jquery-migrate-1.2.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/modernizr.min.js"></script>
		<script src="js/jquery.nicescroll.js"></script>

		<!--pickers plugins-->
		<script type="text/javascript" src="js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/moment.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/daterangepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>

		<!--bootstrap Table-->
		<script src='js/bootstrap-table.js'></script>
		<script src='js/bootstrap-table-zh-CN.js'></script>
		<script src='js/bootstrap-editable.js'></script>
		<script src='js/bootstrap-table-editable.js'></script>

		<!--pickers initialization-->
		<script src="js/pickers-init.js"></script>

		<!--common scripts for all pages-->
		<script src="js/layer.js"></script>
		<script src="js/scripts.js"></script>
		<script src="js/ysh_comm.js"></script>
		<script src="js/MD5.js"></script>
		<script src="js/select2.min.js"></script>
		

		<!--bootStrap Validator-->
		<script type="text/javascript" src="js/bootstrapValidator.js"></script>

		<!--selectList-->
		<script type="text/javascript" src="js/fm.selectator.jquery.js"></script>

		<script type="text/javascript" src="js/jquery.uploadifive.min.js"></script>
		<!--adddate-->
		<script src="js/adddate.js"></script>
		<script type="text/javascript">
			checkPermission();
		</script>
	</head>

	<body class="children-body">
		<section>
			<div>
				<section class="panel">
					<div class="panel-body">
						<div class="page-heading">
							<h3 id="HT"></h3>
						</div>
					</div>
				</section>

				<section>
					<section class="panel">
						<header class="panel-heading custom-tab turquoise-tab">
							<ul class="nav nav-tabs">

								<li class="active">
									<a data-toggle="tab" href="#info">
										广告信息
									</a>
								</li>

								<!--<li id="showPos">
									<a data-toggle="tab" href="#position">
										播放位
									</a>
								</li>-->
							</ul>
						</header>

						<div class="panel-body">
							<div class="tab-content">
								<div id="info" class="tab-pane active">
									<form class="form-horizontal" role="form" id="condition">

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>关联类型:</span>
											</div>
											<div class="col-lg-3">
												<select class="form-control m-bot15" id="LinkType" name="LinkType">
													<option value="1">关联商品</option>
													<option value="2">关联店铺</option>
													<option value="3">关联文章</option>
												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>关联商品:</span>
											</div>
											<div class="col-lg-3">
												<input type="button" class="btn btn-info" id="rProduct" value="关联商品" onclick="ChooseProduct()" />
												<p id="tProduct" name="tProduct" class="text-primary" style="margin-top: 14px;"></p>
												<input type="hidden" class="form-control" id="Product" name="Product" />
											</div>
											<div class="col-lg-3">

											</div>
										</div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>关联店铺:</span>
											</div>
											<div class="col-lg-3">
												<input type="button" class="btn btn-info" id="rStore" value="关联店铺" onclick="ChooseStore()" />
												<p id="tStore" name="tStore" class="text-primary" style="margin-top: 14px;"></p>
												<input type="hidden" class="form-control" id="Store" name="Store" />
											</div>
											<div class="col-lg-3">

											</div>
										</div>
										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>关联文章:</span>
											</div>
											<div class="col-lg-3">
												<input type="button" class="btn btn-primary" id="articleBtn" value="不可用" disabled="disabled" />
											</div>
										</div>

										<div class="row">
											<div class="col-lg-12">
												<input type="hidden" class="form-control" id="ADId" name="ADId" />
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row" id="ADdiv">
											<div class="col-lg-1" style="text-align: right;">
												<span>广告标题:</span>
											</div>
											<div class="col-lg-3">
												<input type="text" class="form-control" id="ADName" name="ADName" />
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>广告副标题:</span>
											</div>

											<div class="col-lg-3">
												<input type="text" class="form-control" id="ADTitle" name="ADTitle" />
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>广告说明:</span>
											</div>

											<div class="col-lg-3">
												<input type="text" class="form-control" id="ADexplain" name="ADexplain" />
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>广告类型:</span>
											</div>
											<div class="col-lg-3">
												<select class="form-control m-bot15" id="ADType" name="ADType">
												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>
										<div class="row" style="height: 14px;"></div>
										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>所属渠道:</span>
											</div>
											<div class="col-lg-3">
												<select class="form-control m-bot15" id="Channel" name="Channel">
												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>广告内容:</span>
											</div>
											<div class="col-lg-3">

												<div class="image_container">
													<img id="Content" name="Content" height="270" width="400" style="display: none;" />

													<input id="file_upload" name="file_upload" type="file" />
													<div id="queue"></div>

												</div>

											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>开始播放日期:</span>
											</div>
											<div class="col-lg-3">
												<!--<div data-date-viewmode="years" data-date-format="yyyy-mm-dd" data-date="" class="input-append date dpYears" id="dStartDate">
													<input type="text" readonly="" value="" size="16" class="form-control" id="StartDate" name="StartDate">
													<span class="input-group-btn add-on">
		                                <button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
		                              </span>
												</div>-->
													<input type="text" value="" size="16" class="form-control" id="StartDate" name="StartDate" onclick="SelectDate(this,'yyyy-MM-dd')"/>
												
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">

											<div class="col-lg-1" style="text-align: right;">
												<span>结束播放日期:</span>
											</div>

											<div class="col-lg-3">
												<!--<div data-date-viewmode="years" data-date-format="yyyy-mm-dd" data-date="" class="input-append date dpYears" id="dDueDate">
													<input type="text" readonly="" value="" size="16" class="form-control" id="DueDate" name="DueDate">
													<span class="input-group-btn add-on">
		                                <button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
		                              </span>
												</div>-->
													<input type="text" value="" size="16" class="form-control" id="DueDate" name="DueDate" onclick="SelectDate(this,'yyyy-MM-dd')"/>
												
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>播放频率:</span>
											</div>

											<div class="col-lg-3">
												<input type="text" class="form-control" id="Times" name="Times" value="0" />
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>链接地址:</span>
											</div>

											<div class="col-lg-3">
												<input type="text" class="form-control" id="FilePath" name="FilePath" />
											</div>
										</div>

										<div class="row" style="height: 14px;"></div>

										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>状态:</span>
											</div>
											<div class="col-lg-3">
												<select class="form-control m-bot15" id="Status" name="Status">
													<option value="正常">正常</option>
													<option value="暂停">暂停</option>
												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>
										<div class="row" style="height: 14px;"></div>
										<div class="row">
											<div class="col-lg-1" style="text-align: right;">
												<span>暂停原因:</span>
											</div>

											<div class="col-lg-3">
												<input type="text" class="form-control" id="PauseReason" name="PauseReason" />
											</div>
										</div>
										<div class="row" style="height: 14px;"></div>

										<div class="row" style="height: 14px;"></div>
										<div class="row">
											<div class="col-lg-1">

											</div>
											<div class="col-lg-3">
												<input class="btn btn-success" onclick="change()" id="confirm" type="button" value="保存" />
												<input class="btn btn-danger" onclick="redirectToList()" type="button" value="取消" />
											</div>
										</div>

									</form>

									<!-- Modal -->
									<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade">
										<div class="modal-dialog">
											<div class="modal-content">
												<form id="modalForm">
													<div class="modal-header">
														<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
														<h4 class="modal-title" id="modalTitle"></h4>
													</div>
													<div class="modal-body">
														<div class="form-horizontal">

															<div class="form-group" id="modalStore" type="hidden">
																<label for="Id" class="control-label col-lg-4">商品所在的店铺</label>
																<div class="col-lg-8">
																	<select class="form-control" id="StoreSelectList">
																	</select>
																</div>
															</div>

															<div class="form-group" id="divId">
																<label for="Id" class="control-label col-lg-4" id="modalLabel"></label>
																<div class="col-lg-8">
																	<select class="form-control" id="modalSelectList" name="">
																	</select>
																</div>
															</div>

														</div>
													</div>
													<div class="modal-footer">
														<button id="saveBtn" type="button" class="btn btn-success" onclick="saveData()">保存</button>
														<button id="closeBtn" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
													</div>
												</form>
											</div>
										</div>
									</div>
									<!-- modal -->

								</div>

								<div id="position" class="tab-pane">
									<div id="SecondStep">
										<div class="row">
											<table id="AD" class="table table-striped table-condensed table-hover talbe-border">
												<thead>
													<tr>
														<th data-field="AName" data-align="center">广告位名称</th>
														<th data-field="Remark" data-align="center">备注</th>
														<th data-field="operation" data-align="center" data-formatter="operationFormatter">操作</th>
													</tr>
												</thead>
											</table>
										</div>
										<div class="row">
											<div class="col-lg-12">
												<input type="button" class="btn btn-success" value="添加播放位" onclick="AddPosition()" />
											</div>
										</div>
									</div>
									<!-- Modal -->
									<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal2" class="modal fade">
										<div class="modal-dialog">
											<div class="modal-content">
												<form>
													<div class="modal-header">
														<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
														<h4 class="modal-title">添加播放位</h4>
													</div>
													<div class="modal-body">
														<div class="form-horizontal">
															<div class="form-group" id="divId">
																<label for="Id" class="control-label col-lg-4">广告位</label>
																<div class="col-lg-8">

																	<select class="form-control" id="modalSelectList2" class="selectator" style="width:200px;height:40px" multiple>
																	</select>
																	<input type="hidden" id="actionForModal">
																</div>
															</div>
														</div>
													</div>
													<div class="modal-footer">
														<button id="saveBtn" type="button" class="btn btn-success" onclick="SavePosition()">保存</button>
														<button id="closeBtn" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
													</div>
												</form>
											</div>
										</div>
									</div>
									<!-- modal -->

									<div id="FirstStep">
										<h6 class="text-danger">
								    <center>请添加广告内容后选择广告位</center>	
								</h6>
									</div>

								</div>

							</div>
						</div>
					</section>
				</section>
			</div>
		</section>

		<script>
			var attributes = {};
			var dataTotal = 0;
			var $form = $("#condition");
			var $table = $("#AD");
			$(document).ready(function() {
				$('#LinkType,#ADType,#Channel,#Status').select2();
				
				var back = ysh_GetQueryString("back") || null;
				var Id = ysh_GetQueryString("Id");
				var EditStyle = ysh_GetQueryString("name");
				//				EditAdInit(Id,EditStyle);
				if(back) {
					$(".active").each(function() {
						$(this).removeClass("active")
					})
					$("#showPos").addClass("active")
					$("#position").addClass("active")
				}
			})
			$('#myModal').on('show.bs.modal', function() {
				$("#modalSelectList").selectator({
					height: 'auto',
					showAllOptionsOnFocus: false,
					labels: {
						search: '查询.....' // Placeholder text in search box in single select box
					}
				});
			});
			$('#myModal').on('hide.bs.modal', function() {
				clearData();
			});
			$('#myModal2').on('hide.bs.modal', function() {
				clearData2();
			});
			$('#myModal2').on('show.bs.modal', function() {
				$('#actionForModal').click(function() {
					var $select1 = $('#select1');
					if($('#modalSelectList2').data('selectator') === undefined) {
						$('#modalSelectList2').selectator({
							showAllOptionsOnFocus: true,
							height: 'auto'
						});
						$('#actionForModal').val('destroy selectator');
					} else {
						$('#select1').selectator('destroy');
						$('#actionForModal').val('activate selectator');
					}
				});
				$('#actionForModal').click();
			});

			function EditAdInit(Id, EditStyle) {
				if(EditStyle == "Edit") {
					var ProductId = {
						CID: Id
					}
					var url = yshurl + "SC_ADContent_Edit_GetContentInfo";
					getDataList(url, ProductId, function(msn) {
						$("#ADName").val(msn.aaData[0].ADName).attr("disabled", true);
						$("#ADTitle").val(msn.aaData[0].ADTitle).attr("disabled", true);
						$("#ADexplain").val(msn.aaData[0].ADexplain).attr("disabled", true);
					})
				}
			}

			function clearData2() {
				$('#modalSelectList2').selectator('destroy');
				$("#modalSelectList2").empty();
				$('#actionForModal').off('click');
			}

			function clearData() {
				$("#modalTitle").val("");
				$("#modalSelectList").empty();
				$("#modalSelectList").selectator('destroy');
				if($("#modalLabel").text() == "关联商品") {
					$("#StoreSelectList").empty();
					$("#StoreSelectList").selectator('destroy');
				}
				$("#modalLabel").text("");
				$("#modalStore").hide();
			}

			function getProductByStore(store) {
				getDataList(yshurl + "SC_ADContent_Edit_GetProductByStore", {
					Store: store
				}, function(d) {
					//					console.info(d);
					$("#modalSelectList").empty();
					if(d.state == 0 && $.isArray(d.aaData)) {
						appendSelectList($("#modalSelectList"), d.aaData);
					}
				});
			}
			$("#StoreSelectList").on("change", function() {
				$("#modalSelectList").selectator('destroy');
				getProductByStore($("#StoreSelectList option:selected").val());
				$("#modalSelectList").selectator({
					height: 'auto',
					showAllOptionsOnFocus: false,
					labels: {
						search: '查询.....' // Placeholder text in search box in single select box
					}
				});
			})

			function saveData() {
				if($("#modalTitle").text() == "选择关联店铺") {
					$("#tStore").text($("#modalSelectList option:selected").text());
					$("#Store").val($("#modalSelectList option:selected").val());
					$("#ADName").val($("#modalSelectList option:selected").text()).attr("disabled", "true");
				} else if($("#modalTitle").text() == "选择关联商品") {
					if($("#modalSelectList option:selected").val() == undefined) {
						ysh_alert("请选择有商品的店铺", "warning");
						return;
					}
					var ProductId = {
						ProductId: $("#modalSelectList").val()
					}
					var url = yshurl + "SelectProductNameforContent";
					getDataList(url, ProductId, function(msn) {
						$("#ADName").val(msn.aaData[0].ProductName).attr("disabled", true);
						$("#ADTitle").val("¥" + msn.aaData[0].Price).attr("disabled", true);
						$("#ADexplain").val("库存" + msn.aaData[0].StockQuantity + "件").attr("disabled", true);
					})
					$("#tProduct").text($("#modalSelectList option:selected").text());
					$("#Product").val($("#modalSelectList option:selected").val());
				}
				$('#myModal').modal("hide");
				setIframeHeight();
			}

			function ChooseStore() {
				$("#modalTitle").text("选择关联店铺");
				$("#modalLabel").text("关联店铺");
				appendSelectList($("#modalSelectList"), attributes.store);
				if($("#Store").val() != "0" && $("#Store").val() != "")
					$("#modalSelectList").val($("#Store").val());
				$('#myModal').modal();
			}

			function ChooseProduct() {
				$("#modalTitle").text("选择关联商品");
				$("#modalLabel").text("关联商品");
				$("#modalStore").show();
				appendSelectList($("#StoreSelectList"), attributes.store);
				$("#StoreSelectList").selectator({
					showAllOptionsOnFocus: false,
					labels: {
						search: '查询.....' // Placeholder text in search box in single select box
					},
					height: 'auto'
				});
				if($("#Product").val() != "0" && $("#Product").val() != "") {
					getDataList(yshurl + "SC_ADContent_Edit_GetStoreByProduct", {
						Product: $("#Product").val()
					}, function(d) {
						$("#StoreSelectList").val(d.aaData[0].Store);
						getProductByStore(d.aaData[0].Store);
					});
					$("#modalSelectList").val($("#Product").val());
				} else {
					getProductByStore($("#StoreSelectList option:selected").val());
				}
				$('#myModal').modal();
			}

			function productOpt() {
				$("#rStore").val("不可用");
				$("#rStore").attr("disabled", true);
				$("#rStore").removeClass("btn btn-info").addClass("btn btn-primary");
				$("#tStore").text("");
				$("#Store").val(0);
				$("#rProduct").val("关联商品");
				$("#rProduct").attr("disabled", false);
				$("#rProduct").removeClass("btn btn-primary").addClass("btn btn-info");
				$("#articleBtn").val("不可用");
				$("#ADName").val("").attr("disabled", true);
				$("#ADTitle").val("").attr("disabled", true)
				$("#ADexplain").val("").attr("disabled", true);
			}

			function storeOpt() {
				$("#rProduct").val("不可用");
				$("#rProduct").attr("disabled", true);
				$("#tProduct").text("");
				$("#Product").val(0);
				$("#getProductByStore").removeClass("btn btn-info").addClass("btn btn-primary");
				$("#rStore").val("关联店铺");
				$("#rStore").attr("disabled", false);
				$("#rStore").removeClass("btn btn-primary").addClass("btn btn-info");
				$("#articleBtn").val("不可用");
				$("#ADName").val("").attr("disabled", true);
				$("#ADTitle").val("").attr("disabled", false)
				$("#ADexplain").val("").attr("disabled", false);
			}

			function articleBtn() {
				$("#articleBtn").val("请输入标题、副标题、说明进行编辑");
				$("#rProduct").val("不可用");
				$("#rStore").attr("disabled", true);
				$("#rStore").removeClass("btn btn-primary").addClass("btn btn-info");
				$("#rStore").val("不可用");
				$("#rProduct").attr("disabled", true);
				$("#rProduct").removeClass("btn btn-primary").addClass("btn btn-info");
				$("#tProduct").text("");
				$("#tStore").text("");
				$("#ADName").val("").attr("disabled", false);
				$("#ADTitle").val("").removeAttr("disabled")
				$("#ADexplain").val("").attr("disabled", false);
			}

			$("#Status").on("change", function(event) {
				if($("#Status").val() == "正常") {
					$("#PauseReason").val("");
					$("#PauseReason").attr("readonly", true);
				} else {
					$("#PauseReason").attr("readonly", false);
				}
			});
			$("#LinkType").on("change", function(event) {
				if($("#LinkType").val() == 1) {
					productOpt();
				} else if($("#LinkType").val() == 2) {
					storeOpt();
				} else {
					articleBtn();
				}

			});

			function redirectToList() {
				window.history.back();
			}
			//转换查询条件
			function convertToParams(array) {
				var obj = {};
				if((array != null && array != undefined) && array.length > 0) {
					$.each(array, function(i, v) {
						obj[v.name] = v.value;
					});
				}
				return obj;
			}

			function change() {
				$form.data('bootstrapValidator').validate();
				if($form.data('bootstrapValidator').isValid()) {
					var p = parseUrl();
					var conditions = $form.serializeArray();
					conditions = convertToParams(conditions);
					var src = $('#Content').attr("src");
					if(src) {
						conditions.Content = src;
					} else
						conditions.Content = "";
					if(conditions.Product == "")
						conditions.Product = 0;
					if(conditions.Store == "")
						conditions.Store = 0;
					if($("#LinkType").val() != 1) {
						conditions.Product = 0;
					}

					conditions.ADName = $("#ADName").val();
					conditions.ADTitle = $("#ADTitle").val();
					conditions.ADexplain = $("#ADexplain").val();
					if(p.name == "Add") {
						if(conditions.ADName !== "" && conditions.ADTitle !== "" && conditions.ADexplain !== "") {
							if(Number(conditions.DueDate.replace(/-/g, "")) < Number(conditions.StartDate.replace(/-/g, ""))) {
								ysh_msg("结束日期不能早于开始日期");
							} else {
								getDataList(yshurl + "SC_ADContent_Edit_insertInfo", conditions, function(d) {
									if(d.state == 0) {
										ysh_msg("添加广告内容成功！");
										setTimeout(function() {
											window.history.back();
										}, 1000);
									} else {
										ysh_alert("添加操作失败，请联系客服人员!", "error");
									}
								});
							}
						} else {
							ysh_alert("请先选择关联商品或关联店铺进行编辑", "error");
						}
					} else if(p.name == "Edit") {
						if(conditions.ADName !== "" && conditions.ADTitle !== "" && conditions.ADexplain !== "") {
							if(Number(conditions.DueDate.replace(/-/g, "")) < Number(conditions.StartDate.replace(/-/g, ""))) {
								ysh_msg("结束日期不能早于开始日期");
							} else {
								getDataList(yshurl + "SC_ADContent_Edit_UpdateInfo", conditions, function(d) {
									if(d.state == 0) {
										ysh_msg("更新广告内容成功！");
										setTimeout(function() {
											window.history.back();
										}, 1000);
									} else {
										ysh_alert("添加更新失败，请联系客服人员!", "error");
									}
								});
							}
						} else {
							ysh_alert("请先选择关联商品或关联店铺进行编辑", "error");
						}
					}
				} else {
					return;
				}
			}

			function AddPosition() {
				var CID = $("#ADId").val();
				getDataList(yshurl + "SC_ADContent_Edit_SearchPositions", {
					CID: CID
				}, function(d) {
					if(d.state == 0) {
						appendSelectList($("#modalSelectList2"), d.aaData);
						$("#myModal2").modal();
					} else {
						ysh_alert("广告位获取失败，请联系客服人员!", "error");
					}
				});
			}

			function getSelectItems() {
				var arr = new Array();
				var $values = $(".selectator_chosen_item");
				$.each($values, function(i, v) {
					if(v.className != undefined) {
						var res = v.className.split(' ')[1];
						res = res.replace("selectator_value_", "");
						arr.push(res);
					};
				});
				return arr.join(",");
			}

			function SavePosition() {
				var CID = $("#ADId").val();
				var PositionIds = getSelectItems();
				//				console.log(PositionIds);
				if(PositionIds != "") {
					getDataList(yshurl + "SC_ADContent_Edit_InsertPosition", {
						CID: CID,
						PositionIds: PositionIds
					}, function(d) {
						if(d.state == 0) {
							$("#myModal2").modal("hide");
							Query(CID);
							ysh_msg("添加广告位成功");
						} else {
							ysh_alert("广告位添加失败，请联系客服人员!", "error");
						}
					});
				} else {
					ysh_msg("请选择广告位");
				}
			}

			function DeleteAd(Id) {
				var CID = $("#ADId").val();
				ysh_confirm("是否确认删除所选广告位？", "确认", "取消", function(res) {
					if(res) {
						getDataList(yshurl + "SC_ADContent_Edit_Delete", {
							CID: CID,
							PositionId: Id
						}, function(d) {
							if(d.state == 0) {
								ysh_msg("删除广告位成功！");
								Query(CID);
							} else {
								return ysh_alert("删除操作出错啦，请刷新或者联系客服人员！", "error");
							}
						});
					} else
						return ysh_alert("删除失败！", "error");
				});
			}

			function Query(Id) {
				var search = {
					ADId: Id
				};
				getDataList(yshurl + "SC_ADContent_Edit_GetADPositionsTotal", search, function(d) {
					dataTotal = d.aaData[0].TotalNum;
				});
				search = initPageInfo(search);
				var options = $table.bootstrapTable('getOptions');
				options.pageNumber = 1;
				getDataList(yshurl + "SC_ADContent_Edit_GetADPositions", search, function(d) {
					$table.bootstrapTable('refreshOptions', options);
					loadData($table, {
						total: dataTotal,
						rows: d.aaData
					});
				});
			}
			//操作字段格式
			function operationFormatter(value, row, index) {
				var result = [
					'<a style="color:red"  href="SC_ADPosition_Edit.html?Id=', row.Id, '&name=Search">查看</a>&nbsp;&nbsp;&nbsp;', '<a style="color:green"  href="javascript:void(0)" onclick="DeleteAd(', row.Id, ')">删除</a>'
				];
				return result.join('');
			}
			//从url中提取参数
			function parseUrl() {
				var url = location.href;
				var i = url.indexOf('?');
				if(i == -1) return;
				var querystr = url.substr(i + 1);
				var arr1 = querystr.split('&');
				var arr2 = new Object();
				for(i in arr1) {
					var ta = arr1[i].split('=');
					arr2[ta[0]] = ta[1];
				}
				return arr2;
			}
			//构建select
			function appendSelectList(f1, array) {
				if((array != null && array != undefined) && array.length > 0) {
					$.each(array, function(i, v) {
						f1.append("<option value=" + v.value + ">" + v.text + "</option>");
					});
				}
			}
			// 初始化表格
			function initFormData(obj) {
				if(obj) {
					$.each(obj, function(i, v) {
						if(v != null) {
							if($("#" + i).is("p"))
								$("#" + i).text(v);
							else if($("#" + i).attr("type") == "checkbox") {
								if(v == 1)
									$("#" + i).attr("checked", true);
							} else if($("#" + i).is("img")) {
								if(v != null && v != "") {
									$("#" + i).attr("src", v).show();
									setIframeHeight();
								}
							} else
								$("#" + i).val(v);
						}
					});
				}
			}
			//初始化分页数据
			function initPageInfo(res) {
				res.PageIndex = 0;
				res.PageSize = 10;
				return res;
			}
			//翻页时获取数据
			function getData(params) {
				getDataList(yshurl + "SC_ADContent_Edit_GetADPositions", params, function(d) {
					var tableData1 = {
						total: dataTotal,
						rows: d.aaData
					};
					loadData($table, tableData1);
				});
			}
			//表格加载数据
			function loadData(f1, data) {
				f1.bootstrapTable('load', data);
			}
			$(function() {
				$("#file_upload").uploadifive({
					height: 50,
					uploadScript: 'http://f.yshfresh.com/upload',
					width: 80,
					buttonText: " ",
					//                  	buttonStyle: "btn btn-success",
					multi: false,
					'auto': true,
					'fileSizeLimit': '2MB',
					simUploadLimit: 1,
					'fileType': 'image/*',
					'onUploadComplete': function(file, data) {
						var obj = $.parseJSON(data);
						if(obj.msg == "upload success") {
							if(obj.aaData.length > 0) {
								$("#Content").attr("src", seturl.substr(0, seturl.length - 1) + obj.aaData[0].fileurl);
								$("#Content").show();
							}
						}
						$(".complete").remove();
						setIframeHeight();
					},
					"onError": function() {
						setIframeHeight();
					}
				});
				$("#uploadifive-file_upload").css({
					height: '80px',
					border: '1px dashed gray'
				});
				getDataList(yshurl + "SC_ADContent_Edit_GetSearchInfo", {}, function(d) {
					if(d.state == 0) {
						attributes.store = d.many[0];
						attributes.product = d.many[2];
						appendSelectList($("#ADType"), d.many[1]);
						appendSelectList($("#Channel"), d.many[3]);
						$("#modalStore").hide();
						var params = parseUrl();
						var id;
						if(params.name == "Edit") {
							$("#SecondStep").show();
							$("#FirstStep").hide();
							id = params.Id;
							getDataList(yshurl + "SC_ADContent_Edit_GetContentInfo", {
								CID: id
							}, function(d) {
								if(d.state == 0) {
									$("#HT").text('编辑广告内容');
									initFormData(d.aaData[0]);
									var res = {
										ADId: id
									};
									res1 = initPageInfo(res);

									//初始化
									if($("#LinkType").val() == 1) {
										productOpt();
										$("#ADName").val(d.aaData[0].ADName).attr("disabled", true);
										$("#ADTitle").val(d.aaData[0].ADTitle).attr("disabled", true);
										$("#ADexplain").val(d.aaData[0].ADexplain).attr("disabled", true);
									} else if($("#LinkType").val() == 2) {
										storeOpt();
										$("#ADName").val(d.aaData[0].ADName).attr("disabled", true);
										$("#ADTitle").val(d.aaData[0].ADTitle).attr("disabled", false);
										$("#ADexplain").val(d.aaData[0].ADexplain).attr("disabled", false);
									} else {
										articleBtn();
										$("#ADName").val(d.aaData[0].ADName).attr("disabled", false);
										$("#ADTitle").val(d.aaData[0].ADTitle).attr("disabled", false);
										$("#ADexplain").val(d.aaData[0].ADexplain).attr("disabled", false);
									}

									//*******************************表格开始*************************************************    
									getDataList(yshurl + "SC_ADContent_Edit_GetADPositions", res1, function(d) {
										//获取总条数
										getDataList(yshurl + "SC_ADContent_Edit_GetADPositionsTotal", res, function(d) {
											dataTotal = d.aaData[0].TotalNum;
										});
										var tableData = {
											total: dataTotal,
											rows: d.aaData
										};
										if(d.state == 0) {
											$table.bootstrapTable({
												sidePagination: 'server',
												pagination: true,
												pageSize: 10,
												pageNumber: 1,
												pageList: [10]
											});
											loadData($table, tableData);
											// 控制翻页事件
											$table.on('page-change.bs.table', function(e, number, size) {
												res1.PageIndex = (number - 1) * size;
												res1.PageSize = size;
												getData(res1);
											});
										} else {
											ysh_alert("程序出错，请刷新后重试", "warning");
										}
									});
									//*******************************表格结束*************************************************       
								} else {
									ysh_alert("程序出错，请刷新后重试", "warning");
								}
							});
						} else {
							$("#HT").text('新增广告内容');
							getDataList(yshurl + "SC_ADContent_Edit_GetDate", {}, function(d) {
								$("#StartDate").val(d.aaData[0].StartDate);
								$("#DueDate").val(d.aaData[0].EndDate);
							});
							$("#SecondStep").hide();
							$("#FirstStep").show();
						}
						var add = ysh_GetQueryString("name");
						if(add == "Add") {
							if($("#LinkType").val() == 1) {
								productOpt();
							} else if($("#LinkType").val() == 2) {
								storeOpt();
							} else {
								articleBtn();
							}
						}

						if($("#Status").val() == "正常") {
							$("#PauseReason").val("");
							$("#PauseReason").attr("readonly", true);
						} else {
							$("#PauseReason").attr("readonly", false);
						}
					} else {
						ysh_alert("程序出错，请刷新后重试", "warning");
					}
				});
				$form.bootstrapValidator({
					message: '输入数据格式不对请确认后重新输入',
					feedbackIcons: {
						valid: 'glyphicon glyphicon-ok',
						invalid: 'glyphicon glyphicon-remove',
						validating: 'glyphicon glyphicon-refresh'
					},
					fields: {
						ADName: {
							validators: {
								notEmpty: {
									message: '广告标题不能为空'
								},
								stringLength: {
									min: 1,
									max: 20,
									message: '广告名称长度不能超过20个字符'
								}
							}
						},
						ADTitle: {
							validators: {
								notEmpty: {
									message: '广告副标题不能为空'
								},
								stringLength: {
									min: 1,
									max: 20,
									message: '广告名称长度不能超过20个字符'
								}
							}
						},
						ADexplain: {
							validators: {
								notEmpty: {
									message: '广告说明不能为空'
								},
								stringLength: {
									min: 1,
									max: 20,
									message: '广告名称长度不能超过20个字符'
								}
							}
						}
					}
				});
				$("#confirm").on("click", function() {
					setIframeHeight();
				})
				setIframeHeight();
			});
		</script>
	</body>

</html>