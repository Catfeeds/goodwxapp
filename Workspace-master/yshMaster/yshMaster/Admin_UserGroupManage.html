<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="ThemeBucket">
		<link rel="shortcut icon" href="#" type="image/png">

		<title>用户分组管理</title>
		<!--pickers css-->
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datepicker/css/datepicker-custom.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-timepicker/css/timepicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-colorpicker/css/colorpicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/bootstrapValidator.css" rel="stylesheet">	
		<link rel="stylesheet" type="text/css" href="css/select2.min.css"/>
		
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
  <script src="js/html5shiv.js"></script>
  <script src="js/respond.min.js"></script>
  <![endif]-->
  <script src="js/jquery-1.10.2.min.js"></script>
  		<script src="js/ysh_comm.js"></script>
  		<script type="text/javascript">
  			checkPermission();
  		</script>
	</head>

	<body class="children-body">

		<!--body wrapper start-->
		<section class="">
			<!-- page start-->
			<div class="row">
				<div class="col-lg-12">
					<section class="panel">
						<header class="panel-heading">
							用户分组管理
						</header>
						<div class="panel-body">
							<form id="searchForm" class="form-horizontal" role="form">
								<div class="row clearfix">
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">分组名称</label>
											<div class="col-lg-9">
												
													<input id="UserGroup" name="UserGroup"  type="text" class="form-control">
												
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">所属渠道</label>
											<div class="col-lg-9">
												<select class="form-control m-bot15" id="ChannelId" name="ChannelId" onchange="serchChannelChange()">
					                            </select>
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">所属分组</label>
											<div class="col-lg-9">
												<select class="form-control m-bot15" id="ParentId" name="ParentId">
					                            </select>
											</div>
										</div>
									</div>
								</div>
								
								<div class="row clearfix">
									<div class="col-lg-12">
										<div class="text-right">			
											<button id="searchBtn" class="btn btn-info" type="button">搜索</button>		
											<button id="resetBtn" class="btn btn-danger" type="reset">重置</button>	
										</div>
									</div>
								</div>
							</form>
						</div>
					</section>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">		
					<section class="panel">
						<div class="panel-heading">
							<div class="text-right">
								<button id="addBtn" class="btn btn-success" type="button" >添加</button>
								<button id="delBtn" class="btn btn-danger" type="button" onclick="batchDeleteData();">批量删除</button>
							</div>
						</div>
						<div class="panel-body">
							<table id="bs" class="table table-striped table-condensed table-hover talbe-border" data-side-pagination="server">
								<thead>
									<tr>
										<th data-field="status" data-align="center" data-checkbox="true" data-formatter="checkformatter"></th>
										<th data-field="Id" data-align="center" >编号</th>
										<th data-width="20%" data-field="UserGroup" data-align="center" >分组名称</th>
										<th data-field="ParentName" data-align="center" >所属分组</th>
                                        <th data-field="ChannelName" data-align="center" >所属渠道</th>
                                        <th data-width="25%" data-field="Remark" data-align="center" >分组说明</th>
										<th data-field="Operation" data-align="center" data-formatter="operationFormatter">操作</th>
									</tr>
								</thead>
							</table>
						</div>
					</section>
					</div>
					<!--body wrapper end-->
					
				</div>
				<!-- main content end-->
				
			<!-- Modal -->
            <div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade">
                <div class="modal-dialog">
                    <div class="modal-content">
                    	<form id="editForm">
                        <div class="modal-header">
                            <button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
                            <h4 class="modal-title">添加分组</h4>
                        </div>
                        <div class="modal-body">
                        	<div class="form-horizontal">
								<div class="form-group " id="divId">
									<label for="Id" class="control-label col-lg-3">分组编号</label>
									<div class="col-lg-8">
										<input class="form-control " id="Id" type="text" name="Id" readonly />
									</div>
									<div class="col-lg-1">
										<span style="color: red;">*</span>
									</div>
								</div>
								<div class="form-group ">
									<label for="UserGroup" class="control-label col-lg-3">分组名称</label>
									<div class="col-lg-8">
										<input class="form-control " maxlength="30" id="UserGroup" type="text" name="UserGroup" required />
									</div>
									<div class="col-lg-1">
										<span style="color: red;">*</span>
									</div>
								</div>
								<div class="form-group ">
									<label for="ChannelId" class="control-label col-lg-3">所属渠道</label>
									<div class="col-lg-8">
										<select class="form-control m-bot15" id="ChannelId" name="ChannelId" onchange="editChannelChange()">     
				                        </select>
				                        <input class="form-control " id="ChannelName" type="text" name="ChannelName" readonly />
									</div>
									<div class="col-lg-1">
											<span style="color: red;">*</span>
										</div>
								</div>
								<div class="form-group ">
									<label for="ParentId" class="control-label col-lg-3">所属分组</label>
									<div class="col-lg-8">
										<select class="form-control m-bot15" id="ParentId" name="ParentId">
				                        </select>
				                        <input class="form-control " id="ParentName" type="text" name="ParentName" readonly />
									</div>
									
								</div>
								<div class="form-group ">
									<label for="Remark" class="control-label col-lg-3">分组描述</label>
									<div class="col-lg-8">
										<textarea  style="resize: none;" class="form-control " maxlength="50" id="Remark" name="Remark" rows="5"></textarea>
									</div>
								</div>
							</div>
                        </div>
                        <div class="modal-footer">
                            <button id="saveBtn" type="button" class="btn btn-success">保存</button>
                            <button id="closeBtn" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        </div>
                       </form>
                    </div>
                </div>
            </div>
            <!-- modal -->
				
		</section>

		<!-- Placed js at the end of the document so the pages load faster -->
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
		<script src="js/jquery-migrate-1.2.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/modernizr.min.js"></script>
		<script src="js/jquery.nicescroll.js"></script>
	
		<!--pickers plugins-->
		<script type="text/javascript" src="js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/moment.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/daterangepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>
		<script type="text/javascript" src="js/bootstrapValidator.js"></script>
		
		<!--bootstrap Table-->
		<script src='js/bootstrap-table.js'></script>
		<script src='js/bootstrap-table-zh-CN.js'></script>
		<script src='js/bootstrap-editable.js'></script>
		<script src='js/bootstrap-table-editable.js'></script>
	
		<!--pickers initialization-->
		<script src="js/pickers-init.js"></script>
	
		<!--common scripts for all pages-->
		<script src="js/scripts.js"></script>
		<script src="js/layer.js"></script>
		<script src="js/ysh_comm.js"></script>
		<script src="js/select2.min.js"></script>
		

		<script>
			var checkList = [];
			var $table = $("#bs");
			var data = [];
			var schParam = {};
			var total = 0; 	//总数据条数
			var editdata = {};
			//表格样式
			function rowStyle(row, index) {
				var classes = ['active', 'success', 'info', 'warning', 'danger'];
				if (index % 2 === 0) {
					return {
						classes: 'warning'
					};
				} else
					return {
						classes: 'info'
					};
			}

			function selectListFormatter(value, row, index) {
				if (value != null && value != undefined) {
					var sl = ["<select id='Id", row.Id, "' class='selectForMobile' >"];
					$.each(value, function(i, v) {
						sl.push("<option value='" + v.value + "' >" + v.text + "</option>");
					});
					sl.push("</select>")
					return sl.join('');
				} else return "";
			}

			function operationFormatter(value, row, index) {
				var result = [
					'<button class="btn btn-info" onclick="editData('+index+');">编辑</button>', '<button class="btn btn-danger" type="button" onclick="deleteData('+ row.Id +')">删除</button>'
				];
				return result.join(' ');
			}
			
			
			function checkformatter(value, row, index) {
		        var pIndex = $.inArray(row.Id, checkList);
		        if (pIndex >= 0) {
		            return {
		                checked: true
		            }
		        }
		        else {
		            return {
		                checked: false
		            }
		        }
		    }
			/*********  编辑  ***********/
				function editData(index){
					editdata = data[index];
					$("#divId").show();
					$("#editForm #ChannelName").show().css("margin-top","-20px");
					$("#editForm #ChannelId").hide();
					$("#editForm #ParentName").show().css("margin-top","-20px");
					$("#editForm #ParentId").hide();
					$(".selection").hide();
					
					$("#saveBtn").attr("ekey","edit");
					clearData();
					initData(editdata);
					$(".modal-title").text('编辑分组信息');
					$("#myModal").modal();
//					setTimeout(function(){$('#editForm').data('bootstrapValidator').resetForm();},200);
				}
				
				
				function initData(data){
					$("#editForm #Id").val(data.Id);
					$("#editForm #UserGroup").val(data.UserGroup);
//					$("#editForm #ChannelId").val(data.ChannelId);
//					$("#editForm #ParentId").val(data.ParentId);
					$("#editForm #ChannelName").val(data.ChannelName);
					$("#editForm #ChannelName").attr('cId',data.ChannelId);
					$("#editForm #ParentName").val(data.ParentName);
					$("#editForm #Remark").val(data.Remark);
				}
				
				
				function clearData(){
					$("#editForm #Id").val('');
					$("#editForm #UserGroup").val('');
//					$("#editForm #ChannelId").val('');
//					$("#editForm #ParentId").val('');
					$("#editForm #ChannelName").val('');
					$("#editForm #ChannelName").attr('cId','');
					$("#editForm #ParentName").val('');
					$("#editForm #Remark").val('');
				}
				
				//重置
				$("#resetBtn").on("click",function(){
					$("#ChannelId").select2('val','0');
					$("#Partyname").val('');
				})
					
				/*********  删除  ***********/
				
				function deleteData(id){
					
					getDataList(yshurl+"Admin_CheckGroupCanDel",{ids:id},function(d){
						if(d && d.state==0 && d.aaData){
							if(d.aaData.length > 0){
								ysh_msg("当前分组下包含子分组或用户数据，不能删除");
							}else{
								ysh_confirm("确定要删除数据？","确定","取消",function(ret){
									if(ret){
										getDataList(yshurl + 'Admin_BatchDeleteUserGroup',{ids:id},function(d){
											if(d && d.state == 0){
												ysh_msg("删除成功");
												$("#searchBtn").click();
											}else{
												ysh_msg("删除失败");
											}
										});
									}
								});
							}
						}else{
							ysh_msg("服务器错误，请稍后再试");
						}
					});
				
						
				}
				
				//批量删除
				function batchDeleteData(){
					if(checkList.length == 0){ 
						ysh_msg("请选择需要删除的数据"); 
						return;
					}
					var ids = checkList.join(',');
					getDataList(yshurl+"Admin_CheckGroupCanDel",{ids:ids},function(d){
						if(d && d.state==0 && d.aaData){
							if(d.aaData.length > 0){
								ysh_msg("当前分组下包含子分组或用户数据，不能删除");
							}else{
								ysh_confirm("确定要删除数据？","确定","取消",function(ret){
									if(ret){
										getDataList(yshurl + 'Admin_BatchDeleteUserGroup',{ids:ids},function(d){
											if(d && d.state == 0){
												ysh_msg("删除成功");
												$("#searchBtn").click();
											}else{
												ysh_msg("删除失败");
											}
										});
									}
								});
							}
						}else{
							ysh_msg("服务器错误，请稍后再试");
						}
					});
							
						
				}
				
				/*********  新增、、更新  ***********/
				
				function insertData(data){
					getDataList(yshurl+"Admin_InsertUserGroup",data,function(d){
						if(d && d.state == 0){
							ysh_msg("添加成功");
							$("#closeBtn").click();
							$("#searchBtn").click();
						}else{
							if(d.msg && d.msg.sqlState == "23000")
								ysh_msg("分组名称已存在");
							else
								ysh_msg("添加失败");
						}
					});
				}
				
				function updateData(data){
					getDataList(yshurl+"Admin_UpdateUserGroup",data,function(d){
						if(d && d.state == 0){
							ysh_msg("修改成功");
							$("#closeBtn").click();
							$("#searchBtn").click();
						}else{
							if(d.msg && d.msg.sqlState == "23000")
								ysh_msg("分组名称已存在");
							else
								ysh_msg("修改失败");
						}
					})
				}
				
				/*********  获取基础数据  ***********/
				var userGroupEnum = [];
				var channelEnum= [];
				
				function getChannelEnumData(api,callback){
					getDataList(yshurl+api,{},function(d){
						if(d && d.state == 0 && d.aaData){
							userGroupEnum = d.aaData;
							if(typeof callback === 'function'){
								callback(d.aaData)
							}
						}else{
							ysh_msg("获取数据错误，请稍后再试");
						}
					});
				}
				
				//初始化查询表单渠道数据
				function InitSearchFormChannel(data){
					var pdata = data;
					var html = '';
					pdata.splice(0,0,{Id:0,ChannelName:'全部'});
					var $serchChannel = $("#searchForm #ChannelId");
					$serchChannel.html('');
					for(var i = 0;i < pdata.length; i++){
						var item = pdata[i];
						html += '<option value='+ item.Id +'>'+ item.ChannelName +'</option>';
					}
					$serchChannel.append(html);
					$serchChannel.val(0);
					$("#searchForm #ParentId").attr("disabled","disabled");
				}
			
				//初始化编辑表单渠道数据
				function initEidtFormChannel(data){
					var pdata = data;
					var html = '';
//					pdata.splice(0,0,{Id:0,ChannelName:''});
					var $serchChannel = $("#editForm #ChannelId");
					$serchChannel.html('');
					for(var i = 0;i < pdata.length; i++){
						var item = pdata[i];
						html += '<option value='+ item.Id +'>'+ item.ChannelName +'</option>';
					}
					$serchChannel.append(html);
					$serchChannel.val(pdata[0].Id);
					channelChange('editForm','ChannelId','ParentId',initEditFormGroup)
				}
			
				getChannelEnumData('Admin_GetChannelEnum',InitSearchFormChannel);
				
				
				function serchChannelChange(){
					channelChange('searchForm','ChannelId','ParentId',initSearchFormGroup);
				}
				
				function editChannelChange(){
					channelChange('editForm','ChannelId','ParentId',initEditFormGroup);
				}
				
				//选择渠道时触发
				function channelChange(form,channelEle,groupEle,callback){
					var $channel = $("#"+form+" #"+channelEle);
					var $group = $("#"+form+" #"+groupEle);
					var channelId = $channel.val();
					$group.removeAttr('disabled');
					$group.html('');
					if(channelId != '0'){
						getDataList(yshurl+"Admin_GetUserGroupByChannelId",{ChannelId:channelId}, function(d){
							if(d && d.state ==0 && d.aaData){
								if(typeof callback === 'function'){
									callback($group,d.aaData);
								}
							}
						})
					}else{
						$group.attr("disabled", "disabled");
					}
				}
				
				//初始化查询表单分组数据
				function initSearchFormGroup($group,data){
					var pdata = data;
					var html ="";
					pdata.splice(0,0,{Id:0, UserGroup:'全部'});
					for(var i = 0; i< pdata.length; i++){
						var item = pdata[i];
						html += '<option value='+ item.Id +'>'+ item.UserGroup +'</option>';
					}
					$group.append(html);
					$group.val(0);
				}
				
				//初始化编辑表单
				function initEditFormGroup($group,data){
					var pdata = data;
					var html ="";
					pdata.splice(0,0,{Id:0, UserGroup:''});
					for(var i = 0; i< pdata.length; i++){
						var item = pdata[i];
						html += '<option value='+ item.Id +'>'+ item.UserGroup +'</option>';
					}
					$group.append(html);
					$group.val(0);
				}
			
			$(function() {
				$('select').select2();
				
				leftCancelShade('myModal');
				$table.bootstrapTable({
					pagination: true, //分页
					onCheck: function(row) {
						checkList.push(row.Id);
						$.unique(checkList);
					},
					onUncheck: function(row) {
						$.unique(checkList);
						var pIndex = $.inArray(row.Id, checkList);
						checkList.splice(pIndex, 1);
					},
					onCheckAll: function(rows) {
						$.each(rows, function(index) {
							checkList.push(rows[index].Id);
						});
						$.unique(checkList);
					},
					onUncheckAll: function(rows) {
						$.unique(checkList);
						var filterarray = $.grep(checkList, function(value) {
							var isDel = false;
							for (var i = 0; i < rows.length; i++) {
								if (rows[i].Id == value) {
									isDel = true;
									break;
								}
							}
							return !isDel;
						});
						checkList = filterarray;
					},
					escape: true,
					clickToSelect: false,
					pageList: [10]
				});
				/*********  查询  ***********/
				
				//表格加载数据
				function loadData(f1, data) {
					f1.bootstrapTable('load', data);
					var hashTemp = window.location.hash || "1"
	
					hashTemp = hashTemp.replace("#", "")
					$(".pagination").find('a').each(function() {
						if($(this).text() == hashTemp)
							$(this).click()
					})
				};
				
				//获取数据
				function getData(param, limit, offset){
					param.limit = limit;
					param.offset = offset;
					getDataList(yshurl+'Admin_GetUserGroup',param,function(d){
						if(d && d.state == 0){
							data = d.many[1].rows;
							var pdata = {total:d.many[0].total[0].total,rows:data};
							loadData($table,pdata);
						}else{
							var pdata = {total:0,rows:[]};
							loadData($table,pdata);
						}
						setIframeHeight();
					});
				}
				
				//点击分页查询
				$table.on('page-change.bs.table', function(e, number, size) {
					var os = (number - 1) * size;
					var lm = size;
					window.location.hash = number;
					getData(schParam, lm, os);
				});
				
				// onhashchange可以监控hash变化
			    window.onhashchange = function() {
			        var hash = window.location.hash;
			        var id;
			        if(hash != ""){
			        	id = parseInt(hash.substr(1));
			        } else{
			        	id = 1
			        }
			        getData(schParam, 10, (id-1)*10);
			        console.info(hash)
			       	$("ul.pagination").children().eq(id).addClass("active").siblings().removeClass("active");
			    };
				
				$("#searchBtn").click(function(){
					var options = $table.bootstrapTable('getOptions');
					options.pageNumber = 1;
					$table.bootstrapTable('refreshOptions',options);
					schParam = convertParams("searchForm");
					//判断条件中是否包含所属分组数据
					var isCtn = false;
					for(var x in schParam){
						if(x == 'ParentId'){
							isCtn = true;
						}
					}
					if(!isCtn){
						schParam.ParentId = 0;
					}
					
					total = 0;
					data = [];
					checkList = [];
//					var options = $table.bootstrapTable('getOptions');
					getData(schParam,options.pageSize, 0);
				});
				
				$("#searchBtn").click();
				
				/*********  新增  ***********/
				$("#addBtn").click(function(){
					$("#editForm #ChannelName").hide();
					$("#editForm #ChannelId").show();
					$("#editForm #ParentName").hide();
					$("#editForm #ParentId").show();
					$(".selection").show();
					$(".select2").css("width","100%");
					
					getChannelEnumData('Admin_GetChannelEnum',initEidtFormChannel);
					$("#divId").hide();
					$("#saveBtn").attr("ekey","add");
					clearData();
					$(".modal-title").text('新增分组信息');
					$("#myModal").modal();
				});
				
				$("#editForm #ChannelId").change(function(){
					$('#editForm').data('bootstrapValidator')
					.updateStatus('UserGroup', 'NOT_VALIDATED')
					.validateField('UserGroup');
				});
				
				//隐藏模态框时执行
				$('#myModal').on('hide.bs.modal', function() {
					editdata={};
					$('#editForm').data('bootstrapValidator').resetForm();
				});
				
				//提交数据
				$("#saveBtn").click(function(){
					$('#editForm').data('bootstrapValidator').validate();
					if($('#editForm').data('bootstrapValidator').isValid()){
						var ekye = $(this).attr("ekey").toLowerCase();
						var pdata = convertParams("editForm");
						pdata.pId = pdata.Id;
						if(ekye == 'add'){
							insertData(pdata)
						}else{
							updateData(pdata);
						}
					}
				});
				
				
				//表单验证
			    $('#editForm').bootstrapValidator({
			        message: 'This value is not valid',
			        feedbackIcons: {
			            valid: 'glyphicon glyphicon-ok',
			            invalid: 'glyphicon glyphicon-remove',
			            validating: 'glyphicon glyphicon-refresh'
			        },
			         submitHandler: function(validator, form, submitButton) {
			                // Do nothing
			               
			         },
			        fields: {
			        	UserGroup:{
			        		validators: {
			                    notEmpty: {
			                        message: '分组名称不能为空'
			                    },
			                    stringLength: {
			                    	message:'已达输入上限'
			                    },
			                    callback:{
			                    	message: '分组名称已存在',
			                    	callback: function(value,validator){
			                    		value = $.trim(value);
			                    		if(value == editdata.UserGroup) return true;
			                    		var f = false;
			                    		var cId = $("#editForm #ChannelName").attr('cId') || $("#editForm #ChannelId").val();
			                    		getDataList(yshurl+'Admin_UserGroupIsExist',{
			                    			UserGroup:value,
			                    			ChannelId:cId},
			                    			function(d){
			                    			if(d && d.state == 0 && d.aaData.length == 0){
			                    				f= true;
			                    			}
			                    		})
			                    		return f;
			                    	}
			                    }
		                	}
			        	},
			        	Remark:{
		                    validators: {
			                    stringLength: {
			                    	message:'已达输入上限'
			                    }
		                    }
			        	}
			        }
			       
			    })
				setIframeHeight();
			});
			
		</script>

	</body>

</html>