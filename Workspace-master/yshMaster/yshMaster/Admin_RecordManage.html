<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="">
		<meta name="author" content="ThemeBucket">
		<link rel="shortcut icon" href="#" type="image/png">

		<title>备案管理</title>
		<!--pickers css-->
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datepicker/css/datepicker-custom.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-timepicker/css/timepicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-colorpicker/css/colorpicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/bootstrapValidator.css" rel="stylesheet">
		<style type="text/css">
			.margin-p {
				margin-top: 7px;
			}
		</style>
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/ysh_comm.js"></script>
		<!--adddate-->
		<script src="js/adddate.js"></script>
		<script type="text/javascript">
			checkPermission();
		</script>
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
		  	<script src="js/html5shiv.js"></script>
		  	<script src="js/respond.min.js"></script>
	  	<![endif]-->
	</head>

	<body class="children-body">

		<!--body wrapper start-->
		<section class="">
			<!-- page start-->
			<div class="row">
				<div class="col-lg-12">
					<section class="panel">
						<header class="panel-heading">
							备案管理
						</header>
						<div class="panel-body">
							<form id="searchForm" class="form-horizontal" role="form">
								<div class="row clearfix">
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">市场名称</label>
											<div class="col-lg-9">

												<input id="MarketName" name="MarketName" type="text" class="form-control">

											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">经营者编码</label>
											<div class="col-lg-9">

												<input id="MerchantId" name="MerchantId" type="text" class="form-control">

											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">经营者名称</label>
											<div class="col-lg-9">

												<input id="MerchantName" name="MerchantName" type="text" class="form-control">

											</div>
										</div>
									</div>
								</div>
								<div class="row clearfix">
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">法人代表</label>
											<div class="col-lg-9">
												<input id="Legal_Represent" name="Legal_Represent" type="text" class="form-control">
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="form-group">
											<label class="col-sm-3 control-label col-lg-3">工商注册号/身份证号</label>
											<div class="col-lg-9">
												<input id="Reg_Id" name="Reg_Id" type="text" class="form-control">
											</div>
										</div>
									</div>

								</div>

								<div class="row clearfix">
									<div class="col-lg-4">
										<div class="form-group">
											<label class="control-label col-lg-3 col-sm-3 ">备案开始时间:</label>
											<div class="col-lg-9">
												<!--<div data-date-viewmode="months" data-date-format="yyyy-mm-dd" data-date="2015-01-01" class="input-append date dpYears">
													<input id="Record_Date_bg" name="Record_Date_bg" type="text" readonly="" size="16" class="form-control">
													<span class="input-group-btn add-on">
                                                    <button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
                                                  </span>
												</div>-->
												<input id="Record_Date_bg" name="Record_Date_bg" type="text" size="16" class="form-control" onclick="SelectDate(this,'yyyy-MM-dd')" />
											</div>
										</div>
									</div>

									<div class="col-lg-4">
										<div class="form-group">
											<label class="control-label col-lg-3 col-sm-3 ">备案结束时间:</label>
											<div class="col-lg-9">
												<!--<div data-date-viewmode="months" data-date-format="yyyy-mm-dd" data-date="2016-12-12" class="input-append date dpYears">
													<input id="Record_Date_ed" name="Record_Date_ed" type="text" readonly="" size="16" class="form-control">
													<span class="input-group-btn add-on">
                                                    <button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
                                                  </span>
												</div>-->
												<input id="Record_Date_ed" name="Record_Date_ed" type="text" size="16" class="form-control" onclick="SelectDate(this,'yyyy-MM-dd')"/>
											</div>
										</div>
									</div>
									<div class="col-lg-4">
										<div class="text-right">
											<button id="searchBtn" class="btn btn-info" type="button">搜索</button>
											<button id="resetBtn" class="btn btn-danger" type="reset">重置</button>
										</div>
									</div>
								</div>

							</form>

						</div>
					</section>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-12">
					<section class="panel">
						<div class="panel-heading">
							<div class="text-right">
								<button id="addBtn" class="btn btn-success" type="button" onclick="gotoAddOrEdit(0);">添加</button>
								<!--<button id="delBtn" class="btn btn-danger" type="button" onclick="batchDeleteData();">批量删除</button>-->
								<!--<button id="exportBtn" class="btn btn-primary" type="button" >导出</button>-->
							</div>
						</div>
						<div class="panel-body">
							<table id="bs" class="table table-striped table-condensed table-hover talbe-border" data-side-pagination="server">
								<thead>
									<tr>
										<th data-field="status" data-align="center" data-checkbox="true" data-formatter="checkformatter"></th>
										<th data-width="3%" data-field="Id" data-align="center">Id</th>
										<th data-width="10%" data-field="MarketName" data-align="center">市场名称</th>
										<th data-width="10%" data-field="MerchantId" data-align="center">经营者编码</th>
										<th data-width="10%" data-field="MerchantName" data-align="center">经营者名称</th>
										<th data-width="10%" data-field="Reg_Id" data-align="center">工商注册号</th>
										<th data-width="15%" data-field="TypeName" data-align="center">经营类型</th>
										<th data-width="10%" data-field="Legal_Represent" data-align="center">法人代表</th>
										<th data-width="7%" data-field="Tel" data-align="center">联系电话</th>
										<th data-width="13%" data-field="Record_Date" data-align="center">备案时间</th>
										<th data-width="12%" data-field="Operation" data-align="center" data-formatter="operationFormatter">操作</th>
									</tr>
								</thead>
							</table>
						</div>
					</section>

					<!--body wrapper end-->

				</div>
				<!-- main content end-->
			</div>
			<!-- Modal -->
			<div aria-hidden="true" aria-labelledby="myModalLabel" role="dialog" tabindex="-1" id="myModal" class="modal fade">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button aria-hidden="true" data-dismiss="modal" class="close" type="button">×</button>
							<h4 class="modal-title">备案详情</h4>
						</div>
						<div class="modal-body">
							<div class="form-horizontal">
								<div class="form-group">
									<label for="MerchantId" class="control-label col-lg-4">经营者编码:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="MerchantId" type="text" name="MerchantId"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="MarketName" class="control-label col-lg-4">市场信息:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="MarketName" type="text" name="MarketName"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="MerchantName" class="control-label col-lg-4">经营者名称:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="MerchantName" type="text" name="MerchantName"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="Reg_Id" class="control-label col-lg-4">工商注册号/身份证号:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="Reg_Id" type="numbe" name="Reg_Id"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="yyzz" class="control-label col-lg-4">营业执照:</label>
									<div class="col-lg-8">
										<img class="form-control" id="yyzz" name="yyzz" style="width: 150px;height: 150px;" />
										<p class="margin-p" id="yyzznote" name="" style="color: red;"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="PropertyName" class="control-label col-lg-4">经营性质:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="PropertyName" type="text" name="PropertyName"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="TypeName" class="control-label col-lg-4">经营类型:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="TypeName" type="text" name="TypeName"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="Legal_Represent" class="control-label col-lg-4">法人代表:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="Legal_Represent" type="text" name="Legal_Represent"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="Tel" class="control-label col-lg-4">联系电话:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="Tel" type="text" name="Tel"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="Addr" class="control-label col-lg-4">地址:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="Addr" type="text" name="Addr"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="Remark" class="control-label col-lg-4">备注:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="Remark" type="text" name="Remark"></p>
									</div>
								</div>
								<div class="form-group">
									<label for="Record_Date" class="control-label col-lg-4">备案时间:</label>
									<div class="col-lg-8">
										<p class="margin-p" id="Record_Date" type="text" name="Record_Date"></p>
									</div>
								</div>
							</div>
						</div>
						<div class="modal-footer">
							<button id="closeBtn" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
						</div>
					</div>
				</div>
			</div>
			<!-- modal -->

		</section>

		<!-- Placed js at the end of the document so the pages load faster -->
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
		<script src="js/jquery-migrate-1.2.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/modernizr.min.js"></script>
		<script src="js/jquery.nicescroll.js"></script>

		<!--pickers plugins-->
		<script type="text/javascript" src="js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/moment.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/daterangepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>
		<script type="text/javascript" src="js/bootstrapValidator.js"></script>

		<!--bootstrap Table-->
		<script src='js/bootstrap-table.js'></script>
		<script src='js/bootstrap-table-zh-CN.js'></script>
		<script src='js/bootstrap-editable.js'></script>
		<script src='js/bootstrap-table-editable.js'></script>

		<!--pickers initialization-->
		<script src="js/pickers-init.js"></script>

		<!--common scripts for all pages-->
		<script src="js/scripts.js"></script>
		<script src="js/layer.js"></script>
		<script src="js/ysh_comm.js"></script>

		<script>
			var checkList = [];
			var $table = $("#bs");
			var data = [];
			var schParam = {};
			var total = 0; //总数据条数
			
			//表格样式
			function rowStyle(row, index) {
				var classes = ['active', 'success', 'info', 'warning', 'danger'];
				if (index % 2 === 0) {
					return {
						classes: 'warning'
					};
				} else
					return {
						classes: 'info'
					};
			}

			function selectListFormatter(value, row, index) {
				if (value != null && value != undefined) {
					var sl = ["<select id='Id", row.Id, "' class='selectForMobile' >"];
					$.each(value, function(i, v) {
						sl.push("<option value='" + v.value + "' >" + v.text + "</option>");
					});
					sl.push("</select>")
					return sl.join('');
				} else return "";
			}

			function operationFormatter(value, row, index) {
				var result = [
					'<button class="btn btn-info" onclick="gotoAddOrEdit(' + row.Id + ');">编辑</button>', '<button class="btn btn-default" type="button" onclick="showDetail(' + index + ')">详情</button>'
				];
				return result.join(' ');
			}

			function checkformatter(value, row, index) {
				var pIndex = $.inArray(row.Id, checkList);
				if (pIndex >= 0) {
					return {
						checked: true
					}
				} else {
					return {
						checked: false
					}
				}
			}

			function showDetail(index) {
				var pdata = data[index];
				getDataList(yshurl + "Admin_GetSinglePicture", {
					pictype: 9,
					ownid: pdata.Id
				}, function(d) {
					if (d && d.state == 0 && d.aaData) {
						if (d.aaData.length > 0) {
							$("#yyzz").show();
							$("#yyzz").attr('src', imgurl + d.aaData[0].Picurl);
							$("#yyzznote").hide();
						} else {
							$("#yyzz").hide();
							$("#yyzznote").show();
							$("#yyzznote").text("尚未上传营业执照图片");
						}
					} else {
						$("#yyzz").hide();
						$("#yyzznote").show();
						$("#yyzznote").text("读取营业执照图片失败，请稍后再试");
					}
				});
				clearForm();
				initForm(pdata);
				$("#myModal").modal();
			}

			function clearForm() {
				$("#myModal #MerchantId").text('');
				$("#myModal #MarketName").text('');
				$("#myModal #MerchantName").text('');
				$("#myModal #Reg_Id").text('');
				$("#myModal #PropertyName").text('');
				$("#myModal #TypeName").text('');
				$("#myModal #Legal_Represent").text('');
				$("#myModal #Tel").text('');
				$("#myModal #Addr").text('');
				$("#myModal #Remark").text('');
				$("#myModal #Record_Date").text('');
			}

			function initForm(obj) {
				$("#myModal #MerchantId").text(obj.MerchantId);
				$("#myModal #MarketName").text(obj.MarketName);
				$("#myModal #MerchantName").text(obj.MerchantName);
				$("#myModal #Reg_Id").text(obj.Reg_Id);
				$("#myModal #PropertyName").text(obj.PropertyName);
				$("#myModal #TypeName").text(obj.TypeName);
				$("#myModal #Legal_Represent").text(obj.Legal_Represent);
				$("#myModal #Tel").text(obj.Tel);
				$("#myModal #Addr").text(obj.Addr);
				$("#myModal #Remark").text(obj.Remark);
				$("#myModal #Record_Date").text(obj.Record_Date);
			}
			
			/*********  删除  ***********/
			function deleteData(id) {
				ysh_confirm("确定要删除数据？", "确定", "取消", function(ret) {
					if (ret) {
						getDataList(yshurl + 'Admin_BatchDeleteMerchant', {
							ids: id
						}, function(d) {
							if (d && d.state == 0) {
								ysh_msg("删除成功");
								$("#searchBtn").click();
							} else {
								ysh_msg("删除失败");
							}
						});
					}
				});
			}
			
			//批量删除
			function batchDeleteData() {
				if (checkList.length == 0) {
					ysh_msg("请选择需要删除的数据");
					return;
				}
				ysh_confirm("确定要删除数据？", "确定", "取消", function(ret) {
					if (ret) {
						var ids = checkList.join(',');
						getDataList(yshurl + 'Admin_BatchDeleteMerchant', {
							ids: ids
						}, function(d) {
							if (d && d.state == 0) {
								ysh_msg("删除成功");
								$("#searchBtn").click();
							} else {
								ysh_msg("删除失败");
							}
						});
					}
				});
			}
			
			//跳转编辑
			function gotoAddOrEdit(id) {
				window.location.href = 'Admin_AddOrEdit_Record.html?id=' + id;
			}

			function changeHeight() {
				$(window.parent.document).find("#main").attr("height", document.body.scrollHeight);
			}
			
			$(function() {
				//初始化表格
				$table.bootstrapTable({
					pagination: true, //分页
					onCheck: function(row) {
						checkList.push(row.Id);
						$.unique(checkList);
					},
					onUncheck: function(row) {
						$.unique(checkList);
						var pIndex = $.inArray(row.Id, checkList);
						checkList.splice(pIndex, 1);
					},
					onCheckAll: function(rows) {
						$.each(rows, function(index) {
							checkList.push(rows[index].Id);
						});
						$.unique(checkList);
					},
					onUncheckAll: function(rows) {
						$.unique(checkList);
						var filterarray = $.grep(checkList, function(value) {
							var isDel = false;
							for (var i = 0; i < rows.length; i++) {
								if (rows[i].Id == value) {
									isDel = true;
									break;
								}
							}
							return !isDel;
						});
						checkList = filterarray;
					},
					escape: true,
					clickToSelect: false,
					pageList: [10]
				});
				/*********  查询  ***********/
				
				//表格加载数据
				function loadData(f1, data) {
					f1.bootstrapTable('load', data);
					var hashTemp = window.location.hash || "1"
	
					hashTemp = hashTemp.replace("#", "")
					$(".pagination").find('a').each(function() {
						if($(this).text() == hashTemp)
							$(this).click()
					})
				};
			
				//获取数据
				function getData(param, limit, offset, callback) {
					param.limit = limit;
					param.offset = offset;
					getDataList(yshurl + 'Admin_GetMerchant', param, function(d) {
						if (d && d.state == 0) {
							data = d.many[1].rows;
							for (var i = 0; i < data.length; i++) {
								data[i].Record_Date = new Date(data[i].Record_Date).Format('yyyy-MM-dd hh:mm:ss');
							}
							var pdata = {
								total: d.many[0].total[0].total,
								rows: data
							};
							loadData($table, pdata);
							if (typeof callback === 'function') {
								callback();
							}
						} else {
							var pdata = {
								total: 0,
								rows: []
							};
							loadData($table, pdata);
						}
						setIframeHeight();
					});
				}
			
				//点击分页查询
				$table.on('page-change.bs.table', function(e, number, size) {
					var os = (number - 1) * size;
					var lm = size;
					window.location.hash = number;
					getData(schParam, lm, os);
				});
				
				// onhashchange可以监控hash变化
			    window.onhashchange = function() {
			        var hash = window.location.hash;
			        var id;
			        if(hash != ""){
			        	id = parseInt(hash.substr(1));
			        } else{
			        	id = 1
			        }
			        getData(schParam, 10, (id-1)*10);
			       	$("ul.pagination").children().eq(id).addClass("active").siblings().removeClass("active");
			    };

				//保存
				$("#searchBtn").click(function() {
					schParam = convertParams("searchForm");
					if (new Date(schParam.Record_Date_bg) > new Date(schParam.Record_Date_ed)) {
						ysh_msg("备案开始时间不能大于结束时间");
						return;
					}
					var options = $table.bootstrapTable('getOptions');
					options.pageNumber = 1;
					$table.bootstrapTable('refreshOptions', options);
					schParam.Record_Date_bg = schParam.Record_Date_bg + " 00:00:00";
					schParam.Record_Date_ed = schParam.Record_Date_ed + " 23:59:59";
					total = 0;
					data = [];
					//var options = $table.bootstrapTable('getOptions');
					checkList = [];
					getData(schParam, options.pageSize, 0);
				});
				$("#searchBtn").click();
				setIframeHeight();
				leftCancelShade('myModal');
			});
		</script>
	</body>

</html>