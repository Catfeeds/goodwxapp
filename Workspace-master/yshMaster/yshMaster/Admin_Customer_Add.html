<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<meta name="description" content="AddNewCustomer">
		<meta name="author" content="dichao">
		<link rel="shortcut icon" href="#" type="image/png">

		<title>添加用户</title>
		<!--pickers css-->
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datepicker/css/datepicker-custom.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-timepicker/css/timepicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-colorpicker/css/colorpicker.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-daterangepicker/daterangepicker-bs3.css" />
		<link rel="stylesheet" type="text/css" href="js/bootstrap-datetimepicker/css/datetimepicker-custom.css" />
		<link href="css/style.css" rel="stylesheet">
		<link href="css/style-responsive.css" rel="stylesheet">
		<link href="css/bootstrapValidator.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/select2.min.css"/>
		
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
		<!--[if lt IE 9]>
			  <script src="js/html5shiv.js"></script>
			  <script src="js/respond.min.js"></script>
			  <![endif]-->

		<!-- Placed js at the end of the document so the pages load faster -->
		<script src="js/jquery-1.10.2.min.js"></script>
		<script src="js/jquery-ui-1.9.2.custom.min.js"></script>
		<script src="js/jquery-migrate-1.2.1.min.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/modernizr.min.js"></script>
		<script src="js/jquery.nicescroll.js"></script>

		<!--pickers plugins-->
		<script type="text/javascript" src="js/bootstrap-datepicker/js/bootstrap-datepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-datetimepicker/js/bootstrap-datetimepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/moment.min.js"></script>
		<script type="text/javascript" src="js/bootstrap-daterangepicker/daterangepicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-colorpicker/js/bootstrap-colorpicker.js"></script>
		<script type="text/javascript" src="js/bootstrap-timepicker/js/bootstrap-timepicker.js"></script>

		<!--bootstrap Table-->
		<script src='js/bootstrap-table.js'></script>
		<script src='js/bootstrap-table-zh-CN.js'></script>
		<script src='js/bootstrap-editable.js'></script>
		<script src='js/bootstrap-table-editable.js'></script>

		<!--pickers initialization-->
		<script src="js/pickers-init.js"></script>

		<!--common scripts for all pages-->
		<script src="js/layer.js"></script>
		<script src="js/scripts.js"></script>
		<script src="js/ysh_comm.js"></script>
		<script src="js/MD5.js"></script>

		<!--bootStrap Validator-->
		<script type="text/javascript" src="js/bootstrapValidator.js"></script>
		<!--adddate-->
		<script src="js/adddate.js"></script>
		<!--下拉插架-->
		<script src="js/select2.min.js"></script>
		
		<script type="text/javascript">
			checkPermission();
		</script>
	</head>

	<body class="children-body">

		<section>

			<!--body wrapper start-->
			<section>
				<!-- page start-->

				<div class="row">
					<div class="col-lg-12">
						<section class="panel">
							<header class="panel-heading">
								<h2 style="padding-left: 50px;">添加用户</h2>
							</header>
							<div class="panel-body">
								<div class="form">
									<!-- 表格开始-->
									<form class="cmxform form-horizontal adminex-form" id="addUserInfo">

										<div class="form-group">
											<label class="control-label col-lg-3">用户名：</label>
											<div class="col-lg-4">
												<input class=" form-control" id="UserName" name="UserName" type="text" maxlength="20" required/>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="form-group">
											<label class="control-label col-lg-3">登录密码：</label>
											<div class="col-lg-4">
												<input class="form-control " id="Password" type="password" name="Password" value="123456" readonly="readonly" />
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="form-group">
											<label class="control-label col-lg-3">联系电话：</label>
											<div class="col-lg-4">
												<input class=" form-control" id="Phone" name="Phone" maxlength="20" type="text" required/>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>

										</div>

										<div class="form-group ">
											<label class="control-label col-lg-3">所属渠道：</label>
											<div class="col-lg-4">
												<select class="form-control m-bot15" id="Channel" name="Channel">

												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>

										</div>

										<div class="form-group">
											<label class="control-label col-lg-3">所属分组：</label>
											<div class="col-lg-4">
												<select class="form-control m-bot15" id="UserGroup" name="UserGroup">
												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="form-group">
											<label class="control-label col-lg-3">所属团体：</label>
											<div class="col-lg-4">
												<select class="form-control m-bot15" id="Party" name="Party">
												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="form-group ">
											<label class="control-label col-lg-3">用户角色：</label>
											<div class="col-lg-4">
												<select class="form-control m-bot15" onchange="changeRole(this.value)" id="Role" name="Role">
												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>
										<div class="form-group ">
											<label class="control-label col-lg-3">注册来源：</label>
											<div class="col-lg-4">
												<select class="form-control m-bot15" id="Source" name="Source">
												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="form-group ">
											<label class="control-label col-lg-3">所属等级：</label>
											<div class="col-lg-4">
												<select class="form-control m-bot15" id="Grade" name="Grade">
												</select>
											</div>
											<div class="col-lg-1">
												<span style="color:red">*</span>
											</div>
										</div>

										<div class="form-group ">
											<label for="cemail" class="control-label col-lg-3">真实姓名：</label>
											<div class="col-lg-4">
												<input class="form-control " id="CName" type="text" name="CName" maxlength="30" />
											</div>
										</div>

										<div class="form-group ">
											<label for="ccomment" class="control-label col-lg-3">性别：</label>
											<div class="col-lg-4">
												<select class="form-control m-bot15" name="Sex" Id="Sex">
													<option value="男">男</option>
													<option value="女">女</option>
												</select>
											</div>
										</div>

										<div class="form-group ">
											<label for="cemail" class="control-label col-lg-3">出身年月：</label>
											<div class="col-lg-4 col-lg-pull">
												<!--<div data-date-viewmode="years" data-date-format="yyyy-mm-dd" data-date="" class="input-append date dpYears" id="dBirthday">
													<input type="text" readonly="" value="1900-01-01" size="16" class="form-control" id="Birthday" name="Birthday">
													<span class="input-group-btn add-on">
			                                                            <button class="btn btn-primary" type="button"><i class="fa fa-calendar"></i></button>
			                                                          </span>
												</div>-->
												<!--<input type="text" value="1900-01-01" size="16" class="form-control" id="Birthday" name="Birthday">-->
												<!--adddate插件输入控件设置value值不能超过控件最小值-->
												<input type="text" value="1900-01-01" size="16" class="form-control m-bot15" id="Birthday" name="Birthday" onclick="SelectDate(this,'yyyy-MM-dd')" />
											</div>
										</div>

										<div class="form-group ">
											<label for="cemail" class="control-label col-lg-3">邮箱地址：</label>
											<div class="col-lg-4">
												<input class="form-control " id="Email" type="text" name="Email" />
											</div>
										</div>

										<div class="form-group ">
											<label for="cemail" class="control-label col-lg-3">QQ：</label>
											<div class="col-lg-4">
												<input class="form-control " id="QQNum" type="text" name="QQNum" maxlength="15" />
											</div>
										</div>

										<div class="form-group ">
											<label for="cemail" class="control-label col-lg-3">微信账号：</label>
											<div class="col-lg-4">
												<input class="form-control " id="WeiXinNum" type="text" name="WeiXinNum" maxlength="30" />
											</div>
										</div>

										<div class="form-group ">
											<label for="cemail" class="control-label col-lg-3">微博账号：</label>
											<div class="col-lg-4">
												<input class="form-control " id="WeiBoNum" type="text" name="WeiBoNum" maxlength="30" />
											</div>
										</div>

										<div class="form-group">
											<label class="col-sm-3 control-label">备注:</label>
											<div class="col-sm-4">
												<textarea style="resize: none;height: 100px;" rows="7" class="form-control" id="Remark" name="Remark"></textarea>
											</div>
										</div>

										<div class="form-group">
											<div class="col-lg-offset-3 col-lg-4">
												<button class="btn btn-success" type="submit">添加</button>
												<button class="btn btn-danger" type="button" onclick="JumpToCustomerCenter()">取消</button>
											</div>
										</div>

									</form>
									<!-- 表格结束-->
								</div>

							</div>
						</section>

					</div>

					<div class="col-lg-3">

					</div>
				</div>

			</section>

		</section>

		<script>
			var $form = $('#addUserInfo');
			
			//构建select
			function appendSelectList(f1, array) {
				if($.isArray(array)) {
					$.each(array, function(i, v) {
						f1.append("<option value=" + v.value + ">" + v.text + "</option>");
					});
				}
			}

			//下拉列表没有初始值时的赋值为0
			function setNotChildValue(jobj, obj) {
				$.each(jobj, function(i, v) {
					if($(v).has("option").length == 0)
						obj[v.name] = 0;
				});
				return obj;
			}

			// 新增用户提交		
			function submit() {
				//获取数据
				var attrs = $form.serializeArray();
				var res = convertToParams(attrs);
				//判断是否存在Password 存在加密
				if(res.hasOwnProperty('Password'))
					res.Password = md5(res.Password);

				//进行下拉列表值检测
				var $notChild = $("select");
				if($notChild.length > 0) {
					setNotChildValue($notChild, res);
					res.UserGroup = $("#UserGroup").val()
					res.Channel = $("#Channel").val()
					res.Party = $("#Party").val()
				}

				getDataList(yshurl + "Admin_Customer_Add_InsertUserInfo", res, function(d) {
					if(d.state == 0) {
						if(d.aaData[0][0].$IsNeedStore) {
							ysh_confirm("还未备案，是否现在去备案？", "确定", "取消", function(ret) {
								if(ret) {
									window.location.href = 'Admin_AddOrEdit_Record.html?id=' + 0 + '&userid=' + d.aaData[0][0].$UserId;
								} else {
									ysh_msg("用户添加成功");
									setTimeout(function() {
										window.location.href = "Admin_CustomerCenter.html"
									}, 1500);
								}
							})
						} else {
							ysh_msg("用户添加成功");
							setTimeout(function() {
								window.location.href = "Admin_CustomerCenter.html"
							}, 1500);
						}
					} else ysh_alert("系统出错啦，请刷新或者联系客服", "error");
				});
			}

			//根据渠道加载分组
			function getGroupByChannel(channel, callback) {
				getDataList(yshurl + "Admin_CustomerCenter_getGroupByChannel", {
					SelectChannel: channel
				}, function(d) {
					appendSelectList($("#UserGroup"), d.aaData);
					callback && callback()
				});
			}
			//根据渠道加载团体
			function getPartyByChannel(channel, callback) {
				getDataList(yshurl + "Admin_CustomerCenter_getPartyByChannel", {
					SelectChannel: channel
				}, function(d) {
					appendSelectList($("#Party"), d.aaData);
					callback && callback()
				});
			}

			$("#Channel").on("change", function() {
				$("#UserGroup").empty();
				$("#Party").empty();
				getGroupByChannel($("#Channel option:selected").val());
				getPartyByChannel($("#Channel option:selected").val());
			});

			//数组转成对象
			function convertToParams(array) {
				var obj = {};

				if($.isArray(array)) {
					$.each(array, function(i, v) {

						obj[v.name] = v.value;
					})
				}
				return obj;
			}

			$(function() {
				getDataList(yshurl + "Admin_Customer_Add_GetSearchInfo", {
					pUserId: 0
				}, function(d) {

					appendSelectList($("#Channel"), d.aaData[0]);
					appendSelectList($("#Role"), d.aaData[1]);
					appendSelectList($("#Source"), d.aaData[2]);
					appendSelectList($("#Grade"), d.aaData[3]);
					getGroupByChannel($("#Channel option:selected").val());
					getPartyByChannel($("#Channel option:selected").val());

					$form.bootstrapValidator({
						message: '输入数据格式不对请确认后重新输入',
						feedbackIcons: {
							valid: 'glyphicon glyphicon-ok',
							invalid: 'glyphicon glyphicon-remove',
							validating: 'glyphicon glyphicon-refresh'
						},
						fields: {
							UserName: {
								validators: {
									notEmpty: {
										message: '用户名不能为空'
									},
									stringLength: {
										min: 10,
										max: 15,
										message: '用户名长度必须在10-15之间'
									},
									callback: {
										message: '已存在相同的用户名',
										callback: function(value, validator) {
											var flag = false;
											getDataList(yshurl + "Admin_CustomerCenter_ValiUser", {
												UserName: value,
												UserId: 0
											}, function(d) {
												if(d.aaData[0].result == 0)
													flag = true;
											});
											if(value == "")
												flag = true;

											return flag;
										}
									},
									regexp: {
										regexp: /^((\+?86)|(\(\+86\)))?(13[012356789][0-9]{8}|15[012356789][0-9]{8}|17[012356789][0-9]{8}|18[012356789][0-9]{8}|147[0-9]{8}|1349[0-9]{7})$/,
										message: '用户名必须为手机号'
									}
								}
							},
							Phone: {
								validators: {
									notEmpty: {
										message: '联系电话不能为空'
									},
									stringLength: {
										min: 10,
										max: 15,
										message: '联系电话长度必须在10-15之间 '
									},
									callback: {
										message: '请输入正确的联系电话',
										callback: function(value, validator) {
											var flag = true;
											flag = mobileCheck(value);
											if(value == "")
												flag = true;

											return flag;
										}
									}
								}
							},
							Email: {
								validators: {
									regexp: {
										regexp: /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/,
										message: '请输入正确的电子邮箱'
									}
								}
							},
							QQNum: {
								validators: {
									stringLength: {
										min: 0,
										max: 15,
										message: 'QQ号长度不超过15位'
									},
									regexp: {
										regexp: /^[0-9]*$/,
										message: 'QQ号只能为数字'
									}
								}
							},
							WeiXinNum: {
								validators: {
									stringLength: {
										min: 0,
										max: 30,
										message: '微信号长度在0-30之间 '
									}
								}
							},
							WeiBoNum: {
								validators: {
									stringLength: {
										min: 0,
										max: 30,
										message: '微博号长度在0-30之间 '
									}
								}
							},
							CName: {
								validators: {
									stringLength: {
										min: 2,
										max: 30,
										message: '真实姓名长度必须在2-30之间 '
									},
									regexp: {
										regexp: /^[\u4E00-\u9FA5a-zA-Z]+$/,
										message: '真实姓名不能包含特殊字符'
									}
								}
							},
							Remark: {
								validators: {
									stringLength: {
										min: 0,
										max: 500,
										message: '备注长度不能超过500个字符'
									}
								}
							}
						}

					}).on('success.form.bv', function(e) {
						e.preventDefault();
						submit();
					});

				});

				setIframeHeight();
			});

			//点击取消跳转用户中心
			function JumpToCustomerCenter() {
				location.href = "Admin_CustomerCenter.html"
			}

			//解决确定取消按钮被隐藏一般
			$(".btn-success").on("click", function() {
				var $parent = $(window.parent.document);
				$parent.find("#main").attr("height", "1500")
			})

			function changeRole(rid) {
				var url = yshurl + "SETchannelAndGroupBYrole"
				var param = {
					rid: rid
				}
				getDataList(url, param, function(rea) {
					if(rea.aaData[0][0].return_value != 0 && rea.aaData[0][0].return_value != "undefined") {
						$("#Channel").val(rea.aaData[0][0].ChannelId)
						var Uidd = rea.aaData[0][0].Id
						$("#UserGroup").empty()
							//						$("#Party").empty()

						getPartyByChannel($("#Channel option:selected").val(), function() {
							$("#Party").val(rea.aaData[0][0].partyId)
							$("#Party").prop('disabled', true)
						});
						getGroupByChannel($("#Channel option:selected").val(), function() {
							$("#UserGroup").val(Uidd)
							$("#Channel").prop('disabled', true)
							$("#UserGroup").prop('disabled', true)
						});
					} else {
						$("#Channel").prop('disabled', false)
						$("#Party").prop('disabled', false)
						$("#UserGroup").prop('disabled', false)
					}
				}, true)
			}
		</script>
		<script type="text/javascript">
			$(function(){
				$('select').select2();
			})
		</script>

		<!--
	作者：443267568@qq.com
	时间：2016-05-03
	描述：修改结束
-->
	</body>

</html>