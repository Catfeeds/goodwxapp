function getMySignature(a,e){$.ajax({type:"get",url:"http://shunde.vizen.cn/shunde/inner/upload/sign?remotePath="+a,success:function(a){var t=JSON.parse(a);"0"==t.code?e(t):alert(t.msg)}})}function setMusicName(a){$("#musicUrl").val(a)}function setLogo(a){$("#showLogoImg").attr("src",a),$("#logoUrl").val(a)}function setCover(a){$("#showCoverImg").attr("src",a),$("#coverUrl").val(a)}function setPcCover(a){$("#showPcCoverImg").attr("src",a),$("#pcCoverUrl").val(a)}function upload(a,e,t,n){$.ajax({type:"get",url:url_root+"/cos/signature?path="+a,success:function(a){0==a.result?t&&t(a.data,e,n):alert(a.msg)}})}function uploadToQcloud(a,e,t){var n="http://sh.file.myqcloud.com/files/v2/10002033/panopublictest/shunde/file/"+a.path+"?sign="+encodeURIComponent(a.signature),l=null;if(window.FormData){var l=new FormData;l.append("filecontent",e),l.append("op","upload"),l.append("insertOnly","0")}$.ajax({type:"post",url:n,processData:!1,contentType:!1,data:l,xhrFields:{withCredentials:!1},success:function(a){0==a.code?t(a):alert(a.msg)}})}function uploadToLuna(a,e,t){var n=luna_root+"/luna-web/common/merchant/upload",l=null;if(window.FormData){var l=new FormData;l.append("type",t||"pic"),l.append("file",a),l.append("resource_type","app")}$.ajax({type:"post",url:n,dataType:"json",processData:!1,contentType:!1,data:l,success:function(a){console.log("data",a),0==a.code?e(a.data.access_url):alert(a.msg)}})}function getData(){$.ajax({type:"get",url:url_root+"/album/get",data:{albumId:albumUpdateObject.albumId,lang:localStorage.langStr},success:function(a){if(0==a.result){albumUpdateObject=a.data;var e=a.data;e.albumContent=$.parseJSON(e.albumContent),backfillCover(e.albumContent.features)}else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}function backfillCover(a){a&&1==Boolean(a.coverflag)?($("#coverText").val(a.cover_text),$("#setCoverPage").show(),$("#openCover").prop("checked",!0),$("#logoUrl").val(a.cover_logo_url),$("#showLogoImg").attr("src",a.cover_logo_url),a.cover_logo_url||$("#showLogoImg").attr("src","../images/logo-default.png"),$("#coverUrl").val(a.h5_cover_url),$("#musicUrl").val(a.music_url),$("#showCoverImg").attr("src",a.h5_cover_url),$("#pcCoverUrl").val(a.pc_cover_url),$("#showPcCoverImg").attr("src",a.pc_cover_url)):(a?($("#setCoverPage").hide(),$("#openCover").prop("checked",!1)):($("#setCoverPage").show(),$("#openCover").prop("checked",!0)),$("#coverText").val(""),$("#logoUrl").val(""),$("#showLogoImg").attr("src","../images/logo-default.png"),$("#coverUrl").val(""),$("#showCoverImg").attr("src","../images/cover-default.jpg"),$("#pcCoverUrl").val(""),$("#showPcCoverImg").attr("src","../images/pc-cover-default.jpg"))}function updateAlbumCover(a){if(albumUpdateObject.albumContent.features||(albumUpdateObject.albumContent.features={}),albumUpdateObject.albumContent.features.coverflag=$("#openCover").is(":checked"),albumUpdateObject.albumContent.features.cover_logo_url=$("#logoUrl").val(),albumUpdateObject.albumContent.features.h5_cover_url=$("#coverUrl").val(),albumUpdateObject.albumContent.features.pc_cover_url=$("#pcCoverUrl").val(),albumUpdateObject.albumContent.features.cover_text=$("#coverText").val(),albumUpdateObject.albumContent.activeStep=5,albumUpdateObject.albumContent.features.coverflag){if(!albumUpdateObject.albumContent.features.h5_cover_url){new Dialog({title:"提示",content:"手机封面不能为空"});return}if(!albumUpdateObject.albumContent.features.pc_cover_url){new Dialog({title:"提示",content:"PC封面不能为空"});return}}var e=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:e,success:function(e){if(0==e.result)albumUpdateObject=e.data,albumUpdateObject.albumContent=$.parseJSON(albumUpdateObject.albumContent),"function"==typeof a&&a(e);else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})}function getSwitchData(){$.ajax({type:"get",url:url_root+"/album/get",data:{albumId:albumUpdateObject.albumId,lang:localStorage.langStr},success:function(a){if(0==a.result){albumUpdateObject=a.data;var e=a.data;e.albumContent=$.parseJSON(e.albumContent),backfillCover(e.albumContent.features),setSwitch(e.albumContent.features)}else 2==a.result?loginDialog():new Dialog({title:"提示",content:a.msg})}})}function setSwitch(a){null==a.vrflag&&(a.vrflag="1"),null==a.gravityflag&&(a.gravityflag="1"),null==a.musicflag&&(a.musicOn="0"),null==a.musicflag&&(a.autoplayflag="0"),"1"==a.vrflag?(vrDiv.className="open1",vrDiv2.className="open2",vrOn="1"):"0"==a.vrflag&&(vrDiv.className="close1",vrDiv2.className="close2",vrOn="0"),albumUpdateObject.albumContent.features.vrflag=vrOn,"1"==a.gravityflag?(weightDiv.className="open1",weightDiv2.className="open2",weightOn="1"):"0"==a.gravityflag&&(weightDiv.className="close1",weightDiv2.className="close2",weightOn="0"),albumUpdateObject.albumContent.features.gravityflag=weightOn,"1"==a.autoplayflag?(rotationDiv.className="open1",rotationDiv2.className="open2",rotationOn="1"):"0"==a.autoplayflag&&(rotationDiv.className="close1",rotationDiv2.className="close2",rotationOn="0"),albumUpdateObject.albumContent.features.autoplayflag=rotationOn,"1"==a.musicflag?(musicDiv.className="open1",musicDiv2.className="open2",musicOn="1",$(".musicOn").css("display","")):"0"==a.musicflag&&(musicDiv.className="close1",musicDiv2.className="close2",musicOn="0",$(".musicOn").css("display","none")),albumUpdateObject.albumContent.features.musicflag=musicOn,null==albumUpdateObject.albumContent.tipsList&&(albumUpdateObject.albumContent.tipsList=[]);for(var e=0;e<albumUpdateObject.albumContent.tipsList.length;e++)setTips(albumUpdateObject.albumContent.tipsList[e],-1)}function setAlbumDisplay(a){for(var e=$(".step-wrap-7.sub-step-0 .album-content-3");document.getElementById("qr-code").hasChildNodes();)document.getElementById("qr-code").removeChild(document.getElementById("qr-code").firstChild);e.find(".albumName").html(a.albumContent.albumName),e.find(".albumId").html(a.albumId),e.find(".albumInfo").html(a.albumContent.albumInfo),e.find(".albumUrl").html(url_root+"/album/view/"+a.albumId+"?lang="+localStorage.langStr),e.find(".albumPreview").html(' <a href="'+pano_url+"?albumId="+a.albumId+"&lang="+localStorage.langStr+'&vrflag=on " target="_blank">'+pano_url+"?albumId="+a.albumId+"&lang="+localStorage.langStr+"&vrflag=on</a>"),new QRCode(document.getElementById("qr-code"),pano_url+"?albumId="+a.albumId+"&lang="+localStorage.langStr+"&vrflag=on")}function setAlbumTree(a,e,t){a.empty();var n=e||"8B1EA23D936D44008A424EF0663311DD";$.ajax({type:"get",url:url_root+"/album/get",data:{albumId:n,lang:localStorage.langStr},success:function(e){if(0==e.result){var n=e.data;n.albumContent=$.parseJSON(n.albumContent),setAlbumTreelayer(a,n.albumContent),setAlbumDisplay(n),t&&t()}else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})}function setAlbumTreelayer(a,e){var t=addLayerTree(a,e);if(isNeedEmptyDiv(a.children(".layer").find(".images")),e.panoList.length){var n=t.find(".images");n.find(".empty").remove(),addImageTree(n,e.panoList)}e.albumList.length&&$.each(e.albumList,function(a,e){setAlbumTreelayer(t,e)})}function addLayerTree(a,e){var t='<li><span class="bold">'+e.albumName+'</span><ul class="images"></ul></li>';a.children("ul").length||a.append($('<ul class="images"></ul>'));var n=$(t);return a.children("ul").append(n),n}function addImageTree(a,e){$.each(e,function(e,t){if("album"==t.type)var n='<li class="leaf"><span>'+t.albumName+'<span class="album-type"></span></span></li>';else var n='<li class="leaf"><span>'+t.panoName+"</span></li>";a.append($(n))})}function lightUpNavStep(a){var e=$(".nav-img .step-item");e.removeClass("active");for(var t=0;t<=a;t++)$(e[t]).addClass("active");"5"==a&&$(e[6]).addClass("active")}function focusNavStep(a){var e=$(".nav-img .step-item");e.removeClass("focus"),$(e[a]).addClass("focus")}function navToStep(a,e){lightUpNavStep(albumUpdateObject&&albumUpdateObject.albumContent?albumUpdateObject.albumContent.completedSteps:0),focusNavStep(a),$(".step-wrap").hide(),$(".step-wrap-"+a+".sub-step-"+e).show()}function clearQuery(){refreshImagesDialog($(".js-search-wrapper"),[],!0),$(".panoQuery").val("")}function addNavEvent(){function a(a){albumUpdateObject.albumContent.status=1;var e=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?updateMeta=true&lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:e,success:function(e){navToStep(7,0),$("#step-item-last").addClass("active"),a&&a(e)}}),$.ajax({type:"get",url:"http://shunde.vizen.cn/shunde/stat/reportDeplyPanoAblum?panoAlbumId="+albumUpdateObject.albumId+"&userId="+window.uniqueID+"&panoAlbumName="+albumUpdateObject.albumContent.albumName,success:function(a){}})}$(".nav-img").on("click",".step-item.active",function(){var a=$(this);if(a.hasClass("focus")){var e=a.attr("stepNo")-1;switch(e){case 0:albumUpdateObject=null}navToStep(e,0)}else{var e=a.attr("stepNo")-1;switch(e){case 0:albumUpdateObject=null;break;case 1:setAlbum($(".album.tree"),albumUpdateObject.albumId),clearQuery();break;case 2:setAlbumPicture(albumUpdateObject.albumId,function(){addPictureSelEvt()});break;case 3:setAlbum($(".step-wrap-3.sub-step-0 .js-img-edit-contain"),albumUpdateObject.albumId,function(){var a=$($(".step-wrap-3.sub-step-0 .js-img-edit-contain .image:first-child")[0]);a.addClass("active"),editPanoInfo(a.data()),setPanoAttr(a.data()),addEditPanoEvent()});break;case 4:setAlbum($(".step-wrap-4.sub-step-0 .img-marker-edit-contain"),albumUpdateObject.albumId,function(){$(".img-marker-edit-contain [data-is-with-markers]").hide();var a=$('.img-marker-edit-contain [data-is-with-markers="1"]');a.show();var e=$(a[0]);a.length?$(".no-marker-error").hide():$(".no-marker-error").show(),e.addClass("active"),setMarkerAttrVisible(),editPanoMarkerInfo(e.data()||{}),addEditMarkerEvent(),setMarkerTable(e),setMarkers(e),setMarkerActive($($(".js-markers-table tr.marker")[0])),$(".step-wrap-4.sub-step-0 #addMarkerDiv").empty()},!0);break;case 5:getData();break;case 6:getSwitchData();break;case 7:setAlbumTree($(".step-wrap-7.sub-step-0 .pano-topo"),albumUpdateObject.albumId,function(){})}navToStep(e,0)}}),$(".step-wrap-0.sub-step-0 .js-album-search").click(function(){search0()}),$(".step-wrap-0.sub-step-0 #albumQuery0").keydown(function(a){13==a.keyCode&&search0()}),$(".step-wrap-0.sub-step-1 .btn-next").click(function(){addedPanoIds=[],localStorage.langStr="",setAlbum($(".album.tree"),albumUpdateObject.albumId,function(){(!albumUpdateObject.albumContent.completedSteps||albumUpdateObject.albumContent.completedSteps<1)&&(albumUpdateObject.albumContent.completedSteps=1),navToStep(1,0),clearQuery()})}),$(".step-wrap-0.sub-step-2 .btn-next").click(function(){var a=$('input[name="albums"]:checked').val();if(a)localStorage.langStr="",setAlbum($(".album.tree"),a,function(){(!albumUpdateObject.albumContent.completedSteps||albumUpdateObject.albumContent.completedSteps<1)&&(albumUpdateObject.albumContent.completedSteps=1),navToStep(1,0),clearQuery()});else{new Dialog({title:"提示",content:"请选择要编辑的相册！"})}}),$(".step-wrap-1.sub-step-0 .btn-next").click(function(){updateAlbum(albumUpdateObject.albumContent,".tree>ul>li"),albumUpdateObject.albumContent.completedSteps<1&&(albumUpdateObject.albumContent.completedSteps=1),albumUpdateObject.albumContent.activeStep=1;var a=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:a,success:function(a){if(0==a.result)setAlbumPicture(albumUpdateObject.albumId,function(){addPictureSelEvt()}),navToStep(2,0);else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}),$(".step-wrap-2.sub-step-0 .btn-next").click(function(){albumUpdateObject.albumContent.completedSteps<2&&(albumUpdateObject.albumContent.completedSteps=2),albumUpdateObject.albumContent.activeStep=2,updateAlbumPicture(albumUpdateObject.albumContent,".js-picture-table>.ul>.li");var a=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:a,success:function(a){if(0==a.result)setAlbum($(".step-wrap-3.sub-step-0 .js-img-edit-contain"),a.data.albumId,function(){var a=$($(".step-wrap-3.sub-step-0 .js-img-edit-contain .image:first-child")[0]);a.addClass("active"),editPanoInfo(a.data()),setPanoAttr(a.data()),addEditPanoEvent()}),navToStep(3,0);else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}),$(".step-wrap-3.sub-step-0 .btn-complete").click(function(){albumUpdateObject.albumContent.completedSteps<3&&(albumUpdateObject.albumContent.completedSteps=3),albumUpdateObject.albumContent.activeStep=3,savepanoInfo(),updateAlbum(albumUpdateObject.albumContent,".js-img-edit-contain>ul>li");var a=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:a,success:function(a){if(0==a.result)setAlbum($(".step-wrap-4.sub-step-0 .img-marker-edit-contain"),a.data.albumId,function(){$(".img-marker-edit-contain [data-is-with-markers]").hide();var a=$('.img-marker-edit-contain [data-is-with-markers="1"]');a.show();var e=$(a[0]);a.length?$(".no-marker-error").hide():$(".no-marker-error").show(),e.addClass("active"),setMarkerAttrVisible(),editPanoMarkerInfo(e.data()||{}),addEditMarkerEvent(),setMarkerTable(e),setMarkers(e),setMarkerActive($($(".js-markers-table tr.marker")[0])),$(".step-wrap-4.sub-step-0 #addMarkerDiv").empty()},!0),navToStep(4,0);else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}),$(".step-wrap-4.sub-step-0 .btn-complete").click(function(){albumUpdateObject.albumContent.completedSteps<4&&(albumUpdateObject.albumContent.completedSteps=4),albumUpdateObject.albumContent.activeStep=4,saveMarkerInfo(),saveMarkersToImage(),updateAlbum(albumUpdateObject.albumContent,".img-marker-edit-contain>ul>li",!0);var a=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?updateMeta=true&lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:a,success:function(a){if(0==a.result)getData(),navToStep(5,0);else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}),$(".step-wrap-5.sub-step-0 .btn-complete").click(function(){albumUpdateObject.albumContent.completedSteps<5&&(albumUpdateObject.albumContent.completedSteps=5),albumUpdateObject.albumContent.activeStep=5,updateAlbumCover(function(a){navToStep(6,0)})}),$(".step-wrap-6.sub-step-0 .btn-complete").click(function(){albumUpdateObject.albumContent.tipsList=[],albumUpdateObject.albumContent.tipsList=getTips(),console.log(albumUpdateObject.albumContent.tipsList),albumUpdateObject.albumContent.completedSteps<7&&(albumUpdateObject.albumContent.completedSteps=7),albumUpdateObject.albumContent.activeStep=7,a(function(a){setAlbumTree($(".step-wrap-7.sub-step-0 .pano-topo"),a.data.albumId)})})}function loginDialog(){var a="用户未登录，请先登录。";localStorage.userName&&(a="登录超时，请重新登录。"),alert(a)}function getQueryString(a){var e=new RegExp("(^|&)"+a+"=([^&]*)(&|$)","i"),t=window.location.search.substr(1).match(e);return null!=t?unescape(t[2]):null}function login(){}function Dialog(a){container=a.container||document.body,width=a.width,height=a.height,topCss=a.top,autoClose=a.autoClose;var e=this,t='<div class="modal-footer">';$.each(a.buttons,function(a,e){t+='<button type="button" class="btn-vb btn-success-vb btn-dialog-'+e.type+'">'+e.text+"</button>"}),t+="</div>";var n='<div class="modal-album"><div class="modal-dialog" style="'+(width?"width:"+width+";":"")+(height?"height:"+height+";":"")+(topCss?"top:"+topCss+";":"")+'"><div class="modal-content">'+(a.title?'<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title">'+a.title+"</h4></div>":"")+'<div class="modal-body">'+a.content+"</div>"+(autoClose?"":a.buttons?t:'<div class="modal-footer"><button type="button" class="btn-vb btn-success-vb js-save">确定</button></div>')+"</div></div></div>";e.dialogDiv=$(n),$.each(a.buttons,function(a,t){e.dialogDiv.on("click",".btn-dialog-"+t.type,function(){t.fn(e.dialogDiv)})}),$(container).append(this.dialogDiv),a.initEvt&&a.initEvt(this.dialogDiv),a.autoSearch&&a.autoSearch(this.dialogDiv),this.dialogDiv.find(".close").click(function(){e.dialogDiv.remove()}),this.dialogDiv.find(".js-save").click(function(){e.fnSave(e.dialogDiv,a.ok,a.isOpenOnSave)}),autoClose&&setTimeout(function(){e.dialogDiv&&e.dialogDiv.remove()},1e3)}function removeDialogModalBottomCss(){$(".modal-dialog").height()>$(".modal-album").height()&&$(".modal-album").css("bottom","initial")}function createAlbum(a,e){var t=url_root+("manual"==a?"/album/create":"/album/createDefault?panoId="+e.panoId+"&albumName="+e.albumName);$.ajax({type:"post",url:t,contentType:"application/json; charset=utf-8",data:e,success:function(a){if(0==a.result)albumUpdateObject=a.data,albumUpdateObject.albumContent=$.parseJSON(albumUpdateObject.albumContent),albumUpdateObject.albumContent.completedSteps=0,$(".album-show .albumName").html(albumUpdateObject.albumContent.albumName),$(".album-show .albumInfo").html(albumUpdateObject.albumContent.albumInfo),$(".album-show .albumDetail").html(albumUpdateObject.albumContent.albumDetail),navToStep(0,1);else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}function createManualAlbum(){var a=$("#albumName").val(),e=$("#albumInfo").val(),t=$("#albumDetail").val();if(a&&e&&t){createAlbum("manual",JSON.stringify({albumContent:JSON.stringify({albumName:a,albumInfo:e,albumDetail:t})}))}else{new Dialog({title:"提示",content:"相册名称、相册介绍、相册描述不能为空！"})}}function createDefaultAlbum(){var a=$("#panoIdNew").val(),e=$("#albumNameNew").val();if(a&&e)createAlbum("default",{panoId:a,albumName:e});else{new Dialog({title:"提示",content:"反查panoID、相册名称不能为空！"})}}function rendAlbumsTable(a,e,t){var n=e||1,l=t||5,i={q:a,fromPage:n,size:l};albumSearchObj=i,$.ajax({type:"get",url:url_root+"/album/search",data:i,success:function(a){if(0==a.result){var e=a.data.searchResult;rendPagination(a.data.totalPage,n,l);var t=$(".step-wrap-0.sub-step-2 .js-albums tbody");t.find("tr.tr").remove(),$.each(e,function(a,e){var n='<tr class="tr" data-album-id="'+e.albumId+'"><td></td><td class="link">'+e.albumName+'</td><td class="word-break">'+e.albumId+'</td><td><div class="text-overflow" title="'+e.albumInfo+'">'+e.albumInfo+"</div></td><td>"+e.createDate+"</td><td>"+e.updateDate+'</td><td class="v-middle"><span title="复制" class="copy-album"></td></tr>',l=$(n);t.append(l)})}else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}function rendVersion(a,e){$.each(a,function(a,t){e.find(".version-"+t.lang).html('<span class="pen"></span><span class="del-lang"></span>')})}function rendPagination(a,e,t){var n=getPages(a,e,2),l=$(".step-wrap-0.sub-step-2 ul.pagination");l.empty(),$.each(n,function(a,e){var t='<li class="'+e.status+'" data-page="'+e.number+'"><a><span>'+e.label+"</span></a></li>";l.append($(t))}),l.off().on("click","li",function(){rendAlbumsTable($("#albumQuery1").val(),$(this).data("page"),t)})}function search0(){if(null!=data2.albumId)var a=data2.albumId;else var a=$("#albumQuery0").val();if(a)rendAlbumsTable(a),$("#albumQuery1").val(a),addAlbumsTableEvent(),navToStep(0,2);else{new Dialog({title:"提示",content:"请输入相册名称/ID！"})}}function search1(){var a=$("#albumQuery1").val();if(a)rendAlbumsTable(a);else{new Dialog({title:"提示",content:"请输入相册名称/ID！"})}}function addAlbumsTableEvent(){$(".step-wrap-0.sub-step-2 .js-album-search1").off().click(function(){search1()}),$(".step-wrap-0.sub-step-2 #albumQuery1").off().keydown(function(a){13==a.keyCode&&search1()})}function addAlbumsSearchEvent(){$(".js-albums").on("click",".del-album",function(){var a=this,e=$(a).closest("tr").data("albumId");new Dialog({title:"删除相册",content:"确定删除该相册？",ok:function(){deleteAlbum(e)}})}),$(".js-albums").on("click",".link",function(){var a=$(this).closest("tr").data("albumId");localStorage.langStr="",window.open(pano_url+"?albumId="+a+"&lang="+localStorage.langStr+"&vrflag=on"),$(".header .descrip").html("业务编辑")}),$(".js-albums").on("click",".copy-album",function(){var a=this;copyAlbum($(a).closest("tr").data("albumId"))}),$(".js-albums").on("click",".version-en .add-lang",function(){var a=this,e=$(a).closest("tr").data("albumId");$.ajax({type:"post",url:url_root+"/album/createLang?albumId="+e+"&lang=en",success:function(e){if(0==e.result){new Dialog({title:"提示",content:"创建英文版本成功！"});$(a).closest(".version-en").html('<span class="pen"></span><span class="del-lang"></span>')}else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})}),$(".js-albums").on("click",".version-en .del-lang",function(){var a=this,e=$(a).closest("tr").data("albumId");new Dialog({title:"删除相册版本",content:"确定删除该相册版本？",ok:function(){$.ajax({type:"get",url:url_root+"/album/delete",data:{albumId:e,lang:"en"},success:function(e){if(0==e.result){$(a).closest(".version-en").html('<span class="add-lang">创建</span>')}else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})}})}),$(".js-albums").on("click",".version-en .pen",function(){var a=this,e=$(a).closest("tr").data("albumId");localStorage.langStr="en",setAlbum($(".album.tree"),e,function(){(!albumUpdateObject.albumContent.completedSteps||albumUpdateObject.albumContent.completedSteps<1)&&(albumUpdateObject.albumContent.completedSteps=1),navToStep(1,0)}),$(".header .descrip").html('业务编辑<span class="language">(英语)</span>')})}function deleteAlbum(a){$.ajax({type:"get",url:url_root+"/album/delete",data:{albumId:a},success:function(a){if(0==a.result)rendAlbumsTable(albumSearchObj.q,albumSearchObj.fromPage,albumSearchObj.size);else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}function copyAlbum(a){new Dialog({title:"复制相册",content:'<div class="copyAlbumDialog"><div class="input-item"><span class="input-item-ico">相册名称</span><input type="text" id="albumName" class="" placeholder="相册名称"></div></div>',ok:function(e){albumName=e.find("#albumName").val(),copyAlbumAjax(a,albumName)}})}function copyAlbumAjax(a,e){$.ajax({type:"post",url:url_root+"/album/copy",data:{albumId:a,albumName:e},success:function(a){if(0==a.result){new Dialog({title:"提示",content:"已复制该专题，可以在发布管理-草稿箱中查看编辑。"})}else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}function addAlbumInitEvt(){$(".js-btn-album-new").click(function(){switch($(".new-album-container #albumType").val()){case"default":createDefaultAlbum();break;case"manual":createManualAlbum()}}),$(".new-album-container #albumType").on("change",function(){$(".album-type-wrap").hide();var a=$(".new-album-container #albumType").val();$(".album-type-wrap-"+a).show()});$(".js-pano-id-search").on("click",function(){new Dialog({title:"添加照片",content:'<div><div class="search input-group"><input type="text" class="panoQuery form-control" placeholder="输入项目名称全文检索"><span class="input-group-addon js-pano-search"></span></div><div class="tags"></div><div class="tab-content"><div class="item1New tab-pane img-contain"><div class="images add-image addedimages"><div class="wrap"></div></div></div></div></div>',width:"818px",ok:function(a){var e=a.find(".image.selected"),t=e.data("panoId");$("#panoIdNew").val(t)},initEvt:function(a){addDilaogEvent(a)}});removeDialogModalBottomCss()})}function updateAlbum(a,e,t){var n=$(e),l=n.children(".layer").find(".name");a.albumName=l.data("albumname"),a.albumInfo=l.data("albumdescrip"),void 0!==l.data("albumdetail")&&(a.albumDetail=l.data("albumdetail"));var i=n.children(".layer").find(".images .image");a.panoList=[],$.each(i,function(e,n){var l=$(n).data();delete l.sortableItem,delete l.selectableItem,t?storeMarkers($(n),l):l.markers&&(l.markers[0]&&l.markers[0].mtype||(l.markers=$.parseJSON(l.markers))),a.panoList.push(l)}),a.albumList=[],n.children("ul").length&&$.each(n.children("ul").children("li"),function(e,n){var l={};updateAlbum(l,n,t),a.albumList.push(l)})}function setAlbum(a,e,t,n){a.empty(),addedPanoIds=[],addedAlbumIds=[];var l=e;$.ajax({type:"get",url:url_root+"/album/get",async:!1,data:{albumId:l,lang:localStorage.langStr},success:function(e){if(0==e.result){albumUpdateObject=e.data;var l=e.data;l.albumContent=$.parseJSON(l.albumContent),n&&(markersArrayArray=[]),setAlbumlayer(a,l.albumContent,n),t&&t()}else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})}function setAlbumlayer(a,e,t){var n=addLayer(a,e);if(isNeedEmptyDiv(a.children(".layer").find(".images")),e.panoList&&e.panoList.length){var l=n.children(".layer").find(".images");l.find(".empty").remove(),addImage(l,e.panoList,t)}e.albumList&&e.albumList.length&&$.each(e.albumList,function(a,e){setAlbumlayer(n,e,t)})}function addImage(a,e,t){$.each(e,function(e,n){if("album"==n.type)addAlbumImage(a,n);else{addedPanoIds.push(n.panoId);var l='<div class="image" ',i=null;$.each(n,function(a,e){var t="A".charCodeAt(),n="Z".charCodeAt(),r="a".charCodeAt()-t,o=a.split("");$.each(o,function(a,e){var l=e.charCodeAt();l<=n&&l>=t&&(o[a]="-"+String.fromCharCode(1*l+r))}),a=o.join(""),"markers"==a&&(i=e),l+="data-"+a+'="'+e+'" '}),l+='" style="background-image:url('+n.thumbnailUrl+')"><div class="image-title">'+n.panoName+'</div><span class="del">&#10005</span></div>';var r=$(l);if(n.markers&&n.markers[0]&&n.markers[0].mtype?r.data("markers",JSON.stringify(i)):(r.data("markers",JSON.stringify(null)),r.attr("data-markers",JSON.stringify(null))),a.append(r),t){setMarkerArrayArray($(".js-img-marker-edit-contain .image").index(r),n)}}})}function addAlbumImage(a,e){var t=!0;a.parents(".step-wrap").hasClass("step-wrap-1")||(t=!1),addedAlbumIds.push(e.albumIncludedId);var n='<div class="image image-album" ';null!==e.thumbnailUrl?n+='style="background-image:url('+e.thumbnailUrl+");":n+='style="',n+=(t?'"':'display:none;"')+'><div class="image-title">'+e.albumName+'<span class="album-type"></span></div><span class="del">&#10005</span></div>';var l=$(n);l.data("albumIncludedId",e.albumIncludedId),l.attr("data-album-included-id",e.albumIncludedId),l.data("albumName",e.albumName),l.attr("data-album-name",e.albumName),l.data("thumbnailUrl",e.thumbnailUrl),l.attr("data-thumbnail-url",e.thumbnailUrl),l.data("type","album"),l.attr("data-type","album"),a.append(l)}function addLayer(a,e){var t='<li><div class="layer"><div class="layer-bar"><span class="name" data-albumName="'+e.albumName+'" data-albumDescrip="'+e.albumInfo+(e.albumDetail?'" data-albumDetail="'+e.albumDetail:"")+'">'+e.albumName+'</span><span class="pen"></span><span class="del-layer"></span><span class="add-layer">分层</span><span class="add-pic">添加照片</span><span class="add-album">添加相册</span></div><div class="img-contain"><div class="images"></div></div></div></li>';a.children("ul").length||(a.closest(".album.tree").length&&$(".album.tree").find("ul").length?(a.append($('<ul class="sortable-ul" title="拖动调整相册层顺序"></ul>')),a.find(".sortable-ul").sortable({cursor:"pointer",connectWith:".sortable-ul",dropOnEmpty:!0})):a.append($("<ul></ul>")));var n=$(t);return a.children("ul").append(n),n.find(".images").sortable({cursor:"pointer",connectWith:".images",dropOnEmpty:!0}),n.find(".images").disableSelection(),n}function isNeedEmptyDiv(a){}function addDilaogEvent(a){a.off("click").off("keydown").on("click",".tags .filter",function(){a.find(".tags .filter").removeClass("active"),$(this).addClass("active");var e=$(this).data("filter"),t=a.find(".panoQuery").val(),n={q:t,project:e,size:50};layerEditSearch=n,setPanos(a,n,!0)}),a.on("click",".js-pano-search",function(){var e=a.find(".panoQuery").val(),t={q:e,size:50};layerEditSearch=t,setPanos(a,t,!0)}),a.on("keydown",".panoQuery",function(e){if(13==e.keyCode){var t=a.find(".panoQuery").val(),n={q:t,size:50};layerEditSearch=n,setPanos(a,n,!0)}}),a.on("click",".addedimages .image",function(){a.find(".item1New .image").removeClass("selected"),$(this).addClass("selected")})}function addDialogScroll(a){a.find(".addedimages").off("scroll").on("scroll",function(){lazyLoad(a)})}function lazyLoad(a){if($win=a.find(".addedimages"),a.find(".addedimages .wrap").height()-$win.scrollTop()<$win.height()+100){var e=a.find(".panoQuery").val();albumEdit.fromPage++;var t={q:e,size:50,fromPage:albumEdit.fromPage},n=a.find(".tags .filter.active");n.length&&(t.project=n.data("filter")),setPanos(a,t,!1)}}function setPanos(a,e,t){var n=e.q,l=e.project;if(!e.q)return!1;e.fromPage=e.fromPage||1;var i=e.fromPage;$.ajax({type:"get",url:url_root+"/pano/search",data:e,success:function(e){if(0==e.result)refreshImagesDialog(a,e.data.searchResult,t),l&&a.find('[data-filter="'+l+'"]').addClass("active"),a.find(".panoQuery").val(n),albumEdit.totalPage=e.data.totalPage,albumEdit.totalPage<=i&&a.find(".addedimages").off("scroll"),removeDialogModalBottomCss();else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})}function refreshImagesDialog(a,e,t){var n=$(".js-search-wrapper .tab-content");t&&(a.find(".addedimages .wrap").empty(),a.find(".tags").empty(),albumEdit.tags=[],albumEdit.fromPage=1,addDialogScroll(a),n.hide()),$.each(e,function(e,t){var l="",i='<div class="image '+l+'" ',r=null,o=!0;if($.each(albumEdit.tags,function(a,e){e==t.project&&(o=!1)}),o){albumEdit.tags.push(t.project);var s='<span class="filter" data-filter="'+t.project+'">'+t.project+"</span>";a.find(".tags").append($(s)),1!=a.find(".filter").length?n.hide():n.show()}var u=addedPanoIds;$.each(u,function(a,e){e==t.panoId&&(l=" used ")}),$.each(t,function(a,e){var t="A".charCodeAt(),n="Z".charCodeAt(),l="a".charCodeAt()-t,o=a.split("");$.each(o,function(a,e){var i=e.charCodeAt();i<=n&&i>=t&&(o[a]="-"+String.fromCharCode(1*i+l))}),a=o.join(""),"markers"==a&&(r=e),i+="data-"+a+'="'+e+'" '}),i+='" style="background-image:url('+t.thumbnailUrl+')"><div class="image-title">'+t.panoName+'<span class="used">&#9733</span></div><span class="add">&#10003</span><span class="del">&#10005</span></div>';var d=$(i);t.markers&&t.markers[0]&&t.markers[0].width?(d.data("markers",JSON.stringify(r)),d.attr("data-markers",JSON.stringify(r))):(d.data("markers",JSON.stringify(null)),d.attr("data-markers",JSON.stringify(null))),a.find(".addedimages .wrap").append(d)})}function addAlbumDilaogEvent(a){a.on("click",".js-pano-search",function(){var e=a.find(".panoQuery").val(),t={q:e,size:50};layerEditSearchAlbum=t,searchAlbums(a,t,!0)}),a.on("keydown",".panoQuery",function(e){if(13==e.keyCode){var t=a.find(".panoQuery").val(),n={q:t,size:50};layerEditSearchAlbum=n,searchAlbums(a,n,!0)}}),a.on("click",".addedimages .image",function(){a.find(".item1New .image").removeClass("selected"),$(this).addClass("selected")})}function addAlbumDialogScroll(a){a.find(".addedimages").off("scroll").on("scroll",function(){lazyLoadAlbum(a)})}function lazyLoadAlbum(a){if($win=a.find(".addedimages"),a.find(".addedimages .wrap").height()-$win.scrollTop()<$win.height()+100){var e=a.find(".panoQuery").val();albumEditAlbum.fromPage++;var t={q:e,size:50,
fromPage:albumEditAlbum.fromPage},n=a.find(".tags .filter.active");n.length&&(t.project=n.data("filter")),searchAlbums(a,t,!1)}}function searchAlbums(a,e,t){var n=e.q,l=e.project;if(!e.q)return!1;e.fromPage=e.fromPage||1;var i=e.fromPage;$.ajax({type:"get",url:url_root+"/album/search",data:e,success:function(e){if(0==e.result)refreshAlbumDialog(a,e.data.searchResult,t),l&&a.find('[data-filter="'+l+'"]').addClass("active"),a.find(".panoQuery").val(n),albumEditAlbum.totalPage=e.data.totalPage,albumEditAlbum.totalPage<=i&&a.find(".addedimages").off("scroll"),removeDialogModalBottomCss();else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})}function refreshAlbumDialog(a,e,t){var n=$(".js-search-wrapper .tab-content");t&&(a.find(".addedimages .wrap").empty(),a.find(".tags").empty(),albumEditAlbum.tags=[],albumEditAlbum.fromPage=1,addAlbumDialogScroll(a),n.hide()),$.each(e,function(e,t){if(t.albumId!==albumUpdateObject.albumId){var n="",l=addedAlbumIds;$.each(l,function(a,e){e==t.albumId&&(n=" used ")});var i='<div class="image image-album '+n+'" ';null!==t.thumbnailUrl?i+='style="background-image:url('+t.thumbnailUrl+')">':i+=">",i+='<div class="image-title">'+t.albumName+'<span class="used">&#9733</span><span class="album-type"></span></div><span class="add">&#10003</span><span class="del">&#10005</span></div>';var r=$(i);r.data("albumIncludedId",t.albumId),r.attr("data-album-included-id",t.albumId),r.data("albumName",t.albumName),r.attr("data-album-name",t.albumName),r.data("thumbnailUrl",t.thumbnailUrl),r.attr("data-thumbnail-url",t.thumbnailUrl),r.data("type","album"),r.attr("data-type","album"),a.find(".addedimages .wrap").append(r)}})}function changeAlbumInfos(a){var e=$(a).closest(".layer-bar").find(".name"),t=e.data("albumname"),n=e.data("albumdescrip"),l=e.data("albumdetail")||"",i='<div style="margin:10px auto;width:auto;color:#434750;font-size:12px;"><div class="name"><span>相册名称:</span><input type="text" id="albumNameUpdate" value="'+t+'" style="width:728px;height:24px;border:1px solid #e4e4e4;"></div><div style="margin-top:10px;"><span style="vertical-align:top;">相册介绍:</span><textarea id="albumDescripUpdate" cols="30" row="5" style="border:1px solid #e4e4e4;width:728px;height:138px;">'+n+'</textarea></div><div style="margin-top:10px;"><span style="vertical-align:top;">相册详情:</span><textarea id="albumDetailUpdate" cols="30" row="5" style="border:1px solid #e4e4e4;width:728px;height:138px;">'+l+"</textarea></div></div>",r=event.pageY-200>0?event.pageY-200:0;new Dialog({top:r+"px",title:"修改相册信息",width:"818px",content:i,ok:function(a){t=a.find("#albumNameUpdate").val(),n=a.find("#albumDescripUpdate").val(),l=a.find("#albumDetailUpdate").val(),e.data("albumname",t),e.data("albumdescrip",n),e.data("albumdetail",l),e.html(t)}})}function addLayersEditEvent(){$(".album").off("click",".pen").on("click",".pen",function(){if($(this).closest("ul").parent().hasClass("album"))return void changeAlbumInfos(this);var a=$(this).closest(".layer-bar").find(".name"),e=a.data("albumname"),t=a.data("albumdescrip"),n='<div style="margin:10px auto;width:auto;color:#434750;font-size:12px;"><div class="name"><span>相册层名称:</span><input type="text" id="albumNameUpdate" value="'+e+'" style="width:224px;height:24px;border:1px solid #e4e4e4;"></div><div style="margin-top:10px;"><span style="vertical-align:top;">相册层简介:</span><textarea id="albumDescripUpdate" cols="30" row="5" style="border:1px solid #e4e4e4;width:224px;height:60px;">'+t+"</textarea></div></div>",l=event.pageY-200>0?event.pageY-200:0;new Dialog({top:l+"px",title:"修改相册层信息",content:n,ok:function(n){e=n.find("#albumNameUpdate").val(),t=n.find("#albumDescripUpdate").val(),a.data("albumname",e),a.data("albumdescrip",t),a.html(e)}})}),$(".album").off("click",".add-layer").on("click",".add-layer",function(){var a=this,e=$(this).closest("li"),t=event.pageY-200>0?event.pageY-200:0;new Dialog({top:t+"px",title:"相册分层",content:'<div style="margin:10px auto;width:auto;color:#434750;font-size:12px;"><div class="name"><span>相册层名称:</span><input type="text" id="albumNamenew" style="width:224px;height:24px;border:1px solid #e4e4e4;"></div><div style="margin-top:10px;"><span style="vertical-align:top;">相册层简介:</span><textarea id="albumDescripNew" cols="30" row="5" style="border:1px solid #e4e4e4;width:224px;height:60px;"></textarea></div></div>',ok:function(t){var n={albumName:t.find("#albumNamenew").val(),albumInfo:t.find("#albumDescripNew").val()};addLayer(e,n),isNeedEmptyDiv($(a).closest(".layer").find(".images"))}})});var a='<div><div class="search input-group"><input type="text" class="form-control panoQuery" style="float: right; width: 200px;" placeholder="输入项目名称全文检索"><span class="input-group-addon js-pano-search" style="height: 34px"></span></div><div class="tags"></div><div class="tab-content"><div id="item1" class="tab-pane img-contain"><div class="images add-image addedimages" id="addedimages"><div class="wrap"></div></div></div></div></div>';$(".album").off("click",".add-pic").on("click",".add-pic",function(){var e=this,t=$(this).closest(".layer").find(".img-contain .images"),n=event.pageY-600>0?event.pageY-600:0;new Dialog({top:n+"px",title:"添加照片",content:a,width:"818px",ok:function(a){var n=a.find(".image.ui-selected");t.append(n),$.each(n,function(a,e){addedPanoIds.push($(e).data("panoId"))}),isNeedEmptyDiv($(e).closest(".layer").find(".images"))},autoSearch:function(a){setPanos(a,layerEditSearch,!0)},initEvt:function(a){addDilaogEvent(a),$(".addedimages .wrap").selectable()}});removeDialogModalBottomCss()}),$(".album").off("click",".add-album").on("click",".add-album",function(){var e=this,t=$(this).closest(".layer").find(".img-contain .images"),n=event.pageY-600>0?event.pageY-600:0;new Dialog({top:n+"px",title:"添加相册",content:a,width:"818px",ok:function(a){var n=a.find(".image.ui-selected");t.append(n),$.each(n,function(a,e){addedPanoIds.push($(e).data("albumId"))}),isNeedEmptyDiv($(e).closest(".layer").find(".images"))},autoSearch:function(a){searchAlbums(a,layerEditSearchAlbum,!0)},initEvt:function(a){addAlbumDilaogEvent(a),$(".addedimages .wrap").selectable()}});removeDialogModalBottomCss()}),$(".album").off("click",".del-layer").on("click",".del-layer",function(){var a=this,e=event.pageY-200>0?event.pageY-200:0;new Dialog({top:e+"px",title:"提示",content:"确定删除该层吗？",ok:function(e){var t=$(a).closest("li"),n=t.children("ul").html(),l=t.closest("ul");n&&n.length&&t.after(n),t.remove(),l.find("li").length||l.remove(),isNeedEmptyDiv($(a).closest(".layer").find(".images"))}})}),$(".album").off("click",".image .del").on("click",".image .del",function(){var a=this,e=$(a).closest(".images");$(a).closest("div.image").remove(),isNeedEmptyDiv(e)}),$(".btn-save-layer").off().on("click",function(){var a=event.pageY-400>0?event.pageY-400:0;updateAlbum(albumUpdateObject.albumContent,".tree>ul>li"),albumUpdateObject.albumContent.activeStep=1;var e=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:e,success:function(e){if(0==e.result){new Dialog({top:a+"px",title:"提示",content:"保存成功",autoClose:!0});albumUpdateObject=e.data,albumUpdateObject.albumContent=$.parseJSON(albumUpdateObject.albumContent)}else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})})}function addMarkerOK(a){var e=a.find("#markerType").val(),t=a.find(".markerUrl").val(),n=a.find(".markerUrlName").val(),l=a.find(".labelStr").val(),i=a.find(".image.selected"),r=i.data("panoName"),o=i.data("panoId"),s=albumUpdateObject.albumId,u={heading:90,pitch:-10};switch(e){case"url":u.mtype="url",u.url=t,u.urlName=n;break;case"label":u.mtype="label",u.label=l;break;case"html":u.mtype="html",u.htmlName=markerHtmlTitle,u.htmlStr="<div>"+markerHtmlTitle+"</div>";break;case"pano":u.mtype="pano",u.panoId=o,u.panoName=r,u.albumId=s}var d=addMarkerTr(u);addMarker(u),setMarkerActive(d)}function getMySignature(a,e){$.ajax({type:"get",url:"http://shunde.vizen.cn/shunde/inner/upload/sign?remotePath="+a,success:function(a){var t=JSON.parse(a);"0"==t.code?e(t):alert(t.msg)}})}function uploadToQcloud(a,e,t){var n="http://sh.file.myqcloud.com/files/v2/1251448083/panopublictest/shunde/file/"+a.path+"?sign="+encodeURIComponent(a.signature),l=null;if(window.FormData){var l=new FormData;l.append("filecontent",e),l.append("op","upload"),l.append("insertOnly","0")}$.ajax({type:"post",url:n,processData:!1,contentType:!1,data:l,xhrFields:{withCredentials:!1},success:function(a){0==a.code?t(a):alert(a.msg)}})}function addHtmlMarkerOK(){var a=(albumUpdateObject.albumId,{heading:90,pitch:-10});a.mtype="html",$htmlData=$("#htmlData"),a.htmlName=$htmlData.data("htmlName"),a.htmlStr=$htmlData.data("htmlStr"),a.video=$htmlData.data("video"),a.radio=$htmlData.data("radio");var e=addMarkerTr(a);addMarker(a),setMarkerActive(e)}function editHtmlMarker(a,e){var t=decodeURI(a.htmlStr||"");void 0!=a.video&&""!=a.video||(a.video=""),void 0!=a.radio&&""!=a.radio||(a.radio="");var n='<div class="htmlmarkerDialog"><div>标题<input type="text" id="htmlName" value="'+(a.htmlName||"")+'"></div><div class="summernoteWrap">正文<div id="summernote"></div></div><div><label for="video" class="btn-success-vb up-video" style="padding:3px 10px;float:left;">上传视频</label><input class="file-btn" style="position: absolute; width: 10px" type="file" id="video"><input value="'+a.video+'" type="text" name="" id="video-text-area" style="width: 200px; margin-left: 100px" ></div><div style="margin-top: 10px"><label for="radio" class="btn-success-vb up-music" style="padding:3px 10px;float:left;">上传音乐</label><input class="file-btn" style="position: absolute; width: 10px" type="file" id="radio"><input value="'+a.radio+'" type="text" name="" id="radio-text-area" style="width: 200px; margin-left: 100px" ></div></div>';new Dialog({title:"图文内容编辑",content:n,width:"800px",buttons:[{text:"保存",type:"save",fn:function(a){var t=$("#summernote").summernote("code")&&$("#summernote").summernote("code").length?encodeURI($("#summernote").summernote("code")):"";$("#htmlData").data("htmlName",$("#htmlName").val()),$("#htmlData").data("htmlStr",t),$("#htmlData").data("video",$("#video-text-area").val()),$("#htmlData").data("radio",$("#radio-text-area").val()),$('.js-detail-marker-edit [marker-attr="htmlName"]').html($("#htmlName").val()),e?addHtmlMarkerOK():activeMarker._domElement.innerHTML='<div class="marker-name">'+$("#htmlName").val()+"</div>",a.remove()}},{text:"预览",type:"editable-false",fn:function(a){$("#summernote").summernote("destroy"),$(".btn-dialog-editable-true").show(),$(".btn-dialog-editable-false").hide()}},{text:"编辑",type:"editable-true",fn:function(a){setSummernote(),$(".btn-dialog-editable-true").hide(),$(".btn-dialog-editable-false").show()}}],initEvt:function(a){a.find("#summernote").html(t),setSummernote()}});addUploadEvent()}function addUploadEvent(){function a(a){$("#video-text-area").val(a)}function e(a){$("#radio-text-area").val(a)}$("#video").off("change").on("change",function(e){var t=e.target.files[0];getMySignature("/shunde/file/"+t.lastModified+".mp4",function(e){a(t.lastModified+".mp4");var n=new Object;n.path=t.lastModified+".mp4",n.signature=e.data.sign,$(".up-video").html("上传中..."),uploadToQcloud(n,t,function(a){$(".up-video").html("上传视频"),$("#video-text-area").val(a.data.source_url)})})}),$("#radio").off("change").on("change",function(){var a=event.target.files[0];getMySignature("/shunde/file/"+a.lastModified+".mp3",function(t){e(a.lastModified+".mp3");var n=new Object;n.path=a.lastModified+".mp3",n.signature=t.data.sign,$(".up-music").html("上传中..."),uploadToQcloud(n,a,function(a){$(".up-music").html("上传音乐"),$("#radio-text-area").val(a.data.source_url)})})})}function addEditMarkerEvent(){$(".step-wrap-4.sub-step-0 .spinner").spinner(),$("#item1Marker #markerType").off("change").on("change",function(){$('#item1Marker input[type="text"]').val(""),showAddMarkerWrap(),"pano"==$("#item1Marker #markerType").val()&&($("#addMarkerDiv").find("ul").length||setAlbum($("#addMarkerDiv"),albumUpdateObject.albumId))}),$(".fold-action.fold-show-action").off("click").on("click",function(){foldAddMarkerWrap()}),$(".show-action.fold-show-action").off("click").on("click",function(){showAddMarkerWrap()}),$("#addMarkerDiv").off("click",".image").on("click",".image",function(){$("#addMarkerDiv .image").removeClass("selected"),$(this).addClass("selected")}),$("#item1Marker .js-marker-add").off("click").on("click",function(){saveMarkerInfo(),addMarkerOK($("#item1Marker"))}),$("#item1Marker .js-marker-html-add").off("click").on("click",function(){editHtmlMarker({},!0)}),$(".js-img-marker-edit-contain").off("click",".image").on("click",".image",function(){var a=this;saveMarkerInfo(),saveMarkersToImage(),removeMarkers(),markersArray=[],$(".js-img-marker-edit-contain .image").removeClass("active"),$(a).addClass("active");var e=$(a).data();panoContainerMarker.setHeading(e.panoHeading),panoContainerMarker.setPitch(e.panoPitch),panoContainerMarker.setPanoId(e.panoId),setMarkerTable($(a)),setMarkers($(a)),setMarkerActive($($(".js-markers-table tr.marker")[0]))}),$(".js-detail-marker-edit .marker-attr.regular-input").off().on("keyup",function(){var a=$(this);"panoName"==a.attr("marker-attr")&&activeMarker.subViews[1].setText(a.val()),"urlName"==a.attr("marker-attr")&&activeMarker.subViews[1].setText(a.val()),"htmlName"==a.attr("marker-attr")&&activeMarker.subViews[1].setText(a.val()),"label"==a.attr("marker-attr")&&activeMarker.subViews[0].setText(a.val())}),$(".js-detail-marker-edit .marker-attr.spinner").off("spinchange").on("spinchange",function(a,e){var t=$(this);"heading"==t.attr("marker-attr")&&activeMarker.setPanoHeading(t.val()),"pitch"==t.attr("marker-attr")&&activeMarker.setPanoPitch(t.val())}),$(".js-markers-table").off().on("click","tr.marker",function(){saveMarkerInfo(),setMarkerActive($(this))}).on("click",".del-marker",function(){var a=$(this),e=a.closest("tr");return deleteMarker($(".js-markers-table tr.marker").index(e)),e.remove(),$(".js-markers-table tr.active").length||setMarkerActive($($(".js-markers-table tr.marker")[0])),!1}),$(".js-marker-del").off().on("click",function(){if(!activeMarker)return!1;var a=$(markersArray).index(activeMarker),e=$($(".js-markers-table tr.marker")[a]);return deleteMarker(a),e.remove(),$(".js-markers-table tr.active").length||(setMarkerAttrVisible(),setMarkerActive($($(".js-markers-table tr.marker")[0]))),!1}),$(".btn-save-marker").off().on("click",function(){var a=event.pageY-400>0?event.pageY-400:0;saveMarkerInfo(),saveMarkersToImage();var e=$(".js-img-marker-edit-contain .image.active"),t=$(".js-img-marker-edit-contain .image").index(e);updateAlbum(albumUpdateObject.albumContent,".js-img-marker-edit-contain>ul>li",!0),albumUpdateObject.albumContent.activeStep=1;var n=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?updateMeta=true&lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:n,success:function(e){if(0==e.result){new Dialog({top:a+"px",title:"提示",content:"保存成功",autoClose:!0});setAlbum($(".step-wrap-4.sub-step-0 .img-marker-edit-contain"),e.data.albumId,function(){$(".img-marker-edit-contain [data-is-with-markers]").hide(),$('.img-marker-edit-contain [data-is-with-markers="1"]').show(),$($(".js-img-marker-edit-contain .image")[t]).addClass("active")},!0)}else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})}),$(".goto2").off().on("click",function(){setAlbumPicture(albumUpdateObject.albumId,function(){addPictureSelEvt()}),navToStep(2,0)})}function deleteMarker(a){panoContainerMarker.panoView.removeView(markersArray[a]),markersArray.splice(a,1)}function saveMarkerInfo(){var a=$(".js-markers-table tr.active");if(a.length){var e={mtype:$('.js-detail-marker-edit [marker-attr="heading"]').attr("mtype"),url:$('.js-detail-marker-edit [marker-attr="url"]').val(),urlName:$('.js-detail-marker-edit [marker-attr="urlName"]').val(),label:$('.js-detail-marker-edit [marker-attr="label"]').val(),htmlName:$("#htmlData").data("htmlName"),htmlStr:$("#htmlData").data("htmlStr"),video:$("#htmlData").data("video"),radio:$("#htmlData").data("radio"),panoName:$('.js-detail-marker-edit [marker-attr="panoName"]').val(),panoNameEng:$('.js-detail-marker-edit [marker-attr="panoNameEng"]').val(),panoId:$('.js-detail-marker-edit [marker-attr="panoId"]').html(),albumId:$('.js-detail-marker-edit [marker-attr="albumId"]').html(),startTime:$('.js-detail-marker-edit [marker-attr="startTime"]').val(),endTime:$('.js-detail-marker-edit [marker-attr="endTime"]').val(),heading:$('.js-detail-marker-edit [marker-attr="heading"]').val(),pitch:$('.js-detail-marker-edit [marker-attr="pitch"]').val()},t=getTrStr(e,!0);a.replaceWith(t)}}function getTrStr(a,e){return $('<tr class="marker '+(e?"active":"")+'" mtype="'+a.mtype+'"><td style="word-break:break-all;">'+(a.url||"")+"</td><td>"+(a.urlName||"")+"</td><td>"+(a.label||"")+'</td><td class="js-htmlName" htmlStr="'+a.htmlStr+'" video="'+(a.video||"")+'" radio="'+(a.radio||"")+'">'+(a.htmlName||"")+"</td><td>"+(a.panoName||"")+"</td><td>"+(a.panoNameEng||"")+'</td><td style="word-break:break-all;">'+(a.panoId||"")+'</td><td style="word-break:break-all;">'+(a.albumId||"")+"</td><td>"+(a.startTime||"")+"</td><td>"+(a.endTime||"")+"</td><td>"+a.heading+"</td><td>"+a.pitch+'</td><td  class="v-middle"><span class="del-marker"></span></td></tr>')}function addMarkerTr(a){var e=getTrStr(a);return $(".js-markers-table").append(e),e}function addMarker(a){var e=new com.appengine.UPView;e.setLayout("horizontal"),e.setContentGravity("centerVertical"),e.setWidth("wrap"),e.setHeight("wrap"),e.setBackground("#7f000000"),e.setPanoHeading(a.heading),e.setPanoPitch(a.pitch),e.setPanoAnchorX(.5),e.setPanoAnchorY(.5),e.setBorderCorner("40dp"),e.setBorderWidth("1px");var t=new com.appengine.UPImageView;"pano"==a.mtype?(t.setSrc("../images/pano.png"),t.setMarginLeft("13dp"),t.setWidth("20dp"),t.setHeight("wrap"),e.addView(t)):"url"==a.mtype?(t.setMarginLeft("13dp"),t.setSrc("../images/url.png"),t.setWidth("20dp"),t.setHeight("wrap"),e.addView(t)):"label"!=a.mtype&&"html"!=a.mtype||t.setSrc(null);var n=new com.appengine.UPTextView;n.setWidth("wrap"),n.setHeight("18dp"),"pano"==a.mtype?(n.setPaddingLeft("5dp"),n.setPaddingRight("10dp"),n.setText(a.panoName)):"url"==a.mtype?(n.setPaddingLeft("5dp"),n.setPaddingRight("10dp"),n.setText(a.urlName)):"label"==a.mtype?(n.setContentGravity("center"),n.setPaddingLeft("8dp"),n.setPaddingRight("8dp"),n.setText(a.label)):"html"==a.mtype&&(n.setPaddingLeft("5dp"),n.setPaddingRight("10dp"),n.setText(a.htmlName)),n.setFontColor("#FFFFFF"),n.setFontSize("13dp"),n.setMarginTop("5dp"),n.setMarginBottom("5dp"),n.setContentGravity("centerVertical"),e._domElement.style.cursor="pointer",e.addView(n),markersArray.push(e),panoContainerMarker.panoView.addView(e),panoContainerMarker.setHeading("90"),panoContainerMarker.setPitch("-10"),e.setOnClick(function(){console.log("marker clicked!");var a=$(markersArray).index(this);if(a==$(markersArray).index(activeMarker))return!1;saveMarkerInfo(),setMarkerActive($($(".js-markers-table .marker")[a]))})}function setMarkerAttr(a){var e=$(".js-detail-marker-edit .marker-attr");$.each(e,function(e,t){"SPAN"==t.tagName?($(t).html(a[$(t).attr("marker-attr")]),"panoId"!=$(t).attr("marker-attr")&&"albumId"!=$(t).attr("marker-attr")||a[$(t).attr("marker-attr")]||$(t).html("")):$(t).val(a[$(t).attr("marker-attr")])}),setMarkerAttrVisible(a.mtype),setAddMarkerWrapDefault(),$(".datepicker").datepicker("destroy").datepicker()}function setAddMarkerWrapDefault(){$('#item1Marker input[type="text"]').val(""),$("#item1Marker #markerType").val("url"),foldAddMarkerWrap()}function showAddMarkerWrap(){var a=$("#item1Marker #markerType").val();$(".marker-type-wrap").hide(),$(".js-marker-type-wrap-"+a).show(),$(".js-marker-add").hide(),$(".js-marker-html-add").hide(),"html"==a?$(".js-marker-html-add").show():$(".js-marker-add").show(),$(".fold-show-action").hide(),$(".fold-action.fold-show-action").show()}function foldAddMarkerWrap(){$(".marker-type-wrap").hide(),$(".js-marker-add").hide(),$(".js-marker-html-add").hide(),$(".fold-show-action").hide(),$(".show-action.fold-show-action").show()}function setMarkerAttrVisible(a){switch($(".marker-type").hide(),a){case"url":$(".marker-type-url").show();break;case"label":$(".marker-type-label").show();break;case"html":$(".marker-type-html").show();break;case"pano":$(".marker-type-pano").show();break;default:$(".marker-type-pano").show()}}function setMarkerActive(a){$(".js-markers-table tr").removeClass("active"),a.addClass("active");var e=$(".js-markers-table tr").index(a)-1;activeMarker=markersArray[e],$.each(markersArray,function(a,e){e._domElement.style.border="none"}),activeMarker&&(activeMarker._domElement.style.border="2px solid #fff");var t=getMarkerObj(a);if("html"==t.mtype){var n=$("#htmlData");n.data("htmlName",t.htmlName),n.data("htmlStr",t.htmlStr),n.data("video",t.video),n.data("radio",t.radio)}else{var n=$("#htmlData");n.data("htmlName",""),n.data("htmlStr",""),n.data("video",""),n.data("radio","")}setMarkerAttr(t),$('.js-detail-marker-edit [marker-attr="heading"]').attr("mtype",t.mtype),updateHtmlMarker(t)}function updateHtmlMarker(a){"html"==a.mtype?($(".js-html-edit").show(),$(".js-html-edit").off().on("click",function(){editHtmlMarker(a,!1)})):$(".js-html-edit").hide()}function setSummernote(){$("#summernote").summernote("destroy"),$("#summernote").summernote({focus:!0,height:300,toolbar:[["style",["bold","underline","clear"]],["fontname",["fontname"]],["fontsize",["fontsize"]],["color",["color"]],["para",["ul","ol","paragraph"]],["height",["height"]],["picture",["picture"]],["tool",["fullscreen","codeview","help"]]]})}function getMarkerObj(a){var e=a.find("td"),t={url:$(e[0]).html(),urlName:$(e[1]).html(),label:$(e[2]).html(),htmlName:$(e[3]).html(),htmlStr:$(e[3]).attr("htmlStr"),video:$(e[3]).attr("video"),radio:$(e[3]).attr("radio"),panoName:$(e[4]).html(),panoNameEng:$(e[5]).html(),panoId:$(e[6]).html(),albumId:$(e[7]).html(),startTime:$(e[8]).html(),endTime:$(e[9]).html(),heading:$(e[10]).html(),pitch:$(e[11]).html()};return t.mtype=a.attr("mtype"),t}function saveMarkersToImage(){var a=$(".js-img-marker-edit-contain .image.active"),e=$(".js-img-marker-edit-contain .image").index(a),t=[],n=$(".js-markers-table tr.marker");$.each(n,function(a,e){var n=getMarkerObj($(e));t.push(n)}),markersArrayArray[e]=t}function setMarkerTable(a){var e=$(".js-img-marker-edit-contain .image").index(a),t=markersArrayArray[e],n=$(".js-markers-table");n.find("tr.marker").remove(),$.each(t,function(a,e){var t=getTrStr(e);n.append(t)})}function removeMarkers(){$.each(markersArray,function(a,e){panoContainerMarker.panoView.removeView(e)})}function setMarkers(a){var e=$(".js-img-marker-edit-contain .image").index(a),t=markersArrayArray[e];markersArray=[],$.each(t,function(a,e){addMarker(e)})}function storeMarkers(a,e){var t=$(".js-img-marker-edit-contain .image").index(a);e.markers=markersArrayArray[t]}function setMarkerArrayArray(a,e){e.markers&&(markersArrayArray[a]=e.markers)}function editPanoMarkerInfo(a){var e=a;setTimeout(function(){panoContainerMarker=new com.vbpano.Panorama(document.getElementById("panoViewMarker"),{heading:setDefaultVal(e.panoHeading,90),pitch:setDefaultVal(e.panoPitch,-10),roll:e.roll||0,autoplayEnable:e.autoplayEnable||!1,gravityEnable:e.gravityEnable||!1}),panoContainerMarker.setMarkerDragEnable(!0),panoContainerMarker.setMarkerDragCallback(function(a,e){if("0"==e){var t=$(markersArray).index(a);if($.each(markersArray,function(a,e){e._domElement.style.border="none"}),a._domElement.style.border="2px solid #fff",t==$(markersArray).index(activeMarker))return!1;saveMarkerInfo();setMarkerActive($($(".js-markers-table .marker")[t]))}else if("1"==e&&markersArray.length){var n=a.getPanoHeading(),l=a.getPanoPitch();$('.js-detail-marker-edit [marker-attr="heading"]').val(n),$('.js-detail-marker-edit [marker-attr="pitch"]').val(l)}}),config.onlineFlag||(panoContainerMarker.panoView.pano.urlProvider=function(a,e,t,n){return e<-1?"http://tilestest.pano.visualbusiness.cn/"+a+"/sv.xml":-1==e?"http://tilestest.pano.visualbusiness.cn/"+a+"/cube/thumb.jpg":"http://tilestest.pano.visualbusiness.cn/"+a+"/cube/"+e+"_"+t+"_"+n+".jpg"}),panoContainerMarker.panoView._domElement.style.overflow="hidden",panoContainerMarker.setPanoId(e.panoId)},200)}function savepanoInfo(){var a=$(".js-img-edit-contain .image.active");activePanoIndex=$(".js-img-edit-contain .image").index(a);var e=$(".js-detail-edit .pano-attr");$.each(e,function(e,t){if("SPAN"!=t.tagName){var n=$(t).val();"TEXTAREA"==t.tagName||"NaN"!=n&&""!=n||(n=0),a.data($(t).attr("pano-attr"),n)}})}function setPanoAttr(a){var e=$(".js-detail-edit .pano-attr");$.each(e,function(e,t){"SPAN"==t.tagName?$(t).html(a[$(t).attr("pano-attr")]):$(t).val(a[$(t).attr("pano-attr")])})}function addEditPanoEvent(){$(".js-img-edit-contain").off("click",".image").on("click",".image",function(){var a=this;savepanoInfo(),$(".js-img-edit-contain .image").removeClass("active"),$(a).addClass("active");var e=$(a).data();setPanoAttr(e),panoContainer.setHeading(e.panoHeading),panoContainer.setPitch(e.panoPitch),panoContainer.setPanoId(e.panoId)}),$('.js-detail-edit [pano-attr="panoHeading"]').off().blur(function(){panoContainer.setHeading($(this).val())}),$('.js-detail-edit [pano-attr="panoPitch"]').off().blur(function(){panoContainer.setPitch($(this).val())}),$(".btn-save-pano").off().on("click",function(){var a=event.pageY-400>0?event.pageY-400:0;savepanoInfo(),updateAlbum(albumUpdateObject.albumContent,".js-img-edit-contain>ul>li"),albumUpdateObject.albumContent.activeStep=1;var e=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:e,success:function(e){if(0==e.result){new Dialog({top:a+"px",title:"提示",content:"保存成功",autoClose:!0});setAlbum($(".step-wrap-3.sub-step-0 .js-img-edit-contain"),e.data.albumId,function(){var a=$($(".js-img-edit-contain .image")[activePanoIndex]);a.addClass("active"),editPanoInfo(a.data()),setPanoAttr(a.data()),addEditPanoEvent()})}else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})})}function setDefaultVal(a,e){return 0===a?a:a||e}function editPanoInfo(a){var e=a;setTimeout(function(){panoContainer=new com.vbpano.Panorama(document.getElementById("panoView"),{heading:setDefaultVal(e.panoHeading,90),pitch:setDefaultVal(e.panoPitch,-10),roll:e.roll||0,autoplayEnable:e.autoplayEnable||!1,gravityEnable:e.gravityEnable||!1}),config.onlineFlag||(panoContainer.panoView.pano.urlProvider=function(a,e,t,n){return e<-1?"http://tilestest.pano.visualbusiness.cn/"+a+"/sv.xml":-1==e?"http://tilestest.pano.visualbusiness.cn/"+a+"/cube/thumb.jpg":"http://tilestest.pano.visualbusiness.cn/"+a+"/cube/"+e+"_"+t+"_"+n+".jpg"}),panoContainer.panoView.onHeadingChangeCallback=function(a){a%=360,a<0&&(a+=360),$('.js-detail-edit [pano-attr="panoHeading"]').val(a)},panoContainer.panoView.onPitchChangeCallback=function(a){$('.js-detail-edit [pano-attr="panoPitch"]').val(a)},$(".set-zoom-default").off("click").on("click",function(){panoContainer.panoView.setZoom&&panoContainer.panoView.setZoom(0)}),panoContainer.setPanoId(e.panoId)},200)}function updateAlbumPicture(a,e){var t=$(e),n=t.children(".layer-picture").find(".name");a.albumName=n.data("albumname"),a.albumInfo=n.data("albumdescrip");var l=t.children(".layer-picture").find(".images .image");a.panoList=[],$.each(l,function(e,t){var n=$(t).data(),l=$(t).closest(".tr").find(".picture-attr");$.each(l,function(a,e){var t=$(e).val();n[$(e).attr("picture-attr")]=t}),n.panoName||(isPanoNameNull=!0),delete n.sortableItem,n.markers&&(n.markers[0]&&n.markers[0].mtype||(n.markers=$.parseJSON(n.markers))),a.panoList.push(n)}),a.albumList=[],t.children(".ul").length&&$.each(t.children(".ul").children(".li"),function(e,t){var n={};updateAlbumPicture(n,t),a.albumList.push(n)})}function setPictureAlbumlayer(a,e){var t=addPictureAlbumlayer(a,e);if(e.panoList&&e.panoList.length){addPictureImage(t.children(".layer-picture").find(".images"),e.panoList)}e.albumList&&e.albumList.length&&$.each(e.albumList,function(a,e){setPictureAlbumlayer(t,e)})}function addPictureImage(a,e){$.each(e,function(a,e){addedPanoIds.push(e.panoId)}),$.each(e,function(e,t){if("album"==t.type)addPictureAlbumImage(a,t);else{var n='<div class="image" ',l=null;$.each(t,function(a,e){var t="A".charCodeAt(),i="Z".charCodeAt(),r="a".charCodeAt()-t,o=a.split("");$.each(o,function(a,e){var n=e.charCodeAt();n<=i&&n>=t&&(o[a]="-"+String.fromCharCode(1*n+r))}),a=o.join(""),"markers"==a&&(l=e),n+="data-"+a+'="'+e+'" '}),n+='" style="background-image:url('+t.thumbnailUrl+')"></div>';var i=$(n);t.markers&&t.markers[0]&&t.markers[0].mtype?i.data("markers",JSON.stringify(l)):(i.data("markers",JSON.stringify(null)),i.attr("data-markers",JSON.stringify(null)));var r=getPitctureTr(t);r.find(".td:first-child").append(i),a.append(r)}})}function addPictureAlbumImage(a,e){addedAlbumIds.push(e.albumIncludedId);var t='<div class="image" ';t+='" style="background-image:url('+e.thumbnailUrl+');"><div class="image-title">'+e.albumName+'</div><span class="del">&#10005</span></div>';var n=$(t);n.data("albumIncludedId",e.albumIncludedId),n.attr("data-album-included-id",e.albumIncludedId),n.data("albumName",e.albumName),n.attr("data-album-name",e.albumName),n.data("thumbnailUrl",e.thumbnailUrl),n.attr("data-thumbnail-url",e.thumbnailUrl),n.data("type","album"),n.attr("data-type","album");var l=getAlbumPitctureTr(e);l.find(".td:first-child").append(n),a.append(l)}function getPitctureTr(a){var e=$('<div class="tr"><div class="td" style="width:20%"></div><div class="td"><input type="text" class="picture-attr panoName" picture-attr="panoName" value="'+a.panoName+'"></div><div class="td" style="width:20%"><textarea name="" class="picture-attr panoInfo" class="picture-attr" picture-attr="panoInfo" cols="20" rows="5">'+(a.panoInfo||"")+'</textarea></div><div class="td"><select name="" class="picture-attr isWithMarkers" picture-attr="isWithMarkers"><option value="0">否</option><option value="1">是</option></select></div></div>'),t=a.isWithMarkers;return 0!==t&&"0"!==t&&(t="1"),e.find(".isWithMarkers").val(t),e}function getAlbumPitctureTr(a){return $('<div class="tr" style="display:none"><div class="td" style="width:20%"></div><div class="td"><input type="text" class="picture-attr panoName" picture-attr="panoName" value="'+a.albumName+'"></div><div class="td" style="width:20%"><textarea name="" class="picture-attr panoInfo" class="picture-attr" picture-attr="panoInfo" cols="20" rows="5"></textarea></div><div class="td"><select name="" class="picture-attr isWithMarkers" picture-attr="isWithMarkers"><option value="0">否</option><option value="1">是</option></select></div></div>')}function addPictureAlbumlayer(a,e){var t='<div class="li"><div class="layer-picture"><div class="layer-bar" style="display:none"><span class="name" data-albumName="'+e.albumName+'" data-albumDescrip="'+e.albumInfo+'"></span></div><div class="img-contain"><div class="images"></div></div></div></div>';a.children(".ul").length||a.append($('<div class="ul"></div>'));var n=$(t);return a.children(".ul").append(n),n}function setAlbumPicture(a,e){$(".js-picture-table .ul").remove();var t=a;$.ajax({type:"get",url:url_root+"/album/get",data:{albumId:t,lang:localStorage.langStr},success:function(a){if(0==a.result)albumUpdateObject=a.data,
albumUpdateObject.albumContent=$.parseJSON(albumUpdateObject.albumContent),setPictureTable(albumUpdateObject.albumContent),setPictureAlbumlayer($(".js-picture-table"),albumUpdateObject.albumContent),e&&e();else if(2==a.result)loginDialog();else{new Dialog({title:"提示",content:a.msg})}}})}function setPictureTable(a){$(".selector-wrap .album-name-display").html(a.albumName),setSel($(".selector-wrap #album-layer-1"),a.albumList)}function setSel(a,e){a.empty(),a.append("<option value>-请选择-</option>"),e&&e.length&&$.each(e,function(e,t){a.append('<option value="'+e+'">'+t.albumName+"</option>")})}function setActivePanoList(a){var e=$(".js-picture-table tbody");e.find(".tr").remove(),a&&a.length&&$.each(a,function(a,t){var n=$('<tr class="tr"><td></td><td><input type="text"  value="'+t.panoName+'"></td><td><select name="" class="dayNight"><option value="">空</option><option value="1">日景</option><option value="2">夜景</option></select></td><td><select name="" class="season"><option value="">空</option><option value="1">春</option><option value="2">夏</option><option value="3">秋</option><option value="4">冬</option></select></td><td><select name="" class="viewAngle"><option value="">空</option><option value="1">平视</option><option value="2">俯视</option><option value="3">仰视</option><option value="4">其他</option></select></td><td><textarea name="" class="albumInfo" cols="30" rows="5"></textarea value="'+t.albumInfo+'"></td></tr>');n.find(".dayNight").val(t.dayNight),n.find(".season").val(t.season),n.find(".viewAngle").val(t.viewAngle),e.append(n)})}function addPictureSelEvt(){var a,e,t=$(".selector-wrap #album-layer-1"),n=$(".selector-wrap #album-layer-2"),l=albumUpdateObject.albumContent.albumList;t.off().change(function(){if(a=t.val()){var i=l[a].albumList;setSel(n,i),e="",showPictureTableTrs(0,a)}else showPictureTableTrs(-1)}),n.off().change(function(){e=n.val(),e?showPictureTableTrs(0,a,e):showPictureTableTrs(0,a)}),$(".btn-save-picture").off().click(function(){var a=event.pageY-400>0?event.pageY-400:0;if(isPanoNameNull=!1,updateAlbumPicture(albumUpdateObject.albumContent,".js-picture-table>.ul>.li"),isPanoNameNull){new Dialog({title:"提示",content:"场景名不能为空"})}else{albumUpdateObject.albumContent.activeStep=1;var e=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:e,success:function(e){if(0==e.result){new Dialog({top:a+"px",title:"提示",content:"保存成功",autoClose:!0});albumUpdateObject=e.data,albumUpdateObject.albumContent=$.parseJSON(albumUpdateObject.albumContent)}else if(2==e.result)loginDialog();else{new Dialog({title:"提示",content:e.msg})}}})}})}function showPictureTableTrs(a,e,t){if($(".js-picture-table .li").show(),-1!=a){var n=$(".js-picture-table>.ul>.li");if(e||0===e){var l=n.children(".ul").children(".li");if(t||0===t){var i=$(l[e]).children(".ul").children(".li");$.each(i,function(a,e){a!=t&&$(e).hide()})}$.each(l,function(a,t){a!=e&&$(t).hide()})}}}function getPages(a,e,t){if(!a||a<2)return[];if(e=e||1,e*=1,t=t||1,a<=5){a=a||1;var n=e>1?e-1:1,l=[{number:n,status:n==e?"disabled":"",label:"&laquo;"}];try{for(var i=1;i<=a;i++)l.push({number:i,status:i==e?"active":"",label:""+i})}catch(a){return ZCar.log("Failed to parse json string: ",a),null}return n=e<a?e+1:a,l.push({number:n,status:n==e?"disabled":"",label:"&raquo;"}),l}var r,o,i,l=[];for(r=Math.max(e-t,1),o=Math.min(r+2*t,a),i=r;i<=o;i++)l.push({number:i,status:i==e?"active":"",label:""+i});if(r>2){var n=e>1?e-1:1;l.unshift({number:-1,status:"disabled",label:"..."}),l.unshift({number:1,status:"",label:"1"}),l.unshift({number:n,status:n==e?"disabled":"",label:"&laquo;"})}else{var n=e>1?e-1:1;2==r&&l.unshift({number:1,status:"",label:"1"}),l.unshift({number:n,status:n==e?"disabled":"",label:"&laquo;"})}if(a-o>=2){var n=e<a?e+1:a;l.push({number:-1,status:"disabled",label:"..."}),l.push({number:a,status:"",label:""+a}),l.push({number:n,status:n==e?"disabled":"",label:"&raquo;"})}else{var n=e<a?e+1:a;a-o==1&&l.push({number:a,status:"",label:""+a}),l.push({number:n,status:n==e?"disabled":"",label:"&raquo;"})}return l}$("#openCover").click(function(){$(this).is(":checked")?$("#setCoverPage").show():$("#setCoverPage").hide()}),$(".btn-save-loading").off().on("click",function(){var a=event.pageY-400>0?event.pageY-400:0;updateAlbumCover(function(){new Dialog({top:a+"px",title:"提示",content:"保存成功",autoClose:!0});backfillCover(albumUpdateObject.albumContent.features)})}),$("#uploadLogo").on("change",function(a){uploadToLuna(a.target.files[0],setLogo)}),$("#uploadCover").on("change",function(a){uploadToLuna(a.target.files[0],setCover)}),$("#uploadMusic").on("change",function(a){var e=a.target.files[0];getMySignature("/shunde/file/"+e.lastModified+".mp3",function(a){setMusicName(e.lastModified+".mp3");var t=new Object;t.path=e.lastModified+".mp3",t.signature=a.data.sign,$(".musicOn-upload").html("上传中.."),uploadToQcloud(t,e,function(a){albumUpdateObject.albumContent.features.music_url=a.data.source_url,$(".musicOn-upload").html("上传音乐"),$("#uploadMusic").val(albumUpdateObject.albumContent.features.music_url)})})}),$("#uploadPcCover").on("change",function(a){uploadToLuna(a.target.files[0],setPcCover)}),$("#logoUrl").change(function(){$(this).siblings("img").attr("src",$(this).val())}),$("#coverUrl").change(function(){$(this).siblings("img").attr("src",$(this).val())}),$("#pcCoverUrl").change(function(){$(this).siblings("img").attr("src",$(this).val())}),$(".btn-save-config").off().on("click",function(){var a=event.pageY-400>0?event.pageY-400:0;albumUpdateObject.albumContent.status=0;var e=JSON.stringify({albumId:albumUpdateObject.albumId,optVersion:albumUpdateObject.optVersion,albumContent:JSON.stringify(albumUpdateObject.albumContent)});$.ajax({type:"post",url:url_root+"/album/update?updateMeta=true&lang="+localStorage.langStr,contentType:"application/json; charset=utf-8",data:e,success:function(e){new Dialog({top:a+"px",title:"提示",content:"保存至草稿箱成功",autoClose:!0})}})});var vrDiv2=document.getElementById("vrDiv2"),vrDiv=document.getElementById("vrDiv"),vrOn="0";vrDiv2.onclick=function(){"close1"==vrDiv.className?(vrDiv.className="open1",vrDiv2.className="open2",vrOn="1"):(vrDiv.className="close1",vrDiv2.className="close2",vrOn="0"),albumUpdateObject.albumContent.features.vrflag=vrOn};var weightDiv2=document.getElementById("weightDiv2"),weightDiv=document.getElementById("weightDiv"),weightOn="0";weightDiv2.onclick=function(){"close1"==weightDiv.className?(weightDiv.className="open1",weightDiv2.className="open2",weightOn="1"):(weightDiv.className="close1",weightDiv2.className="close2",weightOn="0"),albumUpdateObject.albumContent.features.gravityflag=weightOn};var musicDiv2=document.getElementById("musicDiv2"),musicDiv=document.getElementById("musicDiv"),musicOn="0";musicDiv2.onclick=function(){"close1"==musicDiv.className?(musicDiv.className="open1",musicDiv2.className="open2",musicOn="1",$(".musicOn").css("display","")):(musicDiv.className="close1",musicDiv2.className="close2",musicOn="0",$(".musicOn").css("display","none")),albumUpdateObject.albumContent.features.musicflag=musicOn};var rotationDiv2=document.getElementById("rotationDiv2"),rotationDiv=document.getElementById("rotationDiv"),rotationOn="0";rotationDiv2.onclick=function(){"close1"==rotationDiv.className?(rotationDiv.className="open1",rotationDiv2.className="open2",rotationOn="1"):(rotationDiv.className="close1",rotationDiv2.className="close2",rotationOn="0"),albumUpdateObject.albumContent.features.autoplayflag=rotationOn};var FancyForm=function(){return{inputs:".FancyForm input, .FancyForm textarea",setup:function(){var a=this;this.inputs=$(this.inputs),a.inputs.each(function(){var e=$(this);a.checkVal(e)}),a.inputs.on("keyup blur",null,function(){var e=$(this);a.checkVal(e)})},checkVal:function(a){a.val().length>0?a.parent("li").addClass("val"):a.parent("li").removeClass("val")}}}();$(document).ready(function(){FancyForm.setup()});var searchAjax=function(){},G_tocard_maxTips=30;$(function(){!function(){var a=$(".plus-tag");$("a em",a).on("click",null,function(){var a=$(this).parents("a"),e=a.attr("title"),t=a.attr("value");delTips(e,t)}),hasTips=function(e){var t=$("a",a),n=!1;return t.each(function(){if($(this).attr("title")==e)return n=!0,!1}),n},isMaxTips=function(){},setTips=function(e,t){if(hasTips(e))return!1;if(isMaxTips())return alert("最多添加"+G_tocard_maxTips+"个标签！"),!1;var n=t?'value="'+t+'"':"";return a.append($("<a "+n+' title="'+e+'" href="javascript:void(0);" ><span>'+e+"</span><em></em></a>")),searchAjax(e,t,!0),$("a em",a).on("click",null,function(){var a=$(this).parents("a"),e=a.attr("title"),t=a.attr("value");delTips(e,t)}),!0},delTips=function(e,t){return!!hasTips(e)&&($("a",a).each(function(){var a=$(this);if(a.attr("title")==e)return a.remove(),!1}),searchAjax(e,t,!1),!0)},getTips=function(){var e=[];return $("a",a).each(function(){e.push($(this).attr("title"))}),e},getTipsId=function(){var e=[];return $("a",a).each(function(){e.push($(this).attr("value"))}),e},getTipsIdAndTag=function(){var e=[];return $("a",a).each(function(){e.push($(this).attr("value")+"##"+$(this).attr("title"))}),e}}()}),$(function(){setSelectTips(),$(".plus-tag").append($(".plus-tag a"))});var searchAjax=function(a,e,t){setSelectTips()};!function(){function a(a){$.ajax({type:"get",url:url_root+"/album/createTag",data:{tag:a},success:function(e){0==e.result?n.append($('<a value="-1" title="'+a+'" href="javascript:void(0);"><span>'+a+"</span><em></em></a>")):new Dialog({title:"提示",content:e.msg})}})}var e=$(".plus-tag-add button"),t=$(".plus-tag-add input");t.keyup(function(a){13==a.keyCode&&e.click()});var n=$(".default-tag");!function(){$.ajax({type:"get",url:url_root+"/album/findAllTag",success:function(a){var e=a;if(0==e.result)for(var t=0;t<e.data.tags.length;t++)n.append($('<a value="-1" title="'+e.data.tags[t].tagName+'" href="javascript:void(0);"><span>'+e.data.tags[t].tagName+"</span><em></em></a>"));else new Dialog({title:"提示",content:e.msg})}})}(),e.click(function(){var e=t.val().toLowerCase();if(""!=e){if(hasTips(e))return!1;a(e),setTips(e,-1)}t.val(""),t.select()})}(),function(){var a=["展开推荐标签","收起推荐标签"];$(".plus-tag-add a").click(function(){var e=$(this),t=$("#mycard-plus");e.hasClass("plus")?(e.removeClass("plus").text(a[0]),t.hide()):(e.addClass("plus").text(a[1]),t.show())}),$(".default-tag").on("click","a",function(){var a=$(this),e=a.attr("title"),t=a.attr("value");setTips(e,t)}),setSelectTips=function(){var a=getTips();a.length&&$("#myTags").show(),$(".default-tag a").removeClass("selected"),$.each(a,function(a,e){$(".default-tag a").each(function(){var a=$(this);if(a.attr("title")==e)return a.addClass("selected"),!1})})}}();var albumUpdateObject={},addedPanoIds=[];$(function(){login(),addNavEvent(),addAlbumInitEvt(),addLayersEditEvent(),addAlbumsSearchEvent(),$(".datepicker").datepicker("destroy").datepicker();var a;if(null!=getQueryString("albumId")){a={token:getQueryString("token"),uniqueId:getQueryString("unique_id"),albumId:getQueryString("albumId")};var e=a.albumId;localStorage.langStr="",setAlbum($(".album.tree"),e,function(){(!albumUpdateObject.albumContent.completedSteps||albumUpdateObject.albumContent.completedSteps<1)&&(albumUpdateObject.albumContent.completedSteps=1),navToStep(1,0)})}else a={token:getQueryString("token"),uniqueId:getQueryString("unique_id")},navToStep(0,0);window.uniqueID=a.uniqueId}),$.ajaxSetup({xhrFields:{withCredentials:!0}}),Dialog.prototype.fnSave=function(a,e,t){e&&e(a),t||this.dialogDiv.remove()};var albumSearchObj={},albumEdit={};albumEdit.totalPage=-1;var albumEditAlbum={};albumEditAlbum.totalPage=-1;var layerEditSearch={},layerEditSearchAlbum={},layerEditActiveTag="",markersArray=[],activeMarker=null,markersArrayArray=[],panoContainerMarker,activePanoIndex=-1,panoContainer,isPanoNameNull=!1;