(function(){function k(){}"undefined"==typeof com&&(com={});"undefined"==typeof com.vizengine&&(com.vizengine={});"undefined"==typeof com.appengine&&(com.appengine=com.vizengine);var g=function(a,c){return null==a||null==c||a.length<c.length?!1:a.substring(a.length-c.length,a.length)==c},h=com.vizengine.mergeObject=function(){for(var a={},c=0;c<arguments.length;c++){var b=arguments[c];if(null!=b)if(b instanceof Array)for(c=0;c<b.length;c++){var d=b[c],e;for(e in d)a[e]=d[e]}else for(e in b)a[e]=b[e]}return a};
com.vizengine.Module=function(a){this.path=a;this.packageObject=this.script=null;this.loadState=0;this.loadRequests=[];this.templateScripts=[];this.templateDatas=[]};var f=com.vizengine.Module;f.prototype.isLoaded=function(){return 2<=this.loadState};f.prototype.isProcessed=function(){return 3==this.loadState};f.currentTemplateContextPath=null;f.prototype.isScript=function(){return g(this.path,".js")};f.prototype.isViewTemplate=function(){return f.isViewTemplate(this.path)};f.isViewTemplate=function(a){return g(a,
".jpl")||g(a,".xml")};f.prototype.isXMLTemplate=function(){return g(this.path,".xml")};f.prototype.isTextTemplate=function(){return g(this.path,".txt")};f.prototype.isJson=function(){return g(this.path,".json")};var p=function(a){for(;;){var c=a.indexOf("/./");if(0>c)break;a=a.replace(/\/\.\//g,"/")}for(;;){c=a.indexOf("/../");if(0>c)break;var b=a.substring(0,c),d=b.lastIndexOf("/"),e="";0<=d&&(e=b.substring(0,d+1));a=e+a.substring(c+4)}return a};f.prototype.processScriptContent=function(a){var c=
this,b=evaluateScript(this.script,p(this.path)),d=function(){null!=b&&(c.packageObject=b.packageObject);c.loadState=3;a()};null==b||b.ready||null==b.__bridge__flag__?d():b.callback=d};f.prototype.processTextContent=function(a){this.packageObject=this.script;this.loadState=3;a()};f.prototype.applyTemplateScripts=function(a){for(var c=0;c<this.templateScripts.length;c++)(0,this.templateScripts[c])(a)};f.prototype.processTextTemplate=function(a){var c=this;this.render=template.compile(this.script,{filename:this.path});
this.packageObject=function(){f.currentTemplateContextPath=c.path;for(var a=[],b=0;b<c.templateDatas.length;b++)a.push(c.templateDatas[b]);for(b=0;b<arguments.length;b++)a.push(arguments[b]);return c.render(h.apply(null,a))};for(var b=[],d=this.script,e=/(?:{{\s*include\s+)(?:'|")([\w$0-9_\/\.]+)(?:'|")/;null!=(res=d.match(e));)b.push(com.vizengine.view.View.resolvePath(this.path,res[1])),d=d.substring(res.index+res[0].length);var l=function(){for(var d=0;d<b.length;d++)if(!com.vizengine.moduleManager.isModuleProcessed(b[d]))return;
for(d=0;d<b.length;d++){var e=com.vizengine.moduleManager[b[d]];e.isJson()&&c.templateDatas.push(e.packageObject)}c.loadState=3;a()};if(0==b.length)l();else for(d=0;d<b.length;d++)com.vizengine.moduleManager.loadModule(b[d],function(){l()})};f.prototype.processViewTemplateContent=function(a){var c=this;this.render=template.compile(this.script,{filename:this.path});this.packageObject=function(){f.currentTemplateContextPath=c.path;for(var a=[],b=0;b<c.templateDatas.length;b++)a.push(c.templateDatas[b]);
for(b=0;b<arguments.length;b++)a.push(arguments[b]);a=h.apply(null,a);b=c.render(a);c.isXMLTemplate()&&(b=nativeParseXMLToJson(b));a=com.vizengine.view.View.parse(b,{contextPath:c.path},a,c.path);c.applyTemplateScripts(a);return a};for(var b=[],d=this.script,e=null,e=this.isXMLTemplate()?/\<\s*include\s+(?:(?!src[=\s])[\w]+\s*=\s*\"[0-9\w\s\.\$\/\:'\#\{\}:,]*\"\s+)*src\s*=\s*\"([0-9\w\s\.\$\/\:'\{\}:,]*)\"/:/(?:{{\s*include\s+)(?:'|")([\w$0-9_\/\.]+)(?:'|")/;null!=(res=d.match(e));)b.push(com.vizengine.view.View.resolvePath(this.path,
res[1])),d=d.substring(res.index+res[0].length);var l=function(){for(var d=0;d<b.length;d++){var e=com.vizengine.moduleManager[b[d]];e.isScript()&&e.packageObject instanceof Function&&c.templateScripts.push(e.packageObject);e.isJson()&&c.templateDatas.push(e.packageObject)}c.loadState=3;a()};if(0==b.length)l();else{var m=0,g=function(){m<b.length?com.vizengine.moduleManager.loadModule(b[m],function(){m++;g()}):l()};g()}};f.prototype.processJsonContent=function(a){this.packageObject=JSON.parse(this.script);
this.loadState=3;a()};f.prototype.processModelContent=function(a){var c=this,b=function(){for(var b=0;b<c.loadRequests.length;b++)c.loadRequests[b].callback();c.loadRequests.length=0;a()};com.vizengine.moduleManager.contextPath=this.path;this.isScript()?this.processScriptContent(b):this.isViewTemplate()?this.processViewTemplateContent(b):this.isJson()?this.processJsonContent(b):this.processTextContent(b)};f.prototype.load=function(a){if(3==this.loadState)a();else if(0<this.loadState)this.loadRequests.push({callback:a});
else{this.loadState=1;var c=this;loadResource(this.path,function(b){if(c.isJson()||c.isViewTemplate())b=com.vizengine.view.View.deleteComment(b);c.script=b;c.loadState=null==b?4:2;c.processModelContent(a)})}};k.prototype.loadModule=function(a,c){null==this[a]&&(this[a]=new f(a));this[a].load(c)};k.prototype.isModuleProcessed=function(a){return null==this[a]?!1:this[a].isProcessed()};k.prototype.resolveScriptPath=function(a){if(null==this.contextPath||null==a||"/"==a[0]||"http"==a.substring(0,4))return a;
var c=this.contextPath.lastIndexOf("/");return 0<=c?this.contextPath.substring(0,c+1)+a:"/"+a};com.vizengine.moduleManager=new k;window.module=function(){for(var a=[],c=null,b=0;b<arguments.length;b++){var d=arguments[b];if(d instanceof Function)c=d;else if(d instanceof Array)for(var e=0;e<d.length;e++)a.push(d[e]);else a.push(d)}for(b=0;b<a.length;b++)a[b]=com.vizengine.moduleManager.resolveScriptPath(a[b]);var f={__bridge__flag__:!0,ready:!1,callback:null},g=function(){for(var b=0;b<a.length;b++)if(!com.vizengine.moduleManager.isModuleProcessed(a[b]))return!1;
return!0},k=function(){for(var b=[],c=0;c<a.length;c++)b.push(com.vizengine.moduleManager[a[c]].packageObject);return b},h=0,n=function(){h<a.length?com.vizengine.moduleManager.loadModule(a[h],function(){h++;n()}):g()&&(f.ready=!0,f.packageObject=c.apply(null,k()),f.callback&&f.callback(f.packageObject))};n();if(null==a||0==a.length)f.ready=!0,f.packageObject=c();return f};null==window.require&&(window.require=window.module);var q=function(){template.onerror=function(a){for(var c in a);throw new TypeError(a.filename+
" : "+a.message);};template.get=function(a){var c=com.vizengine.view.View.resolvePath(f.currentTemplateContextPath,a),b=com.vizengine.moduleManager[c];return null!=b&&b.isViewTemplate()?function(){for(var a=[],e=0;e<b.templateDatas.length;e++)a.push(b.templateDatas[e]);for(e=0;e<arguments.length;e++)a.push(arguments[e]);a=h.apply(null,a);a=b.render.call(null,a);b.isXMLTemplate()&&(a=nativeParseXMLToJson(a));a=JSON.parse(a);a.__template__path__=c;a.contextPath=c;return a=JSON.stringify(a)}:function(){return""}};
template.defaults.parser=function(a,c){a=a.replace(/^\s/,"");var b=a.split(" "),d=b.shift(),e=b.join(" ");switch(d){case "if":a="if("+e+"){";break;case "else":b="if"===b.shift()?" if("+b.join(" ")+")":"";a="}else"+b+"{";break;case "/if":a="}";break;case "each":d=b[0]||"$data";e=(b[2]||"$value")+","+(b[3]||"$index");"as"!==(b[1]||"as")&&(d="[]");a="$each("+d+",function("+e+"){";break;case "/each":a="});";break;case "echo":a="print("+e+");";break;case "print":case "include":a=d+"("+b.join(",")+");";
break;default:if(/^\s*\|\s*[\w\$]/.test(e)){b=!0;0===a.indexOf("#")&&(a=a.substr(1),b=!1);for(var d=0,e=a.split("|"),f=e.length,g=e[d++];d<f;d++)g=filtered(g,e[d]);a=(b?"=":"=#")+g}else a=template.helpers[d]?"=#"+d+"("+b.join(",")+");":"=("+d+"==null?'"+e+"':"+d+")"}return a}};module(["/libs/vizengine_model3d.js"],function(){q();if(null!=window.onVizEngineLoaded)window.onVizEngineLoaded()})})();
