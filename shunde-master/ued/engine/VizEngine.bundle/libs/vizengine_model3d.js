module("/libs/vizengine_pano.js",function(){var k=com.vizengine.core.Object,m=com.vizengine.view.View,w=com.vizengine.gesture.PanGestureDetector,x=com.vizengine.gesture.SweepGestureDetector,y=com.vizengine.gesture.PinchGestureDetector,p=com.vizengine.animation.Animation,z=com.vizengine.animation.DecelerateInterpolator;p.extend({init:function(a){p.prototype.init.apply(this,arguments);this.modelGetureController=a;this.toZ=this.toY=this.toX=this.fromZ=this.fromY=this.fromX=0},animateFrame:function(a,
c){this.modelGetureController.setCameraPosition(this.fromX+(this.toX-this.fromX)*c,this.fromY+(this.toY-this.fromY)*c,this.fromZ+(this.toZ-this.fromZ)*c)}});p.extend({init:function(a){p.prototype.init.apply(this,arguments);this.modelGestureController=a;this.toDistance=this.fromDistance=0},animateFrame:function(a,c){this.modelGestureController._setDistance(this.fromDistance+(this.toDistance-this.fromDistance)*c)}});var A=p.extend({init:function(a){p.prototype.init.apply(this,arguments);this.modelGestureController=
a;this.toRoll=this.fromRoll=this.toPitch=this.toHeading=this.fromPitch=this.fromHeading=0},animateFrame:function(a,c){this.modelGestureController._setHeading(this.fromHeading+(this.toHeading-this.fromHeading)*c);this.modelGestureController._setPitch(this.fromPitch+(this.toPitch-this.fromPitch)*c)}}),t=k.extend({init:function(){k.prototype.init.apply(this,arguments);this.min=new THREE.Vector3;this.max=new THREE.Vector3},getWidth:function(){return this.max.x-this.min.x},getHeight:function(){return this.max.y-
this.min.y},getTall:function(){return this.max.z-this.min.z},getCenter:function(){var a=new THREE.Vector3;a.x=(this.min.x+this.max.x)/2;a.y=(this.min.y+this.max.y)/2;a.z=(this.min.z+this.max.z)/2;return a},getRadius:function(){return this.max.distanceTo(this.min)/2}}),r=function(){this.z=this.y=this.x=this.level=0};r.prototype.getPath=function(){return this.level+"/"+this.x+"_"+this.y+"_"+this.z};new function(){this.taskQueue=[];this.addTask=function(a){this.taskQueue.push(a);this.processTask()};
this.runningTaskCount=0;this.maxTaskCount=1;this.processTask=function(){if(0!=this.taskQueue.length&&!(this.runningTaskCount>=this.maxTaskCount)){var a=this;this.runningTaskCount++;this.taskQueue.shift()(function(){a.runningTaskCount--;a.processTask()})}}};var u=function(a,c,b){null==b&&(b="GET");var d=new XMLHttpRequest;d.open(b,a,!0);d.responseType="arraybuffer";d.onload=function(a){200==this.status&&c(this.response)};d.send()},v=function(a,c){for(var b=new Uint8Array(a),d=Uint8Array,e=c,f=new ArrayBuffer(e.length),
g=new Uint8Array(f),h=0,l=e.length;h<l;h++)g[h]=e.charCodeAt(h);c=new d(f);b=com.vizengine.Global.rc4(b,c);return String.fromCharCode.apply(null,new Uint8Array(b))};window.THREE&&THREE.Loader.Handlers.add(/\.dds$/i,new THREE.DDSLoader);var E=k.extend({init:function(){k.prototype.init.apply(this,arguments);this.index=new r;this.bound=new t;this.object=null;this.visible=!0;this.loadState=0;this.key=null},getIndexPath:function(a){null==a&&(a=this.index);return a.getPath()},setVisible:function(a){this.visible=
a;null!=this.object&&(this.object.visible=a)},getParentIndex:function(a){null==a&&(a=this.index);if(0>=a.level)return null;var c=new r;c.level=a.level-1;1==a.level?(c.x=a.x,c.y=a.y,c.z=a.z):(c.x=Math.floor(a.x/2),c.y=Math.floor(a.y/2),c.z=Math.floor(a.z/2));return c},walkBrotherIndex:function(a,c){null==c&&(c=this.index);if(0==c.level){for(var b=new r,d=b.level=0;2>d;d++)for(var e=0;2>e;e++)for(var f=0;2>f;f++)if(b.x=d,b.y=e,b.z=f,null!=this.modelView.boxiesIndex[b.getPath()]&&!a(b))return!1;return!0}b=
this.getParentIndex(c);return this.walkChildrenIndex(a,b)},walkChildrenIndex:function(a,c){null==c&&(c=this.index);var b=new r;b.level=c.level+1;if(0==c.level)return b.x=c.x,b.y=c.y,b.z=c.z,null==this.modelView.boxiesIndex[b.getPath()]?!0:a(b);for(var d=0;2>d;d++)for(var e=0;2>e;e++)for(var f=0;2>f;f++)if(b.x=d+2*c.x,b.y=e+2*c.y,b.z=f+2*c.z,null!=this.modelView.boxiesIndex[b.getPath()]&&!a(b))return!1;return!0},load:function(a){var c=this;c.loadInternal(function(b){a.call(c,b)})},reset:function(){this.loadState=
0;this.object=null},loadInternal:function(a){if(null!=this.object)this.loadState=2,a(this.object);else{var c=this;this.loadState=1;this.loadStartTime=(new Date).getTime();var b=new THREE.MTLLoader,d=b.load;b.crossOrigin="*";var e=this.modelSrc,f=c.modelView.formatProvider.getMtlUrl(c.index.level,c.index.x,c.index.y,c.index.z,c.fileId),g=c.modelView.formatProvider.getObjUrl(c.index.level,c.index.x,c.index.y,c.index.z,c.fileId);b.load=function(a,b,e,g){if(3>c.modelView.formatProvider.version)return d.apply(this,
arguments);a=f;var h=this;u(a,function(a){a=v(a,c.key);b(h.parse(a))})};var h=f.substring(0,f.lastIndexOf("/")+1),l=f.substring(f.lastIndexOf("/")+1);b.setPath(h);b.load(l,function(b){if(e==c.modelSrc){var d=new THREE.LoadingManager;d.onProgress=function(d,f,h){if(f==h&&e==c.modelSrc){d=null;if(1<c.modelView.formatProvider.version){d=new THREE.DRACOLoader;var l=d.decodeDracoFile;d.decodeDracoFile=function(a){if(3>c.modelView.formatProvider.version)return l.apply(this,arguments);for(var b=new Uint8Array(a),
d=Uint8Array,e=com.vizengine.core.Base64._utf8_encode(c.key),f=new ArrayBuffer(e.length),g=new Uint8Array(f),h=0,k=e.length;h<k;h++)g[h]=e.charCodeAt(h);d=new d(f);com.vizengine.Global.rc4(b,d);return l.call(this,a)}}else d=new THREE.OBJLoader;d.setMaterials(b);d.crossOrigin="*";d.load(g,function(b){e==c.modelSrc&&(c.modelView.debugEnable&&(b=c.compose(b)),c.loadState=2,c.object=b,c.object.visible=c.visible,c.loadFinishTime=(new Date).getTime(),a(c.object))},function(a){},function(){e==c.modelSrc&&
(c.loadState=3,c.object=null,c.loadFinishTime=(new Date).getTime(),a(c.object))})}};b.setManager(d);b.preload();b.side=THREE.DoubleSide;for(var f in b.materials)b.materials[f].side=THREE.DoubleSide}},function(){},function(){c.loadState=3;c.object=null;c.loadTextureTime=c.loadFinishTime=(new Date).getTime();a(c.object)})}},compose:function(a){if(null==a)return null;var c=new THREE.Object3D;c.add(a);a=new THREE.BoxBufferGeometry(this.bound.max.x-this.bound.min.x,this.bound.max.y-this.bound.min.y,this.bound.max.z-
this.bound.min.z);var b=new THREE.Texture,d=this.index.level+"("+this.index.x+"_"+this.index.y+"_"+this.index.z+")",e=document.createElement("canvas"),f=e.getContext("2d");e.width=256;e.height=256;f.strokeStyle="#FF0000";f.rect(0,0,256,256);f.lineWidth=2;f.stroke();f.fillStyle="#FF0000";f.font="26px regular";f.textBaseline="top";f.fillText(d,10,10);d=new Image;d.src=e.toDataURL("image/png");b.image=d;b.needsUpdate=!0;b=new THREE.MeshBasicMaterial({map:b,transparent:!0});a=new THREE.Mesh(a,b);a.position.x=
(this.bound.max.x+this.bound.min.x)/2;a.position.y=(this.bound.max.y+this.bound.min.y)/2;a.position.z=(this.bound.max.z+this.bound.min.z)/2;c.add(a);return c}}),B=k.extend({init:function(a,c){k.prototype.init.apply(this,arguments);this.sceneView=a;this.camera=c;this.distance=2;this.maxDistance=1.5*this.distance;this.minDistance=this.distance/2;this.rotation=new THREE.Euler;this.rotation.order="ZXY";var b=this;b.pinchVecX=0;b.pinchVecY=0;b.pinchVecZ=0;var d=new y;d.callback=function(a,c,d){c?(a=new THREE.Vector3(0,
0,-2),a.applyEuler(b.camera.rotation),b.initPinchVec=a):(a=Math.log(a)/Math.log(2),b.pinchVecX=b.initPinchVec.x*a,b.pinchVecY=b.initPinchVec.y*a,b.pinchVecZ=b.initPinchVec.z*a)};a.gestureDetectors.push(d);d=new w;d.callback=function(a,c,d){0==d.state?(b.sceneView.animation=null,b.initPitch=b._getPitch(),b.initHeading=b._getHeading(),b.initX=b.camera.position.x,b.initY=b.camera.position.y,b.initZ=b.camera.position.z):1>=d.touchPoints.length?(d=b._getAngleRate(),c=b.initPitch-c/d,b._setHeading(b.initHeading-
a/d),b._setPitch(c)):(a=new THREE.Vector3(-a/200,c/200,0),a.applyEuler(b.camera.rotation),b.initLeft=a,b.camera.position.x=b.initX+b.initLeft.x+b.pinchVecX,b.camera.position.y=b.initY+b.initLeft.y+b.pinchVecY,b.camera.position.z=b.initZ+b.initLeft.z+b.pinchVecZ);b.sceneView.requestDraw();return!0};a.gestureDetectors.push(d);d=new x;d.callback=function(a,c){b._fly(-a,-c)};d.cancelCallback=function(){b.sceneView.onCameraLocationChanged()};a.gestureDetectors.push(d)},_getAngleRate:function(){return 256},
_calculate:function(){var a=this;$.each(a.sceneView.subViews,function(c,b){var d=new THREE.Raycaster,e=new THREE.Vector2;e.x=b.translateX/window.innerWidth*2-1;e.y=2*-(b.translateY/window.innerHeight)+1;d.setFromCamera(e,a.camera);if(0<a.sceneView.scene.children.length){for(var e=[],f=0;f<a.sceneView.scene.children.length;f++)0==f?a.sceneView.scene.children[f].children[0]&&e.push(a.sceneView.scene.children[f].children[0].children[0]):e.push(a.sceneView.scene.children[f]);d=d.intersectObjects(e);0>=
d.length||(d[0].object==b.cube?b.visible||b.setVisible("true"):b.visible&&b.setVisible("false"))}})},_fly:function(a,c){var b=this._getAngleRate(),d=Math.abs(a)/5E-4,e=-(2.5E-4*d*d*(0<a?1:-1))/b,f=Math.abs(c)/5E-4,g=2.5E-4*f*f*(0<c?1:-1)/b,b=new z(2),d=d>f?d:f,f=this._getPitch(),g=f+g;g>Math.PI?g=Math.PI:0>g&&(g=0);var h=new A(this);h.fromHeading=this._getHeading();h.toHeading=h.fromHeading-e;h.fromPitch=f;h.toPitch=g;h.duration=d;h.timeInterplator=b;h.callback=function(){};this.sceneView.startAnimation(h)},
_apply:function(){this.camera.rotation.z=1*Math.PI+this.rotation.z;this.camera.rotation.x=2*Math.PI-this.rotation.x},_culCameraPosition:function(a){var c=new THREE.Vector3(0,0,-this.distance);c.applyEuler(this.rotation);c.x+=a.x;c.y+=a.y;c.z+=a.z;return c},setCameraPosition:function(a,c,b){this.camera.position.set(a,c,b);this.camera.updateProjectionMatrix();this.sceneView.requestDraw()},_updateDefaultDistance:function(a){this.distance=a;this._apply()},_setHeading:function(a){this.rotation.z=a;this._apply();
this.sceneView.requestDraw();if(null!=this.sceneView.onHeadingChangeCallback)this.sceneView.onHeadingChangeCallback()},_setPitch:function(a){this.rotation.x=a;this._apply();this.sceneView.requestDraw();if(null!=this.sceneView.onPitchChangeCallback)this.sceneView.onPitchChangeCallback()},_getHeading:function(){return this.rotation.z},_getPitch:function(){return this.rotation.x}}),C=k.extend({init:function(a,c){k.prototype.init.apply(this,arguments);this.sceneView=a;this.camera=c;this.distance=20;this.maxDistance=
2*this.distance;this.minDistance=this.distance/4;this.rotation=new THREE.Euler;this.rotation.order="ZXY";this.rotation.z=.25*Math.PI;var b=this,d=new w;d.callback=function(a,c,d){0==d.state?(log("stop animation..."),b.sceneView.startAnimation(null),b.initPitch=b._getPitch(),b.initHeading=b._getHeading(),b.sceneView._userControllBegin()):(d=b._getAngleRate(),c=b.initPitch+c/d,b._setHeading(b.initHeading-a/d),b._setPitch(c));b.sceneView.requestDraw();return!0};a.gestureDetectors.push(d);d=new x;d.callback=
function(a,c){b._fly(-a,c)};a.gestureDetectors.push(d);d=new y;d.callback=function(a,c){c?b.initDistance=b._getDistance():b._setDistance(b.initDistance/a)};a.gestureDetectors.push(d)},_getAngleRate:function(){return 64*this.maxDistance/this.distance},_updateDefaultDistance:function(a){this.distance=1.6*a;this.maxDistance=2*this.distance;this.minDistance=this.distance/4;this._apply()},_getDistance:function(){return this.distance},_setDistance:function(a){var c=0;this.distance=c=a<this.minDistance?
this.minDistance:a>this.maxDistance?this.maxDistance:a;this._apply()},_calculate:function(){var a=this;$.each(a.sceneView.subViews,function(c,b){var d=new THREE.Raycaster,e=new THREE.Vector2;e.x=b.translateX/window.innerWidth*2-1;e.y=2*-(b.translateY/window.innerHeight)+1;d.setFromCamera(e,a.camera);if(0<a.sceneView.scene.children.length){for(var e=[],f=0;f<a.sceneView.scene.children.length;f++)if(0==f){if(a.sceneView.scene.children[f].children)for(var g=0;g<a.sceneView.scene.children[f].children.length;g++)e.push(a.sceneView.scene.children[f].children[g].children[0])}else e.push(a.sceneView.scene.children[f]);
d=d.intersectObjects(e);0>=d.length||(d[0].object==b.cube?b.visible||b.setVisible("true"):b.visible&&b.setVisible("false"))}})},_fly:function(a,c){var b=this._getAngleRate(),d=this,e=Math.abs(a)/5E-4,f=-(2.5E-4*e*e*(0<a?1:-1))/b,g=Math.abs(c)/5E-4,h=2.5E-4*g*g*(0<c?1:-1)/b,b=new z(2),e=e>g?e:g,g=this._getPitch(),h=g+h;h>Math.PI?h=Math.PI:0>h&&(h=0);var l=new A(this);l.fromHeading=this._getHeading();l.toHeading=l.fromHeading-f;l.fromPitch=g;l.toPitch=h;l.duration=e;l.timeInterplator=b;l.callback=function(){d.sceneView._userControllEnd()};
this.sceneView.startAnimation(l)},_apply:function(){var a=this.sceneView.lookatLocation;null==a&&(a=new THREE.Vector3(0,0,0));var c=this._culCameraPosition(a);this.camera.position.x=c.x;this.camera.position.y=c.y;this.camera.position.z=c.z;if(null!=this.sceneView.lookatLocation){a=new THREE.Matrix4;a.lookAt(c,this.sceneView.lookatLocation,new THREE.Vector3(0,0,1));if(null!=this.sceneView.lookAnchor){var b=this.sceneView.frame.height/2/Math.tan(this.sceneView.fov*Math.PI/360),c=Math.atan((this.sceneView.frame.height*
this.sceneView.lookAnchor.y-this.sceneView.frame.height/2)/b),b=Math.atan((this.sceneView.frame.width*this.sceneView.lookAnchor.x-this.sceneView.frame.width/2)/b);a.multiply((new THREE.Matrix4).makeRotationX(c));a.multiply((new THREE.Matrix4).makeRotationY(b))}this.camera.rotation.setFromRotationMatrix(a)}else this.camera.rotation.z=Math.PI+this.rotation.z,this.camera.rotation.x=Math.PI-this.rotation.x},_culCameraPosition:function(a){var c=new THREE.Vector3(0,0,-1*this.distance);c.applyEuler(this.rotation);
c.x+=a.x;c.y+=a.y;c.z+=a.z;return c},_setHeading:function(a){this.rotation.z=a;this._apply();this.sceneView.requestDraw();if(null!=this.sceneView.onHeadingChangeCallback)this.sceneView.onHeadingChangeCallback()},_setPitch:function(a){var c=.99*Math.PI,b=.01*Math.PI;a>=c&&(a=c);a<=b&&(a=b);this.rotation.x=a;this._apply();this.sceneView.requestDraw();if(null!=this.sceneView.onPitchChangeCallback)this.sceneView.onPitchChangeCallback()},_getHeading:function(){return this.rotation.z},_getPitch:function(){return this.rotation.x}}),
n=k.extend({init:function(a){this.modelSrc=a},getObjUrl:function(a,c,b,d){},getMtlUrl:function(a,c,b,d){},getIndexUrl:function(a){}}),F=n.extend({init:function(){n.prototype.init.apply(this,arguments);this.modelName=this._getModelNameFromUrl();this.version=0},getObjUrl:function(a,c,b,d){return this.modelSrc+"/"+a+"/"+c+"_"+b+"_"+d+"/"+this.modelName+a+"_"+c+"_"+b+"_"+d+".obj"},getMtlUrl:function(a,c,b,d){return this.modelSrc+"/"+a+"/"+c+"_"+b+"_"+d+"/"+this.modelName+a+"_"+c+"_"+b+"_"+d+".mtl"},getIndexUrl:function(a){return this.modelSrc+
"/"+a+"/index.json"},_getModelNameFromUrl:function(){var a=this.modelSrc.lastIndexOf("/");return this.modelSrc.substring(a+1)}}),G=n.extend({init:function(){n.prototype.init.apply(this,arguments);this.version=1},getObjUrl:function(a,c,b,d){return this.modelSrc+"/"+a+"_"+c+"_"+b+"_"+d+".obj"},getMtlUrl:function(a,c,b,d){return this.modelSrc+"/"+a+"_"+c+"_"+b+"_"+d+".mtl"},getIndexUrl:function(a){return this.modelSrc+"/"+a+".index"}}),H=n.extend({init:function(){n.prototype.init.apply(this,arguments);
this.version=2},getObjUrl:function(a,c,b,d){return this.modelSrc+"/"+a+"/"+c+"_"+b+"_"+d+".obj.drc"},getMtlUrl:function(a,c,b,d){return this.modelSrc+"/"+a+"/"+c+"_"+b+"_"+d+".mtl"},getIndexUrl:function(a){return this.modelSrc+"/"+a+"/index.json"}}),I=n.extend({init:function(){n.prototype.init.apply(this,arguments);this.version=3},getObjUrl:function(a,c,b,d,e){return this.modelSrc+"/"+a+"/"+e+".o"},getMtlUrl:function(a,c,b,d,e){return this.modelSrc+"/"+a+"/"+e+".m"},getIndexUrl:function(a){return this.modelSrc+
"/"+a+"/index"}});k.extend("com.vizengine.view.ModelSparse",{init:function(){this.rootObject=new THREE.Object3D;this.boxiesIndex={};this.boxies=[];this.modelSrc=null;this.isInSide=!1;this.modelId=this.formatVersion=this.formatProvider=this.bound=null;this._splitRate=.6;this.bound=new t},setModelSrc:function(a,c){this.clear();this.modelSrc=a;var b=this;this._loadMeta(function(){if(b.isInSide){var a=b.bound.getCenter(),e=new THREE.Matrix4;e.makeTranslation(-a.x,-a.y,-a.z);a=new THREE.Matrix4;a.makeRotationX(-.8*
Math.PI/2);var f=new THREE.Matrix4;f.multiply(a);f.multiply(e);b.rootObject.applyMatrix(f)}b.onCameraLocationChanged();c&&c.call(b)})},_loadMeta:function(a){var c=this;loadResource(this.modelSrc+"/meta.json",function(b){b=JSON.parse(b);var d=null!=b.version?b.version:0;switch(d){case 0:c.formatProvider=new F(c.modelSrc);break;case 1:c.formatProvider=new G(c.modelSrc);break;case 2:c.formatProvider=new H(c.modelSrc);break;case 3:c.formatProvider=new I(c.modelSrc);break;default:alert("\u4e0d\u652f\u6301\u5f53\u524d\u6570\u636e\u683c\u5f0f\uff0c\u8bf7\u68c0\u67e5\u5f15\u64ce\u662f\u5426\u4e3a\u6700\u65b0\u7248\u672c!!");
return}c.formatVersion=d;null!=b.id&&(c.modelId=b.id);var e=new THREE.Vector3(b.bound[0],b.bound[1],b.bound[2]),f=new THREE.Vector3(b.bound[3],b.bound[4],b.bound[5]),g=b.levelnum;-1!=c.model3dView.levelCount&&c.model3dView.levelCount<g&&(g=c.model3dView.levelCount);c.bound.min=e;c.bound.max=f;3<=c.formatVersion?c._loadKey(function(){c._loadIndex(function(){a()},g,e,f)}):c._loadIndex(function(){a()},g,e,f)})},_loadKey:function(a){var c=this,b=["appId=test001","appSecret=secret_test001"];b[2]="id="+
this.modelId;b[3]="timestamp=1490175427373";b.sort();var d=b.join("&"),d=com.vizengine.Global.md5(d);b.splice(1,1);var b=b.join("&"),e="http://vbr3d.visualbusiness.cn/vbr3d-model-http-api/model/secret?"+b+"&signature="+d;0<=this.modelSrc.indexOf("http://test-")&&(e="http://test-vbr3d.visualbusiness.cn/vbr3d-model-http-api/model/secret?"+b+"&signature="+d);u(e,function(b){b=v(b,"secret_test001");b=JSON.parse(b);if(0!=parseInt(b.code))alert("\u65e0\u6cd5\u89e3\u5bc6\u6587\u4ef6,\u539f\u56e0:"+b.msg);
else{b=com.vizengine.Global.base64Decode(b.data);var d=parseInt(b.substring(0,2),16),e=parseInt(b.substring(2,4),16);c.key=b.substring(d+4,b.length-e);a()}},"POST")},_loadIndexData:function(a,c){var b=this,d=this.formatProvider.getIndexUrl(a);3>this.formatProvider.version?loadResource(d,function(a){c(a)}):u(d,function(a){a=v(a,b.key);c(a)})},_loadIndex:function(a,c,b,d){var e=0,f=this,g=function(){if(e>=c)a();else{var h=e;f._loadIndexData(e,function(a){0==h&&log(a);a=JSON.parse(a);for(var c in a){var e=
c.split("_"),k=h,m=0,n=0,p=0;3<e.length?(m=parseInt(e[1]),n=parseInt(e[2]),p=parseInt(e[3])):(m=parseInt(e[0]),n=parseInt(e[1]),p=parseInt(e[2]));var r=e=Math.pow(2,0==k?1:k),t=e,q=new E;q.key=f.key;q.modelView=f;q.index.level=k;q.index.x=m;q.index.y=n;q.index.z=p;"string"==typeof a[c]&&(q.fileId=a[c].split(",")[0]);q.bound.min=new THREE.Vector3(b.x+(d.x-b.x)*m/e,b.y+(d.y-b.y)*n/r,b.z+(d.z-b.z)*p/t);q.bound.max=new THREE.Vector3(b.x+(d.x-b.x)*(m+1)/e,b.y+(d.y-b.y)*(n+1)/r,b.z+(d.z-b.z)*(p+1)/t);f.boxies.push(q);
f.boxiesIndex[q.getIndexPath()]=q}g()});e++}};g()},onCameraLocationChanged:function(){this._updateBoxies()},_updateBoxies:function(){var a=null,c=0;a:for(;2>c;c++)for(var b=0;2>b;b++)for(var d=0;2>d;d++){var e=this.boxiesIndex["0/"+c+"_"+b+"_"+d];if(null!=e){a=e;break a}}var f={},g=this;a.walkBrotherIndex(function(a){g._updateBox(g.boxiesIndex[a.getPath()],f);return!0});this._loadBoxies(f)},_loadBoxies:function(a){if(null!=this.loadingBoxies)for(var c in this.loadingBoxies)null==a[c]&&this._removeBox(this.loadingBoxies[c]);
this.loadingBoxies=a;var b=this;this.loadingArray=[];for(c in this.loadingBoxies)this.loadingArray.push(this.loadingBoxies[c]);this.loadingArray.sort(function(a,c){return a.bound.getCenter().distanceTo(b.camera.position)-c.bound.getCenter().distanceTo(b.camera.position)});for(c=0;c<this.loadingArray.length;c++)if(a=this.loadingArray[c],!(0<a.loadState)){a.load(function(){""!=b.modelSrc&&(b.rootObject.add(this.object),b.onCameraLocationChanged(),b.model3dView.requestDraw())});break}},_updateBox:function(a,
c){if(null!=a){var b=a.bound.getCenter().distanceTo(this.camera.position);if(a.bound.getRadius()/b/(2*Math.tan(this.fov*Math.PI/360))>this._splitRate){var d=this,e=!1;a.walkChildrenIndex(function(a){e=!0;d._updateBox(d.boxiesIndex[a.getPath()],c);return!0});e?this._removeBox(a):c[a.index.getPath()]=a;d=null}else c[a.index.getPath()]=a}},_removeBox:function(a){null!=a.object&&(this.rootObject.remove(a.object),this._releaseObject3d(a.object),this.boxiesIndex[a.index.getPath()].reset())},_releaseObject3d:function(a){null!=
a.material&&(null!=a.material.map&&a.material.map.dispose(),a.material.dispose());null!=a.geometry&&a.geometry.dispose();for(var c=0;c<a.children.length;c++)this._releaseObject3d(a.children[c])},clear:function(){for(var a=0;a<this.boxies.length;a++)this._removeBox(this.boxies[a]);this.boxies.length=0;this.modelSrc=""}});var D=com.vizengine.view.ModelSparse,J=0;m.extend("com.vizengine.view.Model3DView",{init:function(){m.prototype.init.apply(this,arguments);this.firstLoad=!0;this.isInSide=!1;this.levelCount=
-1;this.onModelLoadedCallback=null;this.bound=new t;this.lookatLocation=null;this.boxies=[];this.baseUrl="http://cdn.visualbusiness.cn/3d/m/";this.modelId=this.modelSrc=this.formatProvider=null;this.mid="model"+J++;this.boxiesIndex=new k;this._backgroundColor=this._gestureController=null;this.debugEnable=this.loading=this._dirty=!1;this.autoplayLoopTime=11E4;this._splitRate=.6;this.onModelStilledCallback=this.onPitchChangeCallback=this.onHeadingChangeCallback=null;this.userControlling=!1;this.defaultDistanceRate=
.5;this.lookAnchor={x:.5,y:.5};this.setViewMode(!1);this.sparses=[]},_userControllBegin:function(){this.userControlling=!0},setLevelCount:function(a){this.levelCount=a},_userControllEnd:function(){this.userControlling=!1;this.lastControlEndTime=(new Date).getTime();if(null!=this.onModelStilledCallback)this.onModelStilledCallback();if(null!=this.autoplayAnimation){var a=this;setTimeout(function(){4900>(new Date).getTime()-a.lastControlEndTime||a.setAutoplayEnable(a.autoplayEnable)},5E3)}this.onCameraLocationChanged()},
setBackgroundColor:function(a){this._backgroundColor=a;this.renderer.setClearColor(a,1)},requestDraw:function(){if(!this._dirty){this._dirty=!0;var a=this;setTimeout(function(){a._dirty=!1;a.onDraw();a=null},0)}},startAnimation:function(){var a=m.prototype.startAnimation.apply(this,arguments);log("ID:"+this.mid+" start Animation:"+arguments[0]);return a},_createNativeView:function(){var a=m.prototype._createNativeView.apply(this,arguments),c=document.createElement("div");c.style.position="absolute";
var b=new THREE.WebGLRenderer;b.setPixelRatio(window.devicePixelRatio);b.setClearColor(16777215,1);this.scene=new THREE.Scene;this.rootObject=new THREE.Object3D;this.scene.add(this.rootObject);this.fov=45;this.camera=new THREE.PerspectiveCamera(this.fov,window.innerWidth/window.innerHeight,.01,1E3);this.camera.position.x=0;this.camera.position.y=0;this.camera.position.z=0;this.camera.rotation.order="ZXY";this.scene.add(this.camera);this.renderer=b;this.backgroundTexture=b=new THREE.Texture;b=new THREE.Mesh(new THREE.PlaneGeometry(2,
2,0),new THREE.MeshBasicMaterial({map:b}));b.material.depthTest=!1;b.material.depthWrite=!1;var d=new THREE.Scene,e=new THREE.Camera;d.add(e);d.add(b);this.backgroundScene=d;this.backgroundCamera=e;b=new THREE.DirectionalLight(4210752);b.position.set(1,0,1).normalize();this.scene.add(b);b=new THREE.AmbientLight(16777215);this.scene.add(b);c.appendChild(this.renderer.domElement);a.div=c;return a},setBackgroundTexture:function(a){var c=this,b=new THREE.TextureLoader;b.crossOrigin="*";b.load(a,function(a){c.backgroundTexture.image=
a.image;c.backgroundTexture.needsUpdate=!0},function(a){console.log(a.loaded/a.total*100+"% loaded")},function(a){console.log("An error happened")})},dispatchLayout:function(){m.prototype.dispatchLayout.apply(this,arguments);this.camera.aspect=this.frame.width/this.frame.height;this.camera.updateProjectionMatrix();this.renderer.setSize(this.frame.width,this.frame.height);this.renderer.setViewport(0,0,this.frame.width,this.frame.height);this._gestureController._apply();this.requestDraw()},setViewMode:function(a){this.isInSide=
m.parseBoolean(a);this.gestureDetectors.length=0;this._gestureController=this.isInSide?new B(this,this.camera):new C(this,this.camera)},getViewMode:function(){return this.isInSide},setHeading:function(a,c){null==c&&(c=!0);this.heading=a;a=parseFloat(a);a=a/180*-1*Math.PI;this._gestureController._setHeading(a);c&&this.autoplayEnable&&this.setAutoplayEnable(!0)},setPitch:function(a){this.pitch=a;a=-parseFloat(a);a=Math.PI*(90-a)/180;this._gestureController._setPitch(a)},getHeading:function(){return-180*
this._gestureController._getHeading()/Math.PI},getPitch:function(){return 180*this._gestureController._getPitch()/Math.PI-90},setDebugEnable:function(a){this.debugEnable=m.parseBoolean(a)},onDraw:function(){this._updateOutAnnotations();this.renderer.autoClear=!1;this.renderer.clear(!0);null==this._backgroundColor&&this.renderer.render(this.backgroundScene,this.backgroundCamera);this.renderer.render(this.scene,this.camera)},_updateInAnnotations:function(){for(var a in this.subViews){var c=this.subViews[a],
b=new THREE.Vector3(c.locationX,c.locationY,c.locationZ);b.applyMatrix4(this.camera.matrixWorldInverse);c.setVisible(0>b.z);b.applyMatrix4(this.camera.projectionMatrix);var d=this.frame.height/2-b.y*this.frame.height/2;c.setTranslateX(b.x*this.frame.width/2+this.frame.width/2-c.panoAnchorX*c.frame.width);c.setTranslateY(d-c.panoAnchorY*c.frame.height);c.setAnchorX(c.panoAnchorX);c.setAnchorY(c.panoAnchorY)}},_updateOutAnnotations:function(){for(var a in this.subViews){var c=this.subViews[a],b=new THREE.Vector3(c.locationX,
c.locationY,c.locationZ);b.applyMatrix4(this.camera.matrixWorldInverse);b.applyMatrix4(this.camera.projectionMatrix);var d=this.frame.height/2-b.y*this.frame.height/2;c.setTranslateX(b.x*this.frame.width/2+this.frame.width/2-c.anchorX*c.frame.width);c.setTranslateY(d-c.anchorY*c.frame.height)}},setCenter:function(a){this.center=a;this.isInSide||this._gestureController._apply()},setLookatLocation:function(a){this.lookatLocation=a;this._gestureController._apply();this.requestDraw()},setLookAnchor:function(a){this.lookAnchor=
a;this._gestureController._apply();this.requestDraw()},setDefaultDistanceRate:function(a){this.defaultDistanceRate=a;null!=this.bound&&(a=this.bound.min.distanceTo(this.bound.max),a*=this.defaultDistanceRate,null!=this._gestureController&&this._gestureController._updateDefaultDistance(a))},raycast:function(a,c){var b=new THREE.Raycaster,d=new THREE.Vector2;d.x=a/window.innerWidth*2-1;d.y=2*-(c/window.innerHeight)+1;b.setFromCamera(d,this.camera);if(0<this.scene.children.length){for(var d=[],e=0;e<
this.boxies.length;e++){var f=this.boxies[e].object;null!=f&&d.push(f)}b=b.intersectObjects(d,!0);return 0>=b.length?null:b[0].point}return null},setAutoplayLoopTime:function(a){this.autoplayLoopTime=m.parseFloat(a);this.setAutoplayEnable(this.autoplayEnable)},setAutoplayEnable:function(a){(this.autoplayEnable=m.parseBoolean(a))?(this.autoplayAnimation=new p,this.autoplayAnimation.duration=this.autoplayLoopTime,this.autoplayAnimation.startHeading=this.getHeading(),this.autoplayAnimation.repeatCount=
0,this.autoplayAnimation.animateFrame=function(a,b){a.setHeading(this.startHeading-360*b,!1)},this.userControlling||this.startAnimation(this.autoplayAnimation)):this.animation==this.autoplayAnimation&&(this.startAnimation(null),this.autoplayAnimation=null)},_loadMeta:function(a){var c=this;loadResource(this.modelSrc+"/meta.json",function(b){if(b=JSON.parse(b))if(b.sparse)for(var d in b.sparse)c._createSparse(d,function(){c.onCameraLocationChanged()});else d=new D,d.model3dView=c,d.camera=c.camera,
c.sparses.push(d),c.rootObject.add(d.rootObject),d.setModelSrc(c.modelSrc,function(){c.onCameraLocationChanged()});d=new THREE.Vector3(b.bound[0],b.bound[1],b.bound[2]);var e=new THREE.Vector3(b.bound[3],b.bound[4],b.bound[5]);c.bound.min=d;c.bound.max=e;c.setDefaultDistanceRate(.6);c.lookAnchor=null!=b.pose&&null!=b.pose.lookAnchor?b.pose.lookAnchor:{x:.5,y:.5};c.lookatLocation=null!=b.pose&&null!=b.pose.lookatLocation?b.pose.lookatLocation:c.bound.getCenter();c.rootObject.matrixAutoUpdate=!1;c.rootObject.matrix=
new THREE.Matrix4;null!=b.pose&&null!=b.pose.matrix&&(c.rootObject.matrix.elements=b.pose.matrix);if(c.isInSide){b=null!=c.heading?c.heading:0;var f=null!=c.pitch?c.pitch:0;c._gestureController||(c._gestureController=new B(c,c.camera))}else b=null!=c.heading?c.heading:0,f=null!=c.pitch?c.pitch:0,d=d.distanceTo(e),null!=c.defaultDistanceRate&&(d*=c.defaultDistanceRate),c._gestureController||(c._gestureController=new C(c,c.camera)),c._gestureController._updateDefaultDistance(d),c.camera.position.set(c.bound.getCenter().x,
c.bound.getCenter.y,c.bound.getCenter().z);c.setHeading(b);c.setPitch(f);a&&a.call(c)})},_createSparse:function(a,c){var b=new D;b.model3dView=this;b.camera=this.camera;this.sparses.push(b);this.rootObject.add(b.rootObject);b.setModelSrc(this.modelSrc+"/"+a,c)},setModelSrc:function(a,c){this.clear();this.modelSrc=a;this._loadMeta(c)},clear:function(){for(var a=0;a<this.sparses.length;a++)this.sparses[a].clear();this.sparses.length=0},setModelId:function(a){this.setModelSrc(this.baseUrl+a)},setBaseUrl:function(a){this.baseUrl=
a},getBaseUrl:function(){return this.baseUrl},onCameraLocationChanged:function(){for(var a=0;a<this.sparses.length;a++)this.sparses[a].onCameraLocationChanged()}})});
