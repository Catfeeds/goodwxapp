THREE.RenderableObject=function(){this.id=0;this.object=null;this.renderOrder=this.z=0};
THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.normalModel=new THREE.Vector3;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsLength=0;this.color=new THREE.Color;this.material=null;this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2];this.renderOrder=this.z=0};
THREE.RenderableVertex=function(){this.position=new THREE.Vector3;this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=!0};THREE.RenderableVertex.prototype.copy=function(F){this.positionWorld.copy(F.positionWorld);this.positionScreen.copy(F.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.renderOrder=this.z=0};
THREE.RenderableSprite=function(){this.id=0;this.object=null;this.rotation=this.z=this.y=this.x=0;this.scale=new THREE.Vector2;this.material=null;this.renderOrder=0};
THREE.Projector=function(){function F(){if(K===V){var b=new THREE.RenderableVertex;y.push(b);V++;K++;return b}return y[K++]}function W(){if(O===X){var b=new THREE.RenderableFace;Y.push(b);X++;O++;return b}return Y[O++]}function Z(){if(P===aa){var b=new THREE.RenderableLine;ba.push(b);aa++;P++;return b}return ba[P++]}function ja(){if(Q===ca){var b=new THREE.RenderableSprite;da.push(b);ca++;Q++;return b}return da[Q++]}function ea(b,l){return b.renderOrder!==l.renderOrder?b.renderOrder-l.renderOrder:
b.z!==l.z?l.z-b.z:b.id!==l.id?b.id-l.id:0}function ka(b,l){var d=0,k=1,c=b.z+b.w,e=l.z+l.w,g=-b.z+b.w,f=-l.z+l.w;if(0<=c&&0<=e&&0<=g&&0<=f)return!0;if(0>c&&0>e||0>g&&0>f)return!1;0>c?d=Math.max(d,c/(c-e)):0>e&&(k=Math.min(k,c/(c-e)));0>g?d=Math.max(d,g/(g-f)):0>f&&(k=Math.min(k,g/(g-f)));if(k<d)return!1;b.lerp(l,d);l.lerp(b,1-k);return!0}var C,R,fa=[],ga=0,L,K,y=[],V=0,d,O,Y=[],X=0,k,P,ba=[],aa=0,q,Q,da=[],ca=0,t={objects:[],lights:[],elements:[]},v=new THREE.Vector3,p=new THREE.Vector4,la=new THREE.Box3(new THREE.Vector3(-1,
-1,-1),new THREE.Vector3(1,1,1)),ma=new THREE.Box3,B=Array(3),ha=new THREE.Matrix4,G=new THREE.Matrix4,D,S=new THREE.Matrix4,T=new THREE.Matrix3,ia=new THREE.Frustum,H=new THREE.Vector4,I=new THREE.Vector4;this.projectVector=function(b,d){console.warn("THREE.Projector: .projectVector() is now vector.project().");b.project(d)};this.unprojectVector=function(b,d){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");b.unproject(d)};this.pickingRay=function(b,d){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};
var w=new function(){function b(a){var h=a.positionWorld,b=a.positionScreen;h.copy(a.position).applyMatrix4(D);b.copy(h).applyMatrix4(G);h=1/b.w;b.x*=h;b.y*=h;b.z*=h;a.visible=-1<=b.x&&1>=b.x&&-1<=b.y&&1>=b.y&&-1<=b.z&&1>=b.z}function l(a,b,c){if(!0===a.visible||!0===b.visible||!0===c.visible)return!0;B[0]=a.positionScreen;B[1]=b.positionScreen;B[2]=c.positionScreen;return la.intersectsBox(ma.setFromPoints(B))}function q(a,b,c){return 0>(c.positionScreen.x-a.positionScreen.x)*(b.positionScreen.y-
a.positionScreen.y)-(c.positionScreen.y-a.positionScreen.y)*(b.positionScreen.x-a.positionScreen.x)}var p=[],c=[],e=null,g=null,f=new THREE.Matrix3;return{setObject:function(a){e=a;g=e.material;f.getNormalMatrix(e.matrixWorld);p.length=0;c.length=0},projectVertex:b,checkTriangleVisibility:l,checkBackfaceCulling:q,pushVertex:function(a,c,d){L=F();L.position.set(a,c,d);b(L)},pushNormal:function(a,b,c){p.push(a,b,c)},pushUv:function(a,b){c.push(a,b)},pushLine:function(a,b){var c=y[a],d=y[b];k=Z();k.id=
e.id;k.v1.copy(c);k.v2.copy(d);k.z=(c.positionScreen.z+d.positionScreen.z)/2;k.renderOrder=e.renderOrder;k.material=e.material;t.elements.push(k)},pushTriangle:function(a,b,k){var m=y[a],n=y[b],r=y[k];if(!1!==l(m,n,r)&&(g.side===THREE.DoubleSide||!0===q(m,n,r))){d=W();d.id=e.id;d.v1.copy(m);d.v2.copy(n);d.v3.copy(r);d.z=(m.positionScreen.z+n.positionScreen.z+r.positionScreen.z)/3;d.renderOrder=e.renderOrder;d.normalModel.fromArray(p,3*a);d.normalModel.applyMatrix3(f).normalize();for(m=0;3>m;m++)n=
d.vertexNormalsModel[m],n.fromArray(p,3*arguments[m]),n.applyMatrix3(f).normalize(),d.uvs[m].fromArray(c,2*arguments[m]);d.vertexNormalsLength=3;d.material=e.material;t.elements.push(d)}}}};this.projectScene=function(b,l,B,L){Q=P=O=0;t.elements.length=0;!0===b.autoUpdate&&b.updateMatrixWorld();null===l.parent&&l.updateMatrixWorld();ha.copy(l.matrixWorldInverse.getInverse(l.matrixWorld));G.multiplyMatrices(l.projectionMatrix,ha);ia.setFromMatrix(G);R=0;t.objects.length=0;t.lights.length=0;b.traverseVisible(function(a){if(a instanceof
THREE.Light)t.lights.push(a);else if((a instanceof THREE.Mesh||a instanceof THREE.Line||a instanceof THREE.Sprite)&&!1!==a.material.visible&&(!1===a.frustumCulled||!0===ia.intersectsObject(a))){if(R===ga){var b=new THREE.RenderableObject;fa.push(b);ga++;R++;C=b}else C=fa[R++];C.id=a.id;C.object=a;v.setFromMatrixPosition(a.matrixWorld);v.applyMatrix4(G);C.z=v.z;C.renderOrder=a.renderOrder;t.objects.push(C)}});!0===B&&t.objects.sort(ea);b=0;for(B=t.objects.length;b<B;b++){var c=t.objects[b].object,
e=c.geometry;w.setObject(c);D=c.matrixWorld;K=0;if(c instanceof THREE.Mesh)if(e instanceof THREE.BufferGeometry){var g=e.attributes,c=e.groups;if(void 0!==g.position){for(var f=g.position.array,a=0,h=f.length;a<h;a+=3)w.pushVertex(f[a],f[a+1],f[a+2]);if(void 0!==g.normal)for(var J=g.normal.array,a=0,h=J.length;a<h;a+=3)w.pushNormal(J[a],J[a+1],J[a+2]);if(void 0!==g.uv)for(g=g.uv.array,a=0,h=g.length;a<h;a+=2)w.pushUv(g[a],g[a+1]);if(null!==e.index)if(f=e.index.array,0<c.length)for(b=0;b<c.length;b++)for(h=
c[b],a=h.start,h=h.start+h.count;a<h;a+=3)w.pushTriangle(f[a],f[a+1],f[a+2]);else for(a=0,h=f.length;a<h;a+=3)w.pushTriangle(f[a],f[a+1],f[a+2]);else for(a=0,h=f.length/3;a<h;a+=3)w.pushTriangle(a,a+1,a+2)}}else{if(e instanceof THREE.Geometry){var m=e.vertices,a=e.faces,h=e.faceVertexUvs[0];T.getNormalMatrix(D);for(var f=c.material,g=f instanceof THREE.MultiMaterial,J=!0===g?c.material:null,n=0,r=m.length;n<r;n++){var z=m[n];v.copy(z);if(!0===f.morphTargets)for(var E=e.morphTargets,x=c.morphTargetInfluences,
u=0,M=E.length;u<M;u++){var A=x[u];if(0!==A){var N=E[u].vertices[n];v.x+=(N.x-z.x)*A;v.y+=(N.y-z.y)*A;v.z+=(N.z-z.z)*A}}w.pushVertex(v.x,v.y,v.z)}m=0;for(n=a.length;m<n;m++)if(r=a[m],f=!0===g?J.materials[r.materialIndex]:c.material,void 0!==f&&(x=f.side,e=y[r.a],z=y[r.b],E=y[r.c],!1!==w.checkTriangleVisibility(e,z,E))){u=w.checkBackfaceCulling(e,z,E);if(x!==THREE.DoubleSide){if(x===THREE.FrontSide&&!1===u)continue;if(x===THREE.BackSide&&!0===u)continue}d=W();d.id=c.id;d.v1.copy(e);d.v2.copy(z);d.v3.copy(E);
d.normalModel.copy(r.normal);!1!==u||x!==THREE.BackSide&&x!==THREE.DoubleSide||d.normalModel.negate();d.normalModel.applyMatrix3(T).normalize();M=r.vertexNormals;A=0;for(N=Math.min(M.length,3);A<N;A++){var U=d.vertexNormalsModel[A];U.copy(M[A]);!1!==u||x!==THREE.BackSide&&x!==THREE.DoubleSide||U.negate();U.applyMatrix3(T).normalize()}d.vertexNormalsLength=M.length;x=h[m];if(void 0!==x)for(u=0;3>u;u++)d.uvs[u].copy(x[u]);d.color=r.color;d.material=f;d.z=(e.positionScreen.z+z.positionScreen.z+E.positionScreen.z)/
3;d.renderOrder=c.renderOrder;t.elements.push(d)}}}else if(c instanceof THREE.Line)if(e instanceof THREE.BufferGeometry){if(g=e.attributes,void 0!==g.position){f=g.position.array;a=0;for(h=f.length;a<h;a+=3)w.pushVertex(f[a],f[a+1],f[a+2]);if(null!==e.index)for(f=e.index.array,a=0,h=f.length;a<h;a+=2)w.pushLine(f[a],f[a+1]);else for(g=c instanceof THREE.LineSegments?2:1,a=0,h=f.length/3-1;a<h;a+=g)w.pushLine(a,a+1)}}else{if(e instanceof THREE.Geometry&&(S.multiplyMatrices(G,D),m=c.geometry.vertices,
0!==m.length))for(e=F(),e.positionScreen.copy(m[0]).applyMatrix4(S),g=c instanceof THREE.LineSegments?2:1,n=1,r=m.length;n<r;n++)e=F(),e.positionScreen.copy(m[n]).applyMatrix4(S),0<(n+1)%g||(z=y[K-2],H.copy(e.positionScreen),I.copy(z.positionScreen),!0===ka(H,I)&&(H.multiplyScalar(1/H.w),I.multiplyScalar(1/I.w),k=Z(),k.id=c.id,k.v1.positionScreen.copy(H),k.v2.positionScreen.copy(I),k.z=Math.max(H.z,I.z),k.renderOrder=c.renderOrder,k.material=c.material,c.material.vertexColors===THREE.VertexColors&&
(k.vertexColors[0].copy(c.geometry.colors[n]),k.vertexColors[1].copy(c.geometry.colors[n-1])),t.elements.push(k)))}else c instanceof THREE.Sprite&&(p.set(D.elements[12],D.elements[13],D.elements[14],1),p.applyMatrix4(G),a=1/p.w,p.z*=a,-1<=p.z&&1>=p.z&&(q=ja(),q.id=c.id,q.x=p.x*a,q.y=p.y*a,q.z=p.z,q.renderOrder=c.renderOrder,q.object=c,q.rotation=c.rotation,q.scale.x=c.scale.x*Math.abs(q.x-(p.x+l.projectionMatrix.elements[0])/(p.w+l.projectionMatrix.elements[12])),q.scale.y=c.scale.y*Math.abs(q.y-
(p.y+l.projectionMatrix.elements[5])/(p.w+l.projectionMatrix.elements[13])),q.material=c.material,t.elements.push(q)))}!0===L&&t.elements.sort(ea);return t}};
